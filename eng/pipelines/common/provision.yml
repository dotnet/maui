parameters:
  # Xcode
  skipXcode: false
  skipSimulatorSetup: true
  # .NET NuGet caches
  clearCaches: true
  # Android - JDK
  skipJdk: false
  # Android - SDK Packages
  skipAndroidCommonSdks: false
  onlyAndroidPlatformDefaultApis: false
  skipAndroidPlatformApis: false
  # Android - Emulators
  androidEmulatorApiLevel: ''
  skipAndroidEmulatorImages: true # For most builds we won't need these
  skipAndroidCreateAvds: true # For most builds we won't need these
  # Provisionator / Xcode
  skipProvisionator: true
  checkoutDirectory: $(System.DefaultWorkingDirectory)
  provisionatorXCodePath: $(provisionator.xcode)
  provisionatorChannel: 'latest'
  provisionatorExtraArguments: $(provisionator.extraArguments)
  provisionatorUri: $(provisionator-uri)
  gitHubToken: $(provisionator--github--pat)
  certPass: $(maui-cert-password) # This lives on MAUI variable group
  certName: 'MauiCert.p12'
  openSslArgs: '-legacy'
  provisioningProfileName: 'MauiProvisioningProfile.mobileprovision'
  # Enabling internal runtimes / feeds
  federatedServiceConnection: 'dotnetbuilds-internal-read'
  outputVariableName: 'dotnetbuilds-internal-container-read-token'
  expiryInHours: 1
  base64Encode: false
  skipInternalFeeds: true
  skipCertificates: false

steps:

##################################################
#               Provisioning Feeds               #
##################################################

- ${{ if ne(parameters.skipInternalFeeds, 'true') }}:
  - template: ../../common/templates-official/steps/enable-internal-sources.yml
    parameters:
      legacyCredential: $(dn-bot-dnceng-artifact-feeds-rw)

  - template: ../../common/templates-official/steps/enable-internal-runtimes.yml
    parameters:
      federatedServiceConnection: ${{ parameters.federatedServiceConnection }}
      outputVariableName: ${{ parameters.outputVariableName }}
      expiryInHours: ${{ parameters.expiryInHours }}
      base64Encode: ${{ parameters.base64Encode }}

##################################################
#               Provisioning macOS               #
##################################################

#check if the _tool directory exists and remove it
- pwsh: |
    $dotnetToolsPath = "$(Agent.ToolsDirectory)/dotnet"
    Write-Host "Agent-Cleanser: Agent tools path for .NET installations: ${dotnetToolsPath}"
    try {
      if ([IO.Directory]::Exists($dotnetToolsPath)) {
        Write-Host "Agent-Cleanser: Deleting: ${dotnetToolsPath}"
        [IO.Directory]::Delete($dotnetToolsPath, $true)
      } else {
        Write-Host "Agent-Cleanser: Skipping cleansing of .NET: No .NET installations found under the agent tools directory: $(Agent.ToolsDirectory)"
      }
    } catch {
      Write-Host "ERROR: EXCEPTION: $($_.Exception.Message)"
    }
  displayName: Clean $(Agent.ToolsDirectory)/dotnet directory
  condition: eq(variables['Agent.OS'], 'Darwin')

# Provisioning macOS - Xcode
- ${{ if ne(parameters.skipXcode, 'true') }}:

  - script: |
      echo Remove old Xamarin Settings
      rm -f ~/Library/Preferences/Xamarin/Settings.plist
      rm -f ~/Library/Preferences/maui/Settings.plist
      echo Mac OS version:
      sw_vers -productVersion
      echo
      echo Installed Xcode versions:
      XCODE_LIST=($(ls -1 /Applications | grep '^Xcode_' | sed 's/^Xcode_//;s/.app$//'))
      for v in "${XCODE_LIST[@]}"; do echo "  $v"; done
      echo
      echo currently selected xcode:
      xcrun xcode-select --print-path
      echo
      echo selecting latest xcode...
      # Use REQUIRED_XCODE for devdiv team project or if CollectionUri contains xamarin, XCODE for others (e.g., maui-pr)
      if [[ "$(System.TeamProject)" == "devdiv" || "$(System.CollectionUri)" == *"xamarin"* ]]; then
        XCODE_VERSION=$(REQUIRED_XCODE)
      else
        XCODE_VERSION=$(XCODE)
      fi

      # Check if the specified Xcode version exists, if not try fallbacks
      # Fallback order: exact version -> major.minor -> major
      XCODE_PATH=""
      ORIGINAL_VERSION="$XCODE_VERSION"

      # Build list of versions to try
      VERSIONS_TO_TRY=("$XCODE_VERSION")

      # Add major.minor fallback (e.g., 26.0.1 -> 26.0)
      if [[ "$XCODE_VERSION" =~ ^([0-9]+\.[0-9]+)\.[0-9]+$ ]]; then
        VERSIONS_TO_TRY+=("${BASH_REMATCH[1]}")
      fi

      # Add major fallback (e.g., 26.0.1 or 26.0 -> 26)
      if [[ "$XCODE_VERSION" =~ ^([0-9]+)\. ]]; then
        VERSIONS_TO_TRY+=("${BASH_REMATCH[1]}")
      fi

      echo "Will try Xcode versions in order: ${VERSIONS_TO_TRY[*]}"

      for VERSION in "${VERSIONS_TO_TRY[@]}"; do
        CANDIDATE_PATH="/Applications/Xcode_${VERSION}.app"
        echo "Checking for Xcode ${VERSION} at ${CANDIDATE_PATH}..."
        if [[ -d "$CANDIDATE_PATH" ]]; then
          echo "Found Xcode version ${VERSION} at ${CANDIDATE_PATH}"
          XCODE_VERSION="$VERSION"
          XCODE_PATH="$CANDIDATE_PATH"
          break
        else
          echo "Xcode version ${VERSION} not found"
        fi
      done

      if [[ -z "$XCODE_PATH" ]]; then
        echo "ERROR: No suitable Xcode version found for requested version ${ORIGINAL_VERSION}"
        echo "Tried: ${VERSIONS_TO_TRY[*]}"
        exit 0
      fi

      sudo xcode-select -s "$XCODE_PATH"
      xcrun xcode-select --print-path
      xcodebuild -version
      sudo xcodebuild -license accept

      sudo xcodebuild -runFirstLaunch
    displayName: Select Xcode Version
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))
    timeoutInMinutes: 30

  - ${{ if ne(parameters.skipSimulatorSetup, 'true') }}:
    - script: |
        echo installing simulator runtimes...
        # Use REQUIRED_XCODE for devdiv team project or if CollectionUri contains xamarin, XCODE for others (e.g., maui-pr)
        if [[ "$(System.TeamProject)" == "devdiv" || "$(System.CollectionUri)" == *"xamarin"* ]]; then
          XCODE_VERSION=$(REQUIRED_XCODE)
        else
          XCODE_VERSION=$(XCODE)
        fi
        # if we're using Xcode 26.0[.?], then explicitly install the iOS 26.0 simulator (the iOS 26.0.1 simulator doesn't work for us)
        # also install the universal simulator version, so that this bot can run x64 apps in the simulator.
        if [[ "${XCODE_VERSION}" =~ ^26[.]0.*$ ]]; then
          RC=0
          sudo xcodebuild -downloadPlatform iOS -architectureVariant universal -buildVersion 26.0 || RC=$?
          if [[ "$RC" == "70" ]]; then
            echo "xcodebuild exited with exit code 70, which seems to mean not all is bad? Assuming things will work..."
          elif [[ "$RC" == "0" ]]; then
            echo "Successfully installed the requested iOS simulator"
          else
            echo "Failed to install simulator runtime, deleting all simulator runtimes and trying again..."
            sudo xcrun simctl runtime delete all
            # simulator runtimes are deleted asynchronously, so wait until they're all gone (but max 60 seconds)
            for i in $(seq 1 60); do
              sleep 1
              C=$(xcrun simctl runtime list -j | jq '. | length')
              if [[ $C == 0 ]]; then
                echo "    still $C simulators left..."
                break
              fi
            done
            echo "Re-trying simulator runtime installation, if this doesn't work, a reboot might be required"
            sudo xcodebuild -downloadPlatform iOS -architectureVariant universal -buildVersion 26.0
          fi
        else
          sudo xcodebuild -downloadPlatform iOS
        fi
        
        # Create iPhone Xs simulator with appropriate iOS version (required for UI tests)
        echo ""
        echo "=== Creating iPhone Xs simulator ==="
        
        # For Xcode 26.x, we need iOS 26.x simulator; for others use iOS 18.5
        # Use REQUIRED_XCODE for devdiv team project or if CollectionUri contains xamarin, XCODE for others
        if [[ "$(System.TeamProject)" == "devdiv" || "$(System.CollectionUri)" == *"xamarin"* ]]; then
          XCODE_VERSION=$(REQUIRED_XCODE)
        else
          XCODE_VERSION=$(XCODE)
        fi
        
        if [[ "${XCODE_VERSION}" =~ ^26[.].*$ ]]; then
          echo "Using Xcode 26.x - looking for iOS 26.x runtime"
          # For Xcode 26.x, prefer iOS 26.0 (most compatible), then iOS 26.x
          IOS_RUNTIME=$(xcrun simctl list runtimes -j | jq -r '.runtimes[] | select(.name == "iOS 26.0") | .identifier' | head -1)
          if [[ -z "$IOS_RUNTIME" ]]; then
            IOS_RUNTIME=$(xcrun simctl list runtimes -j | jq -r '.runtimes[] | select(.name | contains("iOS 26")) | .identifier' | head -1)
          fi
        else
          echo "Using Xcode ${XCODE_VERSION} - looking for iOS 18.5 runtime"
          # Find iOS 18.5 runtime (or fallback to iOS 18.x)
          IOS_RUNTIME=$(xcrun simctl list runtimes -j | jq -r '.runtimes[] | select(.name | contains("iOS 18.5")) | .identifier' | head -1)
          if [[ -z "$IOS_RUNTIME" ]]; then
            IOS_RUNTIME=$(xcrun simctl list runtimes -j | jq -r '.runtimes[] | select(.name | contains("iOS 18")) | .identifier' | head -1)
          fi
        fi
        
        if [[ -n "$IOS_RUNTIME" ]]; then
          echo "Found iOS runtime: $IOS_RUNTIME"
          IPHONE_XS_TYPE=$(xcrun simctl list devicetypes -j | jq -r '.devicetypes[] | select(.name == "iPhone Xs") | .identifier' | head -1)
          
          if [[ -n "$IPHONE_XS_TYPE" ]]; then
            # Check if already exists
            EXISTING=$(xcrun simctl list devices -j | jq -r --arg rt "$IOS_RUNTIME" '.devices[$rt][]? | select(.name == "iPhone Xs") | .udid' | head -1)
            if [[ -n "$EXISTING" ]]; then
              echo "iPhone Xs simulator already exists: $EXISTING"
            else
              UDID=$(xcrun simctl create "iPhone Xs" "$IPHONE_XS_TYPE" "$IOS_RUNTIME" 2>&1) && \
                echo "Created iPhone Xs simulator: $UDID" || \
                echo "Note: Could not create iPhone Xs simulator"
            fi
          else
            echo "Note: iPhone Xs device type not available"
          fi
        else
          echo "Note: iOS 18.x runtime not found"
        fi
        
        echo ""
        echo "=== Available iPhone simulators ==="
        xcrun simctl list devices available | grep -i iphone | head -10
      displayName: Install Simulator Runtimes
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))
      continueOnError: true
      timeoutInMinutes: 30

# Provision Additional Software
- ${{ if ne(parameters.skipCertificates, 'true') }}:
  # Prepare macOS
  - task: InstallAppleCertificate@2
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))
    displayName: 'Install Apple Certificate ${{ parameters.certName }}'
    continueOnError: true
    inputs:
      certSecureFile: '${{ parameters.certName }}'
      certPwd: ${{ parameters.certPass }}
      keychain: 'temp'
      opensslPkcsArgs: '${{ parameters.openSslArgs }}'

  - task: InstallAppleProvisioningProfile@1
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))
    displayName: 'Install Apple Provisioning Profile ${{ parameters.provisioningProfileName }}'
    continueOnError: true
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: '${{ parameters.provisioningProfileName }}'

##################################################
#               Provisioning .NET                #
##################################################

# Provisioning .NET - .NET SDK
- task: UseDotNet@2
  displayName: 'Use .NET SDK $(DOTNET_VERSION)'
  inputs:
    packageType: sdk
    version: $(DOTNET_VERSION)
    includePreviewVersions: true

- script: |
    dotnet --list-sdks
    dotnet --version
  displayName: 'List all .NET SDKs'
  continueOnError: true

# Provisioning .NET - Clear all NuGet caches
- ${{ if eq(parameters.clearCaches, 'true') }}:
  - script: dotnet nuget locals all --clear
    displayName: 'Clear all NuGet caches'
    continueOnError: true

# Provisioning .NET - .NET tools
- script: |
    dotnet tool restore --verbosity diag
  displayName: 'Restore .NET Tools'
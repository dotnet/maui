parameters:
  platform: '' # [ android, ios, windows, catalyst ]
  path: '' # path to csproj
  device: '' # the xharness device to use
  cakeArgs: '' # additional cake args
  app: '' #path to app to test
  version: '' #the iOS version'
  provisionatorChannel: 'latest'
  configuration: "Release"
  runtimeVariant: "Mono"
  testFilter: ''
  headless: true
  testConfigurationArgs: ''
  skipProvisioning: true
  checkoutDirectory: $(System.DefaultWorkingDirectory)

steps:
- task: DownloadPipelineArtifact@2
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'Mono'))
  inputs:
    artifact: ui-tests-samples

- task: DownloadPipelineArtifact@2
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'NativeAOT'))
  inputs:
    artifact: ui-tests-samples-nativeaot

- task: DownloadPipelineArtifact@2
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'CoreCLR'))
  inputs:
    artifact: ui-tests-samples-coreclr

- task: DownloadPipelineArtifact@2
  condition: eq('${{ parameters.platform }}' , 'windows')
  inputs:
    artifact: ui-tests-samples-windows

- ${{ if eq(parameters.platform, 'ios')}}:
  - bash: |
      chmod +x $(System.DefaultWorkingDirectory)/eng/scripts/clean-bot.sh
      $(System.DefaultWorkingDirectory)/eng/scripts/clean-bot.sh
    displayName: 'Clean bot'
    continueOnError: true
    timeoutInMinutes: 60

# Enable KVM for Android builds on Linux
- ${{ if and(ne(parameters.buildType, 'buildOnly'), eq(parameters.platform, 'android')) }}:
  - bash: |
      echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
      sudo udevadm control --reload-rules
      sudo udevadm trigger --name-match=kvm
    displayName: Enable KVM
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

- ${{ if eq(parameters.platform, 'catalyst')}}:
  - bash: |
      chmod +x $(System.DefaultWorkingDirectory)/eng/scripts/disable-notification-center.sh
      $(System.DefaultWorkingDirectory)/eng/scripts/disable-notification-center.sh
    displayName: 'Disable Notification Center'
    continueOnError: true
    timeoutInMinutes: 60

- template: provision.yml
  parameters:
    skipJdk: ${{ ne(parameters.platform, 'android') }}
    skipAndroidCommonSdks: ${{ ne(parameters.platform, 'android') }}
    skipAndroidPlatformApis: true
    onlyAndroidPlatformDefaultApis: true
    skipAndroidEmulatorImages: ${{ ne(parameters.platform, 'android') }}
    skipAndroidCreateAvds: true
    androidEmulatorApiLevel: ${{ parameters.version }}
    skipXcode: ${{ or(eq(parameters.platform, 'android'), eq(parameters.platform, 'windows')) }}
    skipSimulatorSetup: ${{ or(eq(parameters.platform, 'android'), eq(parameters.platform, 'windows'), eq(parameters.platform, 'catalyst')) }}
    provisionatorChannel: ${{ parameters.provisionatorChannel }}
    ${{ if parameters.skipProvisioning }}:
      skipProvisionator: true
    ${{ else }}:
      skipProvisionator: false
    ${{ if eq(parameters.platform, 'catalyst') }}:
      openSslArgs: '' # Do not use legacy openssl for Catalyst builds

- task: PowerShell@2
  condition: and(ne('${{ parameters.platform }}', 'windows'), ne('${{ parameters.platform }}', 'android'))
  inputs:
    targetType: 'inline'
    script: |
      defaults write -g NSAutomaticCapitalizationEnabled -bool false
      defaults write -g NSAutomaticTextCompletionEnabled -bool false
      defaults write -g NSAutomaticSpellingCorrectionEnabled -bool false
  displayName: "Modify defaults"
  continueOnError: true

- pwsh: ./build.ps1 --target=dotnet --configuration="${{ parameters.configuration }}" --verbosity=diagnostic
  displayName: 'Install .NET'
  retryCountOnTaskFailure: 2
  env:
    DOTNET_TOKEN: $(dotnetbuilds-internal-container-read-token)
    PRIVATE_BUILD: $(PrivateBuild)

- pwsh: echo "##vso[task.prependpath]$(DotNet.Dir)"
  displayName: 'Add .NET to PATH'

# AzDO hosted agents default to 1024x768; set something bigger for Windows UI tests
- pwsh: |
    $scriptPath = Join-Path "$(System.DefaultWorkingDirectory)" "eng" "scripts" "Set-ScreenResolution.ps1"
    & $scriptPath -Width 1920 -Height 1080
  condition: eq('${{ parameters.platform }}' , 'windows')
  displayName: "Set screen resolution"

- task: UseNode@1
  inputs:
    version: "20.3.1"
  displayName: "Install node"

- pwsh: |
    $skipAppiumDoctor = if ($IsMacOS -or $IsLinux) { "true" } else { "false" }
    dotnet build ./src/Provisioning/Provisioning.csproj -t:ProvisionAppium -p:SkipAppiumDoctor="$skipAppiumDoctor" -bl:"$(LogDirectory)/provision-appium.binlog"
  displayName: "Install Appium"
  continueOnError: false
  retryCountOnTaskFailure: 2
  timeoutInMinutes: 10
  env:
    APPIUM_HOME: $(APPIUM_HOME)

- pwsh: |
    Get-Content $PSCommandPath
    
    Write-Host "========================================="
    Write-Host "DEBUGGING: Testing ALL possible methods to access matrix variable"
    Write-Host "========================================="
    
    # Method 1: Template parameter (compile-time)
    $method1 = "${{ parameters.testFilter }}"
    Write-Host "Method 1 - Template parameter: '$method1'"
    
    # Method 2: Environment variable from env block
    $method2 = $env:CATEGORY_GROUP
    Write-Host "Method 2 - Env var CATEGORY_GROUP: '$method2'"
    
    # Method 3: Environment variable lowercase
    $method3 = $env:categoryGroup
    Write-Host "Method 3 - Env var categoryGroup: '$method3'"
    
    # Method 4: All environment variables containing 'category' (case insensitive)
    Write-Host "Method 4 - All env vars with 'category':"
    Get-ChildItem env: | Where-Object { $_.Name -like '*category*' } | ForEach-Object {
      Write-Host "  $($_.Name) = $($_.Value)"
    }
    
    # Method 5: Check specific Azure DevOps variable patterns
    $method5a = $env:BUILD_BUILDID
    Write-Host "Method 5a - BUILD_BUILDID (sanity check): '$method5a'"
    
    # Method 6: Try reading from pipeline variable using inline expansion
    Write-Host "Method 6 - Inline macro expansion attempt:"
    $inlineMacro = "$(categoryGroup)"
    Write-Host "  Inline \$(categoryGroup): '$inlineMacro'"
    
    # Method 7: List ALL environment variables (first 50)
    Write-Host "Method 7 - First 50 environment variables:"
    Get-ChildItem env: | Select-Object -First 50 | ForEach-Object {
      Write-Host "  $($_.Name) = $($_.Value)"
    }
    
    Write-Host "========================================="
    Write-Host "SELECTING BEST METHOD:"
    
    # Try methods in order of preference
    $testFilterParam = ""
    if ($method1 -and $method1 -ne '${{ parameters.testFilter }}' -and $method1 -ne '$(categoryGroup)') {
      $testFilterParam = $method1
      Write-Host "✅ Using Method 1 (template parameter): '$testFilterParam'"
    }
    elseif ($method2) {
      $testFilterParam = $method2
      Write-Host "✅ Using Method 2 (env CATEGORY_GROUP): '$testFilterParam'"
    }
    elseif ($method3) {
      $testFilterParam = $method3
      Write-Host "✅ Using Method 3 (env categoryGroup): '$testFilterParam'"
    }
    elseif ($inlineMacro -and $inlineMacro -ne '$(categoryGroup)') {
      $testFilterParam = $inlineMacro
      Write-Host "✅ Using Method 6 (inline macro): '$testFilterParam'"
    }
    else {
      # Fallback to original parameter
      $testFilterParam = "${{ parameters.testFilter }}"
      Write-Host "⚠️ No matrix variable found, using original testFilter parameter: '$testFilterParam'"
    }
    
    Write-Host "========================================="
    
    $command = "./build.ps1 -Script eng/devices/${{ parameters.platform }}.cake --target=uitest --project=""${{ parameters.path }}"""
    $command += " --appproject=""${{ parameters.app }}"" --device=""${{ parameters.device }}"" --apiversion=""${{ parameters.version }}"" --configuration=""${{ parameters.configuration }}"""
    $command += " --runtimevariant=""${{ parameters.runtimeVariant }}"""
    $command += " --results=""$(TestResultsDirectory)"" --binlog=""$(LogDirectory)"" ${{ parameters.cakeArgs }} --verbosity=diagnostic"

    $testFilter = ""
    $testConfigrationArgs = "${{ parameters.testConfigurationArgs }}"
    
    if ($testFilterParam) {
      $testFilterParam.Split(",") | ForEach {
        $testFilter += "TestCategory=" + $_ + "|"
      }
      $testFilter = $testFilter.TrimEnd("|")
    }

    # Cake does not allow empty parameters, so check if our filter is empty before adding it
    if ($testConfigrationArgs) {
      $command += " --TEST_CONFIGURATION_ARGS=""$testConfigrationArgs"""
    }
    if ($testFilter) {
      $command += " --test-filter ""$testFilter"""
    }
    
    $headless = ${{ parameters.headless }}
    if ($headless) {
      $command += " --headless ""$headless"""
    }

    Write-Host "Running command: $command"

    Invoke-Expression $command  
  displayName: $(Agent.JobName)
  ${{ if ne(parameters.platform, 'android')}}:
    retryCountOnTaskFailure: 1
  env:
    APPIUM_HOME: $(APPIUM_HOME)
    CATEGORY_GROUP: $(categoryGroup)
    categoryGroup: $(categoryGroup)

- bash: |
    cat ${BASH_SOURCE[0]}
    pwsh ./build.ps1 --target=Cleanup -Script eng/devices/${{ parameters.platform }}.cake ---results="$(TestResultsDirectory)" ${{ parameters.cakeArgs }}
  displayName: Cleanup and Create Simulator Logs if Test Run Failed To
  condition: ${{ eq(parameters.platform, 'ios') }}
  continueOnError: true

- task: PublishTestResults@2
  displayName: Publish the $(System.PhaseName) test results
  condition: always()
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '$(TestResultsDirectory)/*.trx'
    testRunTitle: '${{ parameters.testFilter }}_$(System.PhaseName)'
    failTaskOnFailedTests: true

- task: PublishBuildArtifacts@1
  condition: always()
  displayName: publish artifacts

# Enable Notification Center re-enabled only for catalyst
- ${{ if eq(parameters.platform, 'catalyst')}}:
  - bash: |
      chmod +x $(System.DefaultWorkingDirectory)/eng/scripts/enable-notification-center.sh
      $(System.DefaultWorkingDirectory)/eng/scripts/enable-notification-center.sh
    displayName: 'Enable Notification Center'
    continueOnError: true
    timeoutInMinutes: 60

parameters:
  androidPool: { }
  androidLinuxPool: { }
  iosPool: { }
  windowsPool: { }
  windowsBuildPool: { }
  macosPool: { }
  androidApiLevels: [ 30 ]
  iosVersions: [ 'latest' ]
  provisionatorChannel: 'latest'
  timeoutInMinutes: 180
  skipProvisioning: true
  BuildNativeAOT: false # Parameter to control whether NativeAOT artifacts should be built
  RunNativeAOT: false # Parameter to control whether NativeAOT UI tests should run
  categoryGroupsToTest:
    # Make sure that this list is always up-to-date with src/Controls/tests/TestCases.Shared.Tests/UITestCategories.cs
    # we might want to improve this somehow depending on how much the categories change over time
    - 'Accessibility,ActionSheet,ActivityIndicator,Animation,AppLinks'
    - 'Border,BoxView,Brush,Button'
    - 'CarouselView'
    - 'Cells,CheckBox,ContextActions,CustomRenderers,DatePicker,Dispatcher,DisplayAlert,DisplayPrompt,DragAndDrop'
    - 'CollectionView'
    - 'Entry'
    - 'Editor,Effects,FlyoutPage,Focus,Fonts,Frame,Gestures,GraphicsView'
    - 'Image,ImageButton,IndicatorView,InputTransparent,IsEnabled,IsVisible'
    - 'Label'
    - 'Layout'
    - 'Lifecycle,ManualReview,Maps'
    - 'ListView'
    - 'Navigation'
    - 'Page,Performance,Picker,ProgressBar'
    - 'RadioButton,RefreshView'
    - 'SafeAreaEdges,Shadow'
    - 'ScrollView'
    - 'SearchBar,Shape,Slider'
    - 'SoftInput,Stepper,Switch,SwipeView'
    - 'Shell'
    - 'TabbedPage,TableView,TimePicker,TitleView,ToolbarItem'
    - 'ViewBaseTests,Window'
    - 'WebView'

  projects:
    - name: name
      desc: Human Description
      android: /optional/path/to/android.csproj
      ios: /optional/path/to/ios.csproj
      winui: /optional/path/to/winui.csproj
      mac: /optional/path/to/mac.csproj
      app: /optional/path/to/app.csproj

stages:
  - stage: discover_ui_test_categories
    displayName: Discover UI Test Categories
    condition: eq(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: detect
        displayName: Detect category filters
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            fetchDepth: 0
          - task: PowerShell@2
            name: DetectCategories
            displayName: Determine UI test categories for PRs
            inputs:
              pwsh: true
              filePath: $(System.DefaultWorkingDirectory)/eng/scripts/detect-ui-test-categories.ps1
              arguments: '-TargetBranch "$(System.PullRequest.TargetBranch)"'

  - stage: build_ui_tests
    displayName: Build UITests Sample App
    dependsOn:
      - discover_ui_test_categories
    condition: |
      or(
        ne(variables['Build.Reason'], 'PullRequest'),
        in(dependencies.discover_ui_test_categories.result, 'Succeeded', 'Skipped')
      )
    jobs:
      - job: build_ui_tests
        displayName: Build Sample App
        pool: ${{ parameters.androidPool }}
        variables:
          REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
          APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
        steps:
          - template: ui-tests-build-sample.yml
            parameters:
                runtimeVariant: "Mono"
                skipProvisioning: ${{ parameters.skipProvisioning }}

  - stage: build_ui_tests_coreclr
    displayName: Build UITests CoreCLR Sample App
    dependsOn: []
    jobs:
      - job: build_ui_tests
        displayName: Build Sample App
        pool: ${{ parameters.androidPool }}
        variables:
          REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
          APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
        steps:
          - template: ui-tests-build-sample.yml
            parameters:
                runtimeVariant: "CoreCLR"
                skipProvisioning: ${{ parameters.skipProvisioning }}
  
  # NativeAOT UI tests build stage - only run when BuildNativeAOT parameter is true
  - ${{ if eq(parameters.BuildNativeAOT, true) }}:
    - stage: build_ui_tests_nativeaot
      displayName: Build UITests NativeAOT Sample App
      dependsOn: []
      jobs:
        - job: build_ui_tests
          displayName: Build Sample App
          pool: ${{ parameters.androidPool }}
          variables:
            REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
            APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
          steps:
            - template: ui-tests-build-sample.yml
              parameters:
                  runtimeVariant: "NativeAOT"
                  platform: ios
                  skipProvisioning: ${{ parameters.skipProvisioning }}

  - stage: build_ui_tests_windows
    displayName: Build UITests Windows Sample App
    dependsOn: []
    jobs:
      - job: build_ui_tests
        displayName: Build Sample App (Windows)
        pool: ${{ parameters.windowsBuildPool }}
        variables:
          APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
        steps:
          - template: ui-tests-build-sample.yml
            parameters:
                platform: windows
                skipProvisioning: ${{ parameters.skipProvisioning }}

  - stage: android_ui_tests
    displayName: Android UITests
    dependsOn:
      - build_ui_tests
      - discover_ui_test_categories
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.android, '') }}:
          - ${{ each api in parameters.androidApiLevels }}:
            - ${{ if not(containsValue(project.androidApiLevelsExclude, api)) }}:
              - job: android_ui_tests_${{ project.name }}_${{ api }}
                strategy:
                  matrix:
                    ${{ each categoryGroup in parameters.categoryGroupsToTest }}:
                      ${{ categoryGroup }}:
                        CATEGORYGROUP: ${{ categoryGroup }}
                timeoutInMinutes: 240 # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }} (API ${{ api }})
                pool: ${{ parameters.androidLinuxPool }}
                variables:
                  REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                  # Access detected categories directly from stage dependency
                  DETECTED_CATEGORIES: $[ stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'] ]
                steps:
                  # Calculate effective test filter based on detected categories
                  - pwsh: |
                      $detected = "$(DETECTED_CATEGORIES)"
                      $category = "$(CATEGORYGROUP)"
                      $isPR = "$(Build.Reason)" -eq "PullRequest"
                      
                      Write-Host "Build.Reason: $(Build.Reason)"
                      Write-Host "Is PR: $isPR"
                      Write-Host "Detected categories: '$detected'"
                      Write-Host "Current category group: '$category'"
                      
                      # Determine effective filter
                      $effectiveFilter = $category
                      
                      if ($isPR -and -not [string]::IsNullOrWhiteSpace($detected)) {
                          # For PRs with detected categories, find intersection
                          $categoryList = $category -split ","
                          $detectedList = $detected -split ","
                          $matchingCategories = @()
                          
                          foreach ($cat in $categoryList) {
                              $cat = $cat.Trim()
                              foreach ($det in $detectedList) {
                                  $det = $det.Trim()
                                  if ($cat -eq $det) {
                                      $matchingCategories += $cat
                                      break
                                  }
                              }
                          }
                          
                          if ($matchingCategories.Count -gt 0) {
                              $effectiveFilter = $matchingCategories -join ","
                              Write-Host "Running matching categories: $effectiveFilter"
                          }
                          else {
                              # No match - use a filter that won't match any tests
                              $effectiveFilter = "_NO_MATCHING_CATEGORY_"
                              Write-Host "No matching categories - will skip tests"
                          }
                      }
                      else {
                          Write-Host "Running all categories in group: $effectiveFilter"
                      }
                      
                      Write-Host "##vso[task.setvariable variable=EffectiveTestFilter]$effectiveFilter"
                    displayName: Calculate test filter
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: android
                      version: ${{ api }}
                      path: ${{ project.android }}
                      app: ${{ project.app }}
                      ${{ if eq(api, 27) }}:
                        device: android-emulator-32_${{ api }}
                      ${{ if not(eq(api, 27)) }}:
                        device: android-emulator-64_${{ api }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      testFilter: $(EffectiveTestFilter)
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                  
                  # Collect and publish Android snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'Android'
                      artifactName: 'uitest-snapshot-results-android-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'


  - stage: android_ui_tests_coreclr
    displayName: Android UITests CoreClr
    dependsOn:
      - build_ui_tests_coreclr
      - discover_ui_test_categories
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.android, '') }}:
          - ${{ each api in parameters.androidApiLevels }}:
            - ${{ if not(containsValue(project.androidApiLevelsExclude, api)) }}:
              - job: android_ui_tests_${{ project.name }}_${{ api }}
                strategy:
                  matrix:
                    ${{ each categoryGroup in parameters.categoryGroupsToTest }}:
                      ${{ categoryGroup }}:
                        CATEGORYGROUP: ${{ categoryGroup }}
                timeoutInMinutes: 240 # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }} (API ${{ api }})
                pool: ${{ parameters.androidLinuxPool }}
                variables:
                  REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                  DETECTED_CATEGORIES: $[ stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'] ]
                steps:
                  - pwsh: |
                      $detected = "$(DETECTED_CATEGORIES)"
                      $category = "$(CATEGORYGROUP)"
                      $isPR = "$(Build.Reason)" -eq "PullRequest"
                      
                      Write-Host "Detected categories: '$detected'"
                      Write-Host "Current category group: '$category'"
                      
                      $effectiveFilter = $category
                      
                      if ($isPR -and -not [string]::IsNullOrWhiteSpace($detected)) {
                          $categoryList = $category -split ","
                          $detectedList = $detected -split ","
                          $matchingCategories = @()
                          
                          foreach ($cat in $categoryList) {
                              $cat = $cat.Trim()
                              foreach ($det in $detectedList) {
                                  $det = $det.Trim()
                                  if ($cat -eq $det) {
                                      $matchingCategories += $cat
                                      break
                                  }
                              }
                          }
                          
                          if ($matchingCategories.Count -gt 0) {
                              $effectiveFilter = $matchingCategories -join ","
                              Write-Host "Running matching categories: $effectiveFilter"
                          }
                          else {
                              $effectiveFilter = "_NO_MATCHING_CATEGORY_"
                              Write-Host "No matching categories - will skip tests"
                          }
                      }
                      else {
                          Write-Host "Running all categories in group: $effectiveFilter"
                      }
                      
                      Write-Host "##vso[task.setvariable variable=EffectiveTestFilter]$effectiveFilter"
                    displayName: Calculate test filter
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: android
                      version: ${{ api }}
                      path: ${{ project.android }}
                      app: ${{ project.app }}
                      ${{ if eq(api, 27) }}:
                        device: android-emulator-32_${{ api }}
                      ${{ if not(eq(api, 27)) }}:
                        device: android-emulator-64_${{ api }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      agentPoolAccessToken: ${{ parameters.agentPoolAccessToken }}
                      testFilter: $(EffectiveTestFilter)
                      headless: ${{ parameters.headless }}
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                      runtimeVariant: "CoreCLR"
                  
                  # Collect and publish Android snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'Android'
                      artifactName: 'uitest-snapshot-results-android-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'

  - stage: ios_ui_tests_mono
    displayName: iOS UITests Mono
    dependsOn:
      - build_ui_tests
      - discover_ui_test_categories
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.ios, '') }}:
          - ${{ each version in parameters.iosVersions }}:
            - ${{ if not(containsValue(project.iosVersionsExclude, version)) }}:
              - job: ios_ui_tests_mono_${{ project.name }}_${{ replace(version, '.', '_') }}
                strategy:
                  matrix:
                    ${{ each categoryGroup in parameters.categoryGroupsToTest }}:
                      ${{ categoryGroup }}:
                        CATEGORYGROUP: ${{ categoryGroup }}
                timeoutInMinutes: ${{ parameters.timeoutInMinutes }} # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }} (v${{ version }})
                pool: ${{ parameters.iosPool }}
                variables:
                  REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                  DETECTED_CATEGORIES: $[ stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'] ]
                steps:
                  - pwsh: |
                      $detected = "$(DETECTED_CATEGORIES)"
                      $category = "$(CATEGORYGROUP)"
                      $isPR = "$(Build.Reason)" -eq "PullRequest"
                      
                      Write-Host "Detected categories: '$detected'"
                      Write-Host "Current category group: '$category'"
                      
                      $effectiveFilter = $category
                      
                      if ($isPR -and -not [string]::IsNullOrWhiteSpace($detected)) {
                          $categoryList = $category -split ","
                          $detectedList = $detected -split ","
                          $matchingCategories = @()
                          
                          foreach ($cat in $categoryList) {
                              $cat = $cat.Trim()
                              foreach ($det in $detectedList) {
                                  $det = $det.Trim()
                                  if ($cat -eq $det) {
                                      $matchingCategories += $cat
                                      break
                                  }
                              }
                          }
                          
                          if ($matchingCategories.Count -gt 0) {
                              $effectiveFilter = $matchingCategories -join ","
                              Write-Host "Running matching categories: $effectiveFilter"
                          }
                          else {
                              $effectiveFilter = "_NO_MATCHING_CATEGORY_"
                              Write-Host "No matching categories - will skip tests"
                          }
                      }
                      else {
                          Write-Host "Running all categories in group: $effectiveFilter"
                      }
                      
                      Write-Host "##vso[task.setvariable variable=EffectiveTestFilter]$effectiveFilter"
                    displayName: Calculate test filter
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: ios
                      ${{ if eq(version, 'latest') }}:
                        version: 18.5
                      ${{ if ne(version, 'latest') }}:
                        version: ${{ version }}
                      path: ${{ project.ios }}
                      app: ${{ project.app }}
                      ${{ if eq(version, 'latest') }}:
                        device: ios-simulator-64
                      ${{ if ne(version, 'latest') }}:
                        device: ios-simulator-64_${{ version }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      runtimeVariant : "Mono"
                      testFilter: $(EffectiveTestFilter)
                      headless: ${{ parameters.headless }}
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                  
                  # Collect and publish iOS snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'iOS'
                      artifactName: 'uitest-snapshot-results-ios-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'

  - stage: ios_ui_tests_mono_cv1
    displayName: iOS UITests Mono CollectionView1
    dependsOn:
      - discover_ui_test_categories
      - build_ui_tests
    condition: |
      and(
        succeeded('build_ui_tests'),
        or(
          ne(variables['Build.Reason'], 'PullRequest'),
          eq(dependencies.discover_ui_test_categories.result, 'Skipped'),
          eq(stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'], ''),
          contains(stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'], 'CollectionView')
        )
      )
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.ios, '') }}:
          - ${{ each version in parameters.iosVersions }}:
            - ${{ if not(containsValue(project.iosVersionsExclude, version)) }}:
              - job: CV1_ios_ui_tests_mono_${{ project.name }}_${{ replace(version, '.', '_') }}
                timeoutInMinutes: ${{ parameters.timeoutInMinutes }} # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }} (v${{ version }})
                pool: ${{ parameters.iosPool }}
                variables:
                  REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                steps:
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: ios
                      ${{ if eq(version, 'latest') }}:
                        version: 18.5
                      ${{ if ne(version, 'latest') }}:
                        version: ${{ version }}
                      path: ${{ project.ios }}
                      app: ${{ project.app }}
                      ${{ if eq(version, 'latest') }}:
                        device: ios-simulator-64
                      ${{ if ne(version, 'latest') }}:
                        device: ios-simulator-64_${{ version }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      runtimeVariant : "Mono"
                      testFilter: "CollectionView"
                      headless: ${{ parameters.headless }}
                      testConfigurationArgs: "CollectionView1"
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                  
                  # Collect and publish iOS CV1 snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'iOS CV1'
                      artifactName: 'uitest-snapshot-results-ios-cv2-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'

  - stage: ios_ui_tests_mono_carv1
    displayName: iOS UITests Mono CarouselView1
    dependsOn:
      - discover_ui_test_categories
      - build_ui_tests
    condition: |
      and(
        succeeded('build_ui_tests'),
        or(
          ne(variables['Build.Reason'], 'PullRequest'),
          eq(dependencies.discover_ui_test_categories.result, 'Skipped'),
          eq(stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'], ''),
          contains(stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'], 'CarouselView')
        )
      )
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.ios, '') }}:
          - ${{ each version in parameters.iosVersions }}:
            - ${{ if not(containsValue(project.iosVersionsExclude, version)) }}:
              - job: CARV1_ios_ui_tests_mono_${{ project.name }}_${{ replace(version, '.', '_') }}
                timeoutInMinutes: ${{ parameters.timeoutInMinutes }} # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }} (v${{ version }})
                pool: ${{ parameters.iosPool }}
                variables:
                  REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                steps:
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: ios
                      ${{ if eq(version, 'latest') }}:
                        version: 18.5
                      ${{ if ne(version, 'latest') }}:
                        version: ${{ version }}
                      path: ${{ project.ios }}
                      app: ${{ project.app }}
                      ${{ if eq(version, 'latest') }}:
                        device: ios-simulator-64
                      ${{ if ne(version, 'latest') }}:
                        device: ios-simulator-64_${{ version }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      runtimeVariant : "Mono"
                      testFilter: "CarouselView"
                      testConfigurationArgs: "CollectionView1"
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                  
                  # Collect and publish iOS CARV2 snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'iOS CARV2'
                      artifactName: 'uitest-snapshot-results-ios-carv2-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'

  # NativeAOT iOS UI tests stage - only run when both BuildNativeAOT and RunNativeAOT parameters are true
  - ${{ if and(eq(parameters.BuildNativeAOT, true), eq(parameters.RunNativeAOT, true)) }}:
    - stage: ios_ui_tests_nativeaot
      displayName: iOS UITests NativeAOT
      dependsOn:
        - build_ui_tests_nativeaot
        - discover_ui_test_categories
      jobs:
        - ${{ each project in parameters.projects }}:
          - ${{ if ne(project.ios, '') }}:
            - ${{ each version in parameters.iosVersions }}:
              - ${{ if not(containsValue(project.iosVersionsExclude, version)) }}:
                - job: ios_ui_tests_nativeaot_${{ project.name }}_${{ replace(version, '.', '_') }}
                  strategy:
                    matrix:
                      ${{ each categoryGroup in parameters.categoryGroupsToTest }}:
                        ${{ categoryGroup }}:
                          CATEGORYGROUP: ${{ categoryGroup }}
                  timeoutInMinutes: ${{ parameters.timeoutInMinutes }} # how long to run the job before automatically cancelling
                  workspace:
                    clean: all
                  displayName: ${{ coalesce(project.desc, project.name) }} (v${{ version }})
                  pool: ${{ parameters.iosPool }}
                  variables:
                    REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                    APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                    DETECTED_CATEGORIES: $[ stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'] ]
                  steps:
                    - pwsh: |
                        $detected = "$(DETECTED_CATEGORIES)"
                        $category = "$(CATEGORYGROUP)"
                        $isPR = "$(Build.Reason)" -eq "PullRequest"
                        
                        Write-Host "Detected categories: '$detected'"
                        Write-Host "Current category group: '$category'"
                        
                        $effectiveFilter = $category
                        
                        if ($isPR -and -not [string]::IsNullOrWhiteSpace($detected)) {
                            $categoryList = $category -split ","
                            $detectedList = $detected -split ","
                            $matchingCategories = @()
                            
                            foreach ($cat in $categoryList) {
                                $cat = $cat.Trim()
                                foreach ($det in $detectedList) {
                                    $det = $det.Trim()
                                    if ($cat -eq $det) {
                                        $matchingCategories += $cat
                                        break
                                    }
                                }
                            }
                            
                            if ($matchingCategories.Count -gt 0) {
                                $effectiveFilter = $matchingCategories -join ","
                                Write-Host "Running matching categories: $effectiveFilter"
                            }
                            else {
                                $effectiveFilter = "_NO_MATCHING_CATEGORY_"
                                Write-Host "No matching categories - will skip tests"
                            }
                        }
                        else {
                            Write-Host "Running all categories in group: $effectiveFilter"
                        }
                        
                        Write-Host "##vso[task.setvariable variable=EffectiveTestFilter]$effectiveFilter"
                      displayName: Calculate test filter
                    - template: ui-tests-steps.yml
                      parameters:
                        platform: ios
                        ${{ if eq(version, 'latest') }}:
                          version: 18.5
                        ${{ if ne(version, 'latest') }}:
                          version: ${{ version }}
                        path: ${{ project.ios }}
                        app: ${{ project.app }}
                        ${{ if eq(version, 'latest') }}:
                          device: ios-simulator-64
                        ${{ if ne(version, 'latest') }}:
                          device: ios-simulator-64_${{ version }}
                        provisionatorChannel: ${{ parameters.provisionatorChannel }}
                        runtimeVariant : "NativeAOT"
                        testFilter: $(EffectiveTestFilter)
                        headless: ${{ parameters.headless }}
                        skipProvisioning: ${{ parameters.skipProvisioning }}

  - stage: winui_ui_tests
    displayName: WinUI UITests
    dependsOn:
      - build_ui_tests_windows
      - discover_ui_test_categories
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.winui, '') }}:
              - job: winui_ui_tests_${{ project.name }}
                strategy:
                  matrix:
                    ${{ each categoryGroup in parameters.categoryGroupsToTest }}:
                      ${{ categoryGroup }}:
                        CATEGORYGROUP: ${{ categoryGroup }}
                timeoutInMinutes: ${{ parameters.timeoutInMinutes }} # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }}
                pool: ${{ parameters.windowsPool }}
                variables:
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)\.appium\
                  DETECTED_CATEGORIES: $[ stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'] ]
                steps:
                  - pwsh: |
                      $detected = "$(DETECTED_CATEGORIES)"
                      $category = "$(CATEGORYGROUP)"
                      $isPR = "$(Build.Reason)" -eq "PullRequest"
                      
                      Write-Host "Detected categories: '$detected'"
                      Write-Host "Current category group: '$category'"
                      
                      $effectiveFilter = $category
                      
                      if ($isPR -and -not [string]::IsNullOrWhiteSpace($detected)) {
                          $categoryList = $category -split ","
                          $detectedList = $detected -split ","
                          $matchingCategories = @()
                          
                          foreach ($cat in $categoryList) {
                              $cat = $cat.Trim()
                              foreach ($det in $detectedList) {
                                  $det = $det.Trim()
                                  if ($cat -eq $det) {
                                      $matchingCategories += $cat
                                      break
                                  }
                              }
                          }
                          
                          if ($matchingCategories.Count -gt 0) {
                              $effectiveFilter = $matchingCategories -join ","
                              Write-Host "Running matching categories: $effectiveFilter"
                          }
                          else {
                              $effectiveFilter = "_NO_MATCHING_CATEGORY_"
                              Write-Host "No matching categories - will skip tests"
                          }
                      }
                      else {
                          Write-Host "Running all categories in group: $effectiveFilter"
                      }
                      
                      Write-Host "##vso[task.setvariable variable=EffectiveTestFilter]$effectiveFilter"
                    displayName: Calculate test filter
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: windows
                      version: "10.0.19041.0"
                      device: windows10
                      path: ${{ project.winui }}
                      app: ${{ project.app }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      testFilter: $(EffectiveTestFilter)
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                  
                  # Collect and publish Windows snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'Windows'
                      artifactName: 'uitest-snapshot-results-windows-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'

  - stage: mac_ui_tests
    displayName: macOS UITests
    dependsOn:
      - build_ui_tests
      - discover_ui_test_categories
    jobs:
      - ${{ each project in parameters.projects }}:
        - ${{ if ne(project.mac, '') }}:
              - job: mac_ui_tests_${{ project.name }}
                strategy:
                  matrix:
                    ${{ each categoryGroup in parameters.categoryGroupsToTest }}:
                      ${{ categoryGroup }}:
                        CATEGORYGROUP: ${{ categoryGroup }}
                timeoutInMinutes: ${{ parameters.timeoutInMinutes }} # how long to run the job before automatically cancelling
                workspace:
                  clean: all
                displayName: ${{ coalesce(project.desc, project.name) }}
                pool: ${{ parameters.macosPool }}
                variables:
                  REQUIRED_XCODE: $(DEVICETESTS_REQUIRED_XCODE)
                  APPIUM_HOME: $(System.DefaultWorkingDirectory)/.appium/
                  DETECTED_CATEGORIES: $[ stageDependencies.discover_ui_test_categories.detect.outputs['DetectCategories.UITestCategoryList'] ]
                steps:
                  - pwsh: |
                      $detected = "$(DETECTED_CATEGORIES)"
                      $category = "$(CATEGORYGROUP)"
                      $isPR = "$(Build.Reason)" -eq "PullRequest"
                      
                      Write-Host "Detected categories: '$detected'"
                      Write-Host "Current category group: '$category'"
                      
                      $effectiveFilter = $category
                      
                      if ($isPR -and -not [string]::IsNullOrWhiteSpace($detected)) {
                          $categoryList = $category -split ","
                          $detectedList = $detected -split ","
                          $matchingCategories = @()
                          
                          foreach ($cat in $categoryList) {
                              $cat = $cat.Trim()
                              foreach ($det in $detectedList) {
                                  $det = $det.Trim()
                                  if ($cat -eq $det) {
                                      $matchingCategories += $cat
                                      break
                                  }
                              }
                          }
                          
                          if ($matchingCategories.Count -gt 0) {
                              $effectiveFilter = $matchingCategories -join ","
                              Write-Host "Running matching categories: $effectiveFilter"
                          }
                          else {
                              $effectiveFilter = "_NO_MATCHING_CATEGORY_"
                              Write-Host "No matching categories - will skip tests"
                          }
                      }
                      else {
                          Write-Host "Running all categories in group: $effectiveFilter"
                      }
                      
                      Write-Host "##vso[task.setvariable variable=EffectiveTestFilter]$effectiveFilter"
                    displayName: Calculate test filter
                  - template: ui-tests-steps.yml
                    parameters:
                      platform: catalyst
                      version: "15.3"
                      device: mac
                      path: ${{ project.mac }}
                      app: ${{ project.app }}
                      provisionatorChannel: ${{ parameters.provisionatorChannel }}
                      testFilter: $(EffectiveTestFilter)
                      skipProvisioning: ${{ parameters.skipProvisioning }}
                  
                  # Collect and publish Mac snapshot diffs
                  - template: ui-tests-collect-snapshot-diffs.yml
                    parameters:
                      platform: 'Mac'
                      artifactName: 'uitest-snapshot-results-mac-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)'

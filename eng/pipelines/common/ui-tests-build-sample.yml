parameters:
  platform: '' # [ android, ios, windows, catalyst ]
  path: '' # path to csproj
  device: '' # the xharness device to use
  cakeArgs: '' # additional cake args
  app: '' #path to app to test
  version: '' #the iOS version'
  provisionatorChannel: 'latest'
  skipProvisioning: true
  configuration: "Release"
  testFilter: ''
  headless: true
  runtimeVariant: 'Mono' #Mono, CoreCLR, NativeAOT
  useMaterial3: false # NEW PARAMETER - Enable Material3 build

steps:
- ${{ if eq(parameters.platform, 'ios')}}:
  - bash: |
      chmod +x $(System.DefaultWorkingDirectory)/eng/scripts/clean-bot.sh
      $(System.DefaultWorkingDirectory)/eng/scripts/clean-bot.sh
    displayName: 'Clean bot'
    continueOnError: true
    timeoutInMinutes: 60

- template: provision.yml
  parameters:
    # FIXME: 'Build the MSBuild Tasks' step fails for net9.0-android35 without API 35
    skipAndroidSdks: false
    skipXcode: ${{ or(eq(parameters.platform, 'android'), eq(parameters.platform, 'windows')) }}
    provisionatorChannel: ${{ parameters.provisionatorChannel }}
    ${{ if parameters.skipProvisioning }}:
      skipProvisionator: true
    ${{ else }}:
      skipProvisionator: false

- task: PowerShell@2
  condition: ne('${{ parameters.platform }}' , 'windows')
  inputs:
    targetType: 'inline'
    script: |
      defaults write -g NSAutomaticCapitalizationEnabled -bool false
      defaults write -g NSAutomaticTextCompletionEnabled -bool false
      defaults write -g NSAutomaticSpellingCorrectionEnabled -bool false
  displayName: "Modify defaults"
  continueOnError: true

- pwsh: ./build.ps1 --target=dotnet --configuration="${{ parameters.configuration }}" --verbosity=diagnostic
  displayName: 'Install .NET'
  retryCountOnTaskFailure: 2
  env:
    DOTNET_TOKEN: $(dotnetbuilds-internal-container-read-token)
    PRIVATE_BUILD: $(PrivateBuild)

- pwsh: echo "##vso[task.prependpath]$(DotNet.Dir)"
  displayName: 'Add .NET to PATH'

# Modify HostApp project file to enable Material3 if requested
- pwsh: |
    if (("${{ parameters.useMaterial3 }}" -eq "true") -and ("${{ parameters.platform }}" -eq "android")) {
        $projectFile = "$(System.DefaultWorkingDirectory)/src/Controls/tests/TestCases.HostApp/Controls.TestCases.HostApp.csproj"
        Write-Host "Enabling Material3 in HostApp project file: $projectFile"
        
        # Read the project file content
        $content = Get-Content $projectFile -Raw
        
        # Add UseMaterial3 property to the first PropertyGroup
        $pattern = '(<PropertyGroup[^>]*>)'
        $replacement = '$1`n    <UseMaterial3>true</UseMaterial3>'
        $newContent = $content -replace $pattern, $replacement, 1
        
        # Write back to file
        Set-Content $projectFile -Value $newContent -NoNewline
        Write-Host "Material3 enabled in project file"
        
        # Display the modified section for verification
        Write-Host "Modified project file content (first 20 lines):"
        Get-Content $projectFile | Select-Object -First 20
    }
  displayName: 'Enable Material3 in HostApp project'
  
- pwsh: |
    Get-Content $PSCommandPath
    $buildCommand = "./build.ps1 --target=uitests-apphost --configuration=${{ parameters.configuration }} --${{ parameters.platform }} --verbosity=diagnostic --usenuget=false --runtimevariant=${{ parameters.runtimeVariant }}"
    
    # Display build command
    if (("${{ parameters.useMaterial3 }}" -eq "true") -and ("${{ parameters.platform }}" -eq "android")) {
        Write-Host "Building with Material3 enabled via project file modification"
    }
    
    Invoke-Expression $buildCommand
  displayName: 'Build the samples'

# Restore original HostApp project file after build
- pwsh: |
    if (("${{ parameters.useMaterial3 }}" -eq "true") -and ("${{ parameters.platform }}" -eq "android")) {
        $projectFile = "$(System.DefaultWorkingDirectory)/src/Controls/tests/TestCases.HostApp/Controls.TestCases.HostApp.csproj"
        Write-Host "Restoring original HostApp project file"
        
        # Read the current content
        $content = Get-Content $projectFile -Raw
        
        # Remove the UseMaterial3 property we added
        $newContent = $content -replace '\s*<UseMaterial3>true</UseMaterial3>\r?\n', ''
        
        # Write back to file
        Set-Content $projectFile -Value $newContent -NoNewline
        Write-Host "Project file restored to original state"
    }
  displayName: 'Restore HostApp project file'
  condition: always()
  
- bash: |
    if [ -f "$HOME/Library/Logs/CoreSimulator/*" ]; then rm -r $HOME/Library/Logs/CoreSimulator/*; fi
    if [ -f "$HOME/Library/Logs/DiagnosticReports/*" ]; then rm -r $HOME/Library/Logs/DiagnosticReports/*; fi
  displayName: Delete Old Simulator Logs
  condition: ${{ eq(parameters.platform, 'ios') }}
  continueOnError: true

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), ne('${{ parameters.runtimeVariant }}' , 'NativeAOT'), ne('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'false'), succeeded())
  artifact: ui-tests-samples

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'NativeAOT'), succeeded())
  artifact: ui-tests-samples-nativeaot

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'false'), succeeded())
  artifact: ui-tests-samples-coreclr

# Material3 artifacts
- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), ne('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'true'), succeeded())
  artifact: ui-tests-samples-material3

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'true'), succeeded())
  artifact: ui-tests-samples-material3-coreclr

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(eq('${{ parameters.platform }}' , 'windows'), succeeded())
  artifact: ui-tests-samples-windows

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), ne('${{ parameters.runtimeVariant }}' , 'NativeAOT'), ne('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'false'), failed())
  artifact: ui-tests-samples_failed_$(System.JobAttempt)

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'NativeAOT'), failed())
  artifact: ui-tests-samples-nativeaot_failed_$(System.JobAttempt)

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'false'), failed())
  artifact: ui-tests-samples-coreclr_failed_$(System.JobAttempt)

# Material3 failure artifacts
- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), ne('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'true'), failed())
  artifact: ui-tests-samples-material3_failed_$(System.JobAttempt)

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(ne('${{ parameters.platform }}' , 'windows'), eq('${{ parameters.runtimeVariant }}' , 'CoreCLR'), eq('${{ parameters.useMaterial3 }}', 'true'), failed())
  artifact: ui-tests-samples-material3-coreclr_failed_$(System.JobAttempt)

- publish: $(System.DefaultWorkingDirectory)/artifacts/bin
  condition: and(eq('${{ parameters.platform }}' , 'windows'), failed())
  artifact: ui-tests-samples-windows_failed_$(System.JobAttempt)

- task: PublishBuildArtifacts@1
  displayName: Publish Artifacts
  condition: always()
  inputs:
    artifactName: '$(Agent.JobName) (attempt $(System.JobAttempt))'

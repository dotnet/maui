# Pipeline for running GitHub Copilot PR Reviewer Agent
# This pipeline installs the Copilot CLI and invokes the PR reviewer agent
# to conduct automated code reviews on pull requests.
#
# For more information, see:
# https://github.com/dotnet/maui/wiki/PR-Reviewer-Agent

trigger: none  # Manual trigger only

pr: none  # Not triggered by PRs

parameters:
  - name: PRNumber
    displayName: 'Pull Request Number'
    type: string
    default: ''

  - name: pool
    type: object
    default:
      name: MAUI-Testing
      vmImage: ubuntu-latest
      demands:
        - Agent.OS -equals Darwin

variables:
  Codeql.Enabled: false
  Codeql.SkipTaskAutoInjection: true

stages:
  - stage: ReviewPR
    displayName: 'Review Pull Request'
    jobs:
      - job: CopilotReview
        displayName: 'Run Copilot PR Reviewer Agent'
        pool: ${{ parameters.pool }}
        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true

          - script: |
              echo "Validating PR Number parameter..."
              if [ -z "${{ parameters.PRNumber }}" ]; then
                echo "##vso[task.logissue type=error]PRNumber parameter is required"
                exit 1
              fi
              echo "PR Number: ${{ parameters.PRNumber }}"
            displayName: 'Validate Parameters'

          - script: |
              echo "Installing Node.js 22..."
              brew install node@22
              brew link --overwrite node@22
              node --version
              npm --version
              echo "Node.js installed successfully"
            displayName: 'Install Node.js'

          - script: |
              echo "Installing GitHub CLI..."
              brew install gh
              gh --version
              echo "GitHub CLI installed successfully"
            displayName: 'Install GitHub CLI'

          - script: |
              echo "Authenticating with GitHub CLI..."
              echo "$(GH_CLI_TOKEN)" | gh auth login --with-token
              gh auth status
            displayName: 'Authenticate GitHub CLI'
            env:
              GH_CLI_TOKEN: $(GH_CLI_TOKEN)

          - script: |
              echo "Installing GitHub Copilot CLI..."
              npm install -g @github/copilot
              echo "Copilot CLI installed successfully"
            displayName: 'Install GitHub Copilot CLI'

          - script: |
              echo "Fetching PR #${{ parameters.PRNumber }}..."
              git fetch origin pull/${{ parameters.PRNumber }}/head:pr-${{ parameters.PRNumber }}
              git checkout pr-${{ parameters.PRNumber }}
              echo "Checked out PR branch successfully"
              git log -1 --oneline
            displayName: 'Checkout PR Branch'

          - script: |
              echo "Running Copilot PR Reviewer Agent..."
              echo "Reviewing PR #${{ parameters.PRNumber }}..."
              
              # Invoke the PR reviewer agent using Copilot CLI in programmatic mode
              # --allow-all-tools allows Copilot to execute commands without manual approval
              # Capture output to a file for posting as PR comment
              copilot -p "review PR #${{ parameters.PRNumber }}" --allow-all-tools --allow-all-paths 2>&1 | tee $(Build.ArtifactStagingDirectory)/copilot_review_output.md
              
              echo "Review output saved to $(Build.ArtifactStagingDirectory)/copilot_review_output.md"
            displayName: 'Run PR Reviewer Agent'
            env:
              GITHUB_TOKEN: $(COPILOT_TOKEN)

          - script: |
              echo "Posting review comment to PR..."
              
              # Check for the captured output file first
              REVIEW_FILE="$(Build.ArtifactStagingDirectory)/copilot_review_output.md"
              CLEANED_FILE="$(Build.ArtifactStagingDirectory)/copilot_review_cleaned.md"
              
              # Also check if Copilot created a Review_Feedback file
              FEEDBACK_FILE=$(find . -name "Review_Feedback_*.md" -type f | head -1)
              
              if [ -n "$FEEDBACK_FILE" ]; then
                echo "Found review feedback file: $FEEDBACK_FILE"
                REVIEW_FILE="$FEEDBACK_FILE"
              fi
              
              if [ -f "$REVIEW_FILE" ] && [ -s "$REVIEW_FILE" ]; then
                echo "Cleaning up review output..."
                
                # Remove intro lines like "I'll review PR #XXXXX for you." and "The code review for PR #XXXXX is complete."
                # Remove stats at the end (Total usage est, Total duration, Usage by model, etc.)
                sed -n '/^## /,$p' "$REVIEW_FILE" | \
                  sed '/^Total usage est:/,$d' | \
                  sed '/^Total duration/d' | \
                  sed '/^Total code changes/d' | \
                  sed '/^Usage by model/,$d' > "$CLEANED_FILE"
                
                # If cleaning removed everything, fall back to original
                if [ ! -s "$CLEANED_FILE" ]; then
                  echo "Cleaned file is empty, using original"
                  cp "$REVIEW_FILE" "$CLEANED_FILE"
                fi
                
                echo "Posting review from: $CLEANED_FILE"
                echo "--- Review Content Preview ---"
                head -50 "$CLEANED_FILE"
                echo "--- End Preview ---"
                
                # Post the review as a comment on the PR
                # Note: GH_COMMENT_TOKEN needs 'repo' scope or 'pull_requests:write' permission
                if gh pr comment ${{ parameters.PRNumber }} --repo dotnet/maui --body-file "$CLEANED_FILE"; then
                  echo "Review comment posted successfully"
                else
                  echo "##vso[task.logissue type=warning]Failed to post comment. Check that GH_COMMENT_TOKEN has 'repo' or 'pull_requests:write' scope."
                  echo "Review content is available in the published artifacts."
                fi
              else
                echo "No review output found or file is empty"
              fi
            displayName: 'Post Review Comment'
            env:
              GITHUB_TOKEN: $(GH_COMMENT_TOKEN)
            condition: succeededOrFailed()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Review Artifacts'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)'
              artifact: 'ReviewOutput'
              publishLocation: 'pipeline'
            condition: succeededOrFailed()

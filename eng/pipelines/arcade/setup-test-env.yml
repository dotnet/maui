parameters:
  mauiSourcePath: $(Build.SourcesDirectory)
  buildConfig: Debug
  repoLogPath: $(Build.Arcade.LogsPath)
  installPackageArtifacts: true

steps:
- checkout: self
  fetchDepth: 1
  clean: true

# Setup JDK Paths (gradle needs it)
- bash: |
    echo "##vso[task.setvariable variable=JI_JAVA_HOME]$(JAVA_HOME_17_X64)"
    echo "##vso[task.setvariable variable=JAVA_HOME]$(JAVA_HOME_17_X64)"
  #  brew install --cask microsoft-openjdk@17
  displayName: 'Setup JDK Paths'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

- pwsh: |
    if ($env:JAVA_HOME_17_X64) {
      $env:JAVA_HOME = $env:JAVA_HOME_17_X64
    } else {
      $path = (Get-ChildItem $env:ProgramFiles\Microsoft\jdk-17.*\bin\java.exe) | Select-Object -First 1
      if ($path -and (Test-Path $path)) {
        $env:JAVA_HOME = $path.Directory.Parent.FullName
      }
    }
    if ($env:JAVA_HOME) {
      echo "##vso[task.setvariable variable=JAVA_HOME]$env:JAVA_HOME"
      echo "JAVA_HOME set to '$env:JAVA_HOME'"
    } else {
      echo "Unable to set JAVA_HOME"
    }
  displayName: 'Setup JDK Paths'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

- task: UseDotNet@2
  displayName: 'Use .NET SDK $(DOTNET_VERSION)'
  inputs:
    packageType: sdk
    version: $(DOTNET_VERSION)
    includePreviewVersions: true


- ${{ if eq(parameters.installPackageArtifacts, true) }}:
  - task: DownloadPipelineArtifact@2
    displayName: Download PackageArtifacts
    inputs:
      artifactName: PackageArtifacts
      itemPattern: '**/*.nupkg'
      targetPath: ${{ parameters.mauiSourcePath }}/artifacts

  - task: DotNetCoreCLI@2
    displayName: Install dotnet preview without workloads
    inputs:
      projects: ${{ parameters.mauiSourcePath }}/src/DotNet/DotNet.csproj
      arguments: '-p:InstallWorkloadPacks=false -c ${{ parameters.buildConfig }} -bl:${{ parameters.repoLogPath }}/install-dotnet.binlog'

  - task: DotNetCoreCLI@2
    displayName: Install dotnet preview workloads from PackageArtifacts
    inputs:
      projects: ${{ parameters.mauiSourcePath }}/src/DotNet/DotNet.csproj
      arguments: '-t:Install -c ${{ parameters.buildConfig }} -bl:${{ parameters.repoLogPath }}/install-dotnet.binlog'

- ${{ else }}:
  - task: DotNetCoreCLI@2
    displayName: Install dotnet preview
    inputs:
      projects: ${{ parameters.mauiSourcePath }}/src/DotNet/DotNet.csproj
      arguments: '-c ${{ parameters.buildConfig }} -bl:${{ parameters.repoLogPath }}/install-dotnet.binlog'

  - template: /eng/pipelines/common/run-dotnet-preview.yml
    parameters:
      displayName: Build MSBuild Tasks
      mauiSourcePath: ${{ parameters.mauiSourcePath }}
      project: ${{ parameters.mauiSourcePath }}/Microsoft.Maui.BuildTasks.slnf
      arguments: '-c ${{ parameters.buildConfig }} -bl:${{ parameters.repoLogPath }}/Microsoft.Maui.BuildTasks.binlog'

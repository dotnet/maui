parameters:
  mauiSourcePath: $(Build.SourcesDirectory)
  logPath: $(Build.ArtifactStagingDirectory)

steps:
- checkout: self
  fetchDepth: 1
  clean: true

- task: UseDotNet@2
  displayName: Install .NET 9.x
  inputs:
    version: 9.x
    includePreviewVersions: true

- task: DotNetCoreCLI@2
  displayName: Install dotnet preview
  inputs:
    projects: ${{ parameters.mauiSourcePath }}/src/DotNet/DotNet.csproj
    arguments: '-bl:${{ parameters.logPath }}/install-dotnet.binlog'

- template: /eng/pipelines/common/run-dotnet-preview.yml
  parameters:
    displayName: Build MSBuild Tasks
    mauiSourcePath: ${{ parameters.mauiSourcePath }}
    project: ${{ parameters.mauiSourcePath }}/Microsoft.Maui.BuildTasks.slnf
    arguments: '-bl:${{ parameters.logPath }}/Microsoft.Maui.BuildTasks.binlog'

- pwsh: |
    if ($env:JAVA_HOME_17_X64) {
      $env:JAVA_HOME = $env:JAVA_HOME_17_X64
    } else {
      $path = (Get-ChildItem $env:ProgramFiles\Microsoft\jdk-17.*\bin\java.exe) | Select-Object -First 1
      if ($path -and (Test-Path $path)) {
        $env:JAVA_HOME = $path.Directory.Parent.FullName
      }
    }
    if ($env:JAVA_HOME) {
      echo "##vso[task.setvariable variable=JAVA_HOME]$env:JAVA_HOME"
      echo "JAVA_HOME set to '$env:JAVA_HOME'"
    } else {
      echo "Unable to set JAVA_HOME"
    }
  displayName: Set JAVA_HOME to JDK 17

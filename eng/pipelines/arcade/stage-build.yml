# Template for build + pack on dnceng
parameters:
- name: prepareSteps
  type: stepList
  default: []
- name: postSteps
  type: stepList
  default: []
- name: enableSourceBuild
  type: boolean
  default: false
- name: enableSourceIndex
  type: boolean
  default: false
- name: sourceIndexParams
  type: object
  default: []
- name: runAsPublic
  type: boolean
  default: false
- name: buildProjects
  type: string
  default: 'Microsoft.Maui.sln'
- name: buildConfigurations
  type: object
  default:
  - Debug
  - Release
- name: buildPlatforms
  type: object
  default:
  - name: NetCore-Public
    image: 1es-windows-2022
    os: windows
  - name: Azure Pipelines
    image: $(HostedMacImage)
    os: macOS

stages:
- stage: Build
  displayName: Build .NET MAUI
  dependsOn: []
  jobs:
  - template: /eng/common/templates-official/jobs/jobs.yml
    parameters:
      helixRepo: dotnet/maui
      pool: $(BuildPlatform)
      enableMicrobuild: true
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: true
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: true
      workspace:
        clean: all
      jobs:
      - ${{ each BuildConfiguration in parameters.BuildConfigurations }}:
        - job: build_net_$(BuildConfiguration)
          displayName: Build Windows $(BuildConfiguration)
          timeoutInMinutes: 240
          preSteps:
          - checkout: self
            fetchDepth: 1
            clean: true
          steps:
          - ${{ each step in parameters.prepareSteps }}:
            - ${{ each pair in step }}:
                ${{ pair.key }}: ${{ pair.value }}

          - script: $(_buildScript) -restore -build -configuration $(BuildConfiguration) -projects "Microsoft.Maui.BuildTasks.slnf" /p:ArchiveTests=false /p:TreatWarningsAsErrors=false /bl:$(Build.Arcade.LogsPath)buildtasks.binlog $(_OfficialBuildIdArgs)
            displayName: üõ†Ô∏è Build BuildTasks

          - script: $(_buildScript) -restore -build -configuration $(BuildConfiguration) -projects "${{ parameters.buildProjects }}" /p:ArchiveTests=false /p:TreatWarningsAsErrors=false /bl:$(Build.Arcade.LogsPath)build.binlog $(_OfficialBuildIdArgs)
            displayName: üõ†Ô∏è Build ${{ parameters.buildProjects }}

# Template for devicetests on dnceng
parameters:
- name: prepareSteps
  type: stepList
  default: []
- name: postSteps
  type: stepList
  default: []
- name: buildPool
  type: object
- name: testPool
  type: object
- name: windowsBuildPool
  type: object
  default: {}
- name: windowsTestPool
  type: object
  default: {}
- name: enableSourceBuild
  type: boolean
  default: false
- name: enableSourceIndex
  type: boolean
  default: false
- name: sourceIndexParams
  type: object
  default: []
- name: publishAssets
  type: boolean
  default: false
- name: enableMicrobuild
  type: boolean
  default: false
- name: runAsPublic
  type: boolean
  default: true
- name: helixProject
  type: string
  default: 'eng/helix_xharness.proj'
- name: extraHelixArguments
  type: string
  default: ''
- name: BuildConfiguration
  type: string
  default: 'Release'
- name: TargetFrameworkVersion
  type: string
  default: 'net10.0'
- name: appArtifactName
  type: string
  default: 'device_tests_app'
- name: checkoutDirectory
  type: string
  default: $(System.DefaultWorkingDirectory)
- name: HelixInternal
  type: string
  default: ''
- name: HelixAccessToken
  type: string
  default: ''
- name: runWindowsTests
  type: boolean
  default: false
- name: windowsDeviceTestProjects
  type: object
  default:
    - name: Controls.DeviceTests
      path: src/Controls/tests/DeviceTests/Controls.DeviceTests.csproj
      packageId: com.microsoft.maui.controls.devicetests
    - name: Core.DeviceTests
      path: src/Core/tests/DeviceTests/Core.DeviceTests.csproj
      packageId: com.microsoft.maui.core.devicetests
    - name: Graphics.DeviceTests
      path: src/Graphics/tests/DeviceTests/Graphics.DeviceTests.csproj
      packageId: com.microsoft.maui.graphics.devicetests
    - name: Essentials.DeviceTests
      path: src/Essentials/test/DeviceTests/Essentials.DeviceTests.csproj
      packageId: com.microsoft.maui.essentials.devicetests
    - name: MauiBlazorWebView.DeviceTests
      path: src/BlazorWebView/tests/DeviceTests/MauiBlazorWebView.DeviceTests.csproj
      packageId: Microsoft.Maui.MauiBlazorWebView.DeviceTests

stages:
- stage: devicetests_build
  displayName: ${{ parameters.TargetFrameworkVersion }} ios/catalyst/android Helix Tests (Mono)
  dependsOn: []
  jobs:
  - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
    parameters:
      helixRepo: dotnet/maui
      pool: ${{ parameters.buildPool }}
      enableMicrobuild: ${{ parameters.enableMicrobuild }}
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: ${{ parameters.publishAssets }}
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      workspace:
        clean: all
      jobs:
      - job: builddevice_tests
        displayName: Build Device Tests (Mono)
        timeoutInMinutes: 120
        variables:
        - name: _BuildConfig
          value: ${{ parameters.BuildConfiguration }}
        preSteps:
        - checkout: self
          fetchDepth: 1
          clean: true

        steps:
        - ${{ each step in parameters.prepareSteps }}:
          - ${{ each pair in step }}:
              ${{ pair.key }}: ${{ pair.value }}

        # Run on public pipeline
        - script: $(_buildScriptMacOS) -restore -build -configuration $(_BuildConfig) -projects '$(Build.SourcesDirectory)/Microsoft.Maui.BuildTasks.slnf' /bl:BuildBuildTasks.binlog $(_OfficialBuildIdArgs)
          displayName: Build BuildTasks

        - script: $(_buildScriptMacOS) -restore -build -configuration $(_BuildConfig) /p:BuildDeviceTests=true /bl:BuildDeviceTests.binlog
          displayName: Build DeviceTests

        - publish: ${{ parameters.checkoutDirectory }}/artifacts/bin
          displayName: Publish Succeeded Artifacts Directory
          condition: succeeded()
          artifact: ${{ parameters.appArtifactName }}

        - publish: ${{ parameters.checkoutDirectory }}/artifacts/bin
          displayName: Publish Failed Artifacts Directory
          condition: not(succeeded())
          artifact: ${{ parameters.appArtifactName }}_failed_$(System.JobAttempt)

- stage: devicetests_ios
  displayName: ${{ parameters.TargetFrameworkVersion }} iOS Helix Tests (Mono)
  dependsOn: 
    - devicetests_build
  jobs:
  - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
    parameters:
      helixRepo: dotnet/maui
      pool: ${{ parameters.testPool }}
      enableMicrobuild: false
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: ${{ parameters.publishAssets }}
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      workspace:
        clean: all
      jobs:
      - job: device_tests_ios
        displayName: Run DeviceTests iOS (Mono)
        timeoutInMinutes: 240
        variables:
        - name: _BuildConfig
          value: ${{ parameters.BuildConfiguration }}
        preSteps:
        - checkout: self
          fetchDepth: 1
          clean: true

        - task: DownloadPipelineArtifact@2
          displayName: 'Download Build'
          condition: succeeded()
          inputs:
            artifactName: ${{ parameters.appArtifactName }}
            targetPath: ${{ parameters.checkoutDirectory }}/artifacts/bin

        - template: /eng/common/templates-official/steps/send-to-helix.yml
          parameters:
            HelixProjectPath: ${{ parameters.helixProject }}
            ${{ if eq(parameters.runAsPublic, true) }}:
              HelixProjectArguments: /p:TargetOS=ios /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsIOS_ /p:HelixInternal=False
            ${{ else }}:
              HelixProjectArguments: /p:TargetOS=ios /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsIOS_ /p:HelixInternal=True
            HelixAccessToken: ${{ parameters.HelixAccessToken }}
            HelixConfiguration: $(_BuildConfig)
            IncludeDotNetCli: true
            DisplayNamePrefix: DeviceTestsIOS
            WorkItemTimeout: 04:00:00
            XUnitWorkItemTimeout: 04:00:00

- stage: devicetests_catalyst
  displayName: ${{ parameters.TargetFrameworkVersion }} MacCatalyst Helix Tests (Mono)
  dependsOn: 
    - devicetests_build
  jobs:
  - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
    parameters:
      helixRepo: dotnet/maui
      pool: ${{ parameters.testPool }}
      enableMicrobuild: ${{ parameters.enableMicrobuild }}
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: ${{ parameters.publishAssets }}
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      workspace:
        clean: all
      jobs:
      - job: device_tests_maccatalyst
        displayName: Run DeviceTests MacCatalyst (Mono)
        timeoutInMinutes: 240
        variables:
        - name: _BuildConfig
          value: ${{ parameters.BuildConfiguration }}
        preSteps:
        - checkout: self
          fetchDepth: 1
          clean: true

        - task: DownloadPipelineArtifact@2
          displayName: 'Download Build'
          condition: succeeded()
          inputs:
            artifactName: ${{ parameters.appArtifactName }}
            targetPath: ${{ parameters.checkoutDirectory }}/artifacts/bin

        - template: /eng/common/templates-official/steps/send-to-helix.yml
          parameters:
            HelixProjectPath: ${{ parameters.helixProject }}
            ${{ if eq(parameters.runAsPublic, true) }}:
              HelixProjectArguments: /p:TargetOS=maccatalyst /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsMacCatalyst_ /p:HelixInternal=False
            ${{ else }}:
              HelixProjectArguments: /p:TargetOS=maccatalyst /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsMacCatalyst_ /p:HelixInternal=True
            HelixAccessToken: ${{ parameters.HelixAccessToken }}
            HelixConfiguration: $(_BuildConfig)
            IncludeDotNetCli: true
            DisplayNamePrefix: DeviceTestsMacCatalyst

- stage: devicetests_android
  displayName: ${{ parameters.TargetFrameworkVersion }} Android Helix Tests (Mono)
  dependsOn: 
    - devicetests_build
  jobs:
  - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
    parameters:
      helixRepo: dotnet/maui
      pool: ${{ parameters.testPool }}
      enableMicrobuild: ${{ parameters.enableMicrobuild }}
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: ${{ parameters.publishAssets }}
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      workspace:
        clean: all
      jobs:
      - job: device_tests_android
        displayName: Run DeviceTests Android (Mono)
        timeoutInMinutes: 60
        variables:
        - name: _BuildConfig
          value: ${{ parameters.BuildConfiguration }}
        preSteps:
        - checkout: self
          fetchDepth: 1
          clean: true

        - task: DownloadPipelineArtifact@2
          displayName: 'Download Build'
          condition: succeeded()
          inputs:
            artifactName: ${{ parameters.appArtifactName }}
            targetPath: ${{ parameters.checkoutDirectory }}/artifacts/bin

        - template: /eng/common/templates-official/steps/send-to-helix.yml
          parameters:
            HelixProjectPath: ${{ parameters.helixProject }}
            ${{ if eq(parameters.runAsPublic, true) }}:
              HelixProjectArguments: /p:TargetOS=android /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsAndroid_ /p:HelixInternal=False
            ${{ else }}:
              HelixProjectArguments: /p:TargetOS=android /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsAndroid_ /p:HelixInternal=True
            HelixAccessToken: ${{ parameters.HelixAccessToken }}
            HelixConfiguration: $(_BuildConfig)
            IncludeDotNetCli: true
            DisplayNamePrefix: DeviceTestsAndroid

# CoreCLR Device Tests Stages (Android only)
- stage: devicetests_build_coreclr
  displayName: ${{ parameters.TargetFrameworkVersion }} Android CoreCLR Helix Tests
  dependsOn: []
  jobs:
  - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
    parameters:
      helixRepo: dotnet/maui
      pool: ${{ parameters.buildPool }}
      enableMicrobuild: ${{ parameters.enableMicrobuild }}
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: ${{ parameters.publishAssets }}
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      workspace:
        clean: all
      jobs:
      - job: builddevice_tests_coreclr
        displayName: Build Device Tests (CoreCLR)
        timeoutInMinutes: 120
        variables:
        - name: _BuildConfig
          value: ${{ parameters.BuildConfiguration }}
        preSteps:
        - checkout: self
          fetchDepth: 1
          clean: true

        steps:
        - ${{ each step in parameters.prepareSteps }}:
          - ${{ each pair in step }}:
              ${{ pair.key }}: ${{ pair.value }}

        # Run on public pipeline
        - script: $(_buildScriptMacOS) -restore -build -configuration $(_BuildConfig) -projects '$(Build.SourcesDirectory)/Microsoft.Maui.BuildTasks.slnf' /bl:BuildBuildTasks.binlog $(_OfficialBuildIdArgs)
          displayName: Build BuildTasks

        - script: $(_buildScriptMacOS) -restore -build -configuration $(_BuildConfig) /p:BuildDeviceTests=true /p:UseMonoRuntime=false /p:IncludeIosTargetFrameworks=false /p:IncludeMacCatalystTargetFrameworks=false /bl:BuildDeviceTests.binlog
          displayName: Build DeviceTests (CoreCLR)

        - publish: ${{ parameters.checkoutDirectory }}/artifacts/bin
          displayName: Publish Succeeded Artifacts Directory
          condition: succeeded()
          artifact: ${{ parameters.appArtifactName }}_coreclr

        - publish: ${{ parameters.checkoutDirectory }}/artifacts/bin
          displayName: Publish Failed Artifacts Directory
          condition: not(succeeded())
          artifact: ${{ parameters.appArtifactName }}_coreclr_failed_$(System.JobAttempt)

- stage: devicetests_android_coreclr
  displayName: ${{ parameters.TargetFrameworkVersion }} Android CoreCLR Helix Tests
  dependsOn: 
    - devicetests_build_coreclr
  jobs:
  - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
    parameters:
      helixRepo: dotnet/maui
      pool: ${{ parameters.testPool }}
      enableMicrobuild: ${{ parameters.enableMicrobuild }}
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: ${{ parameters.publishAssets }}
      enableTelemetry: true
      enableSourceBuild: ${{ parameters.enableSourceBuild }}
      enableSourceIndex: ${{ parameters.enableSourceIndex }}
      sourceIndexParams: ${{ parameters.sourceIndexParams }}
      publishAssetsImmediately: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      workspace:
        clean: all
      jobs:
      - job: device_tests_android_coreclr
        displayName: Run DeviceTests Android (CoreCLR)
        timeoutInMinutes: 60
        variables:
        - name: _BuildConfig
          value: ${{ parameters.BuildConfiguration }}
        preSteps:
        - checkout: self
          fetchDepth: 1
          clean: true

        - task: DownloadPipelineArtifact@2
          displayName: 'Download Build'
          condition: succeeded()
          inputs:
            artifactName: ${{ parameters.appArtifactName }}_coreclr
            targetPath: ${{ parameters.checkoutDirectory }}/artifacts/bin

        - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/steps/send-to-helix.yml', '/eng/common/templates-official/steps/send-to-helix.yml@self') }}
          parameters:
            HelixProjectPath: ${{ parameters.helixProject }}
            ${{ if eq(parameters.runAsPublic, true) }}:
              HelixProjectArguments: /p:TargetOS=android /p:TestRunNameSuffix=_$(_BuildConfig)_CoreCLR /p:TestRunNamePrefix=DeviceTestsAndroid_CoreCLR_ /p:HelixInternal=False
            ${{ else }}:
              HelixProjectArguments: /p:TargetOS=android /p:TestRunNameSuffix=_$(_BuildConfig)_CoreCLR /p:TestRunNamePrefix=DeviceTestsAndroid_CoreCLR_ /p:HelixInternal=True
            HelixAccessToken: ${{ parameters.HelixAccessToken }}
            HelixConfiguration: $(_BuildConfig)
            IncludeDotNetCli: true
            DisplayNamePrefix: DeviceTestsAndroid_CoreCLR

# Windows Device Tests Stages
- ${{ if eq(parameters.runWindowsTests, true) }}:
  - stage: devicetests_build_windows
    displayName: ${{ parameters.TargetFrameworkVersion }} Windows Helix Tests - Build
    dependsOn: []
    jobs:
    - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
      parameters:
        helixRepo: dotnet/maui
        pool: ${{ parameters.windowsBuildPool }}
        enableMicrobuild: ${{ parameters.enableMicrobuild }}
        enablePublishUsingPipelines: true
        enablePublishBuildAssets: ${{ parameters.publishAssets }}
        enableTelemetry: true
        enableSourceBuild: ${{ parameters.enableSourceBuild }}
        enableSourceIndex: ${{ parameters.enableSourceIndex }}
        sourceIndexParams: ${{ parameters.sourceIndexParams }}
        publishAssetsImmediately: true
        enablePublishBuildArtifacts: true
        enablePublishTestResults: false
        workspace:
          clean: all
        jobs:
        - job: builddevice_tests_windows
          displayName: Build Device Tests (Windows)
          timeoutInMinutes: 90
          variables:
          - name: _BuildConfig
            value: Debug
          preSteps:
          - checkout: self
            fetchDepth: 1
            clean: true

          steps:
          # Restore dotnet tools (required for dotnet cake)
          - script: dotnet tool restore
            displayName: 'Restore .NET tools'
            retryCountOnTaskFailure: 3

          # Install .NET SDK
          - script: dotnet cake --target=dotnet --configuration="Release" --verbosity=diagnostic
            displayName: 'Install .NET'
            retryCountOnTaskFailure: 3
            env:
              DOTNET_TOKEN: $(dotnetbuilds-internal-container-read-token)
              PRIVATE_BUILD: $(PrivateBuild)

          - pwsh: echo "##vso[task.prependpath]$(DotNet.Dir)"
            displayName: 'Add .NET to PATH'

          # Build BuildTasks first
          - script: dotnet cake --target=dotnet-buildtasks --configuration="Release"
            displayName: Build the MSBuild Tasks

          # Build Windows device tests using Cake script (Packaged/MSIX builds)
          # TODO: Unpackaged builds disabled - apps crash on Helix with 0xC000027B
          # (Windows App SDK Bootstrap failure). Investigating root cause. See PR #33328.
          - ${{ each project in parameters.windowsDeviceTestProjects }}:
            - script: dotnet cake eng/devices/windows.cake --target=buildOnly --project="$(Build.SourcesDirectory)/${{ project.path }}" --device=packaged --binlog="$(Build.SourcesDirectory)/artifacts/log/Debug" --configuration=Release --packageid=${{ project.packageId }} --verbosity=diagnostic
              displayName: Build ${{ project.name }} (Windows Packaged)
              retryCountOnTaskFailure: 1

          # Build Unpackaged tests (self-contained .exe for direct execution)
          - ${{ each project in parameters.windowsDeviceTestProjects }}:
            - script: dotnet cake eng/devices/windows.cake --target=buildOnly --project="$(Build.SourcesDirectory)/${{ project.path }}" --device=unpackaged --binlog="$(Build.SourcesDirectory)/artifacts/log/Debug" --configuration=Release --packageid=${{ project.packageId }} --verbosity=diagnostic
              displayName: Build ${{ project.name }} (Windows Unpackaged)
              retryCountOnTaskFailure: 1

          # Create zip archives for each device test project
          # Include both packaged (AppPackages with MSIX) and unpackaged (publish folder with .exe)
          - pwsh: |
              # Ensure artifacts/bin directory exists
              $artifactsDir = "$(Build.SourcesDirectory)/artifacts/bin"
              New-Item -ItemType Directory -Force -Path $artifactsDir | Out-Null
              
              # Project configurations with artifact bin paths
              $projects = @(
                @{ Name = "Controls.DeviceTests"; ProjectDir = "$(Build.SourcesDirectory)/src/Controls/tests/DeviceTests"; ArtifactDir = "$(Build.SourcesDirectory)/artifacts/bin/Controls.DeviceTests" },
                @{ Name = "Core.DeviceTests"; ProjectDir = "$(Build.SourcesDirectory)/src/Core/tests/DeviceTests"; ArtifactDir = "$(Build.SourcesDirectory)/artifacts/bin/Core.DeviceTests" },
                @{ Name = "Graphics.DeviceTests"; ProjectDir = "$(Build.SourcesDirectory)/src/Graphics/tests/DeviceTests"; ArtifactDir = "$(Build.SourcesDirectory)/artifacts/bin/Graphics.DeviceTests" },
                @{ Name = "Essentials.DeviceTests"; ProjectDir = "$(Build.SourcesDirectory)/src/Essentials/test/DeviceTests"; ArtifactDir = "$(Build.SourcesDirectory)/artifacts/bin/Essentials.DeviceTests" },
                @{ Name = "MauiBlazorWebView.DeviceTests"; ProjectDir = "$(Build.SourcesDirectory)/src/BlazorWebView/tests/DeviceTests"; ArtifactDir = "$(Build.SourcesDirectory)/artifacts/bin/MauiBlazorWebView.DeviceTests" }
              )
              
              foreach ($project in $projects) {
                $appPackagesDir = "$($project.ProjectDir)/AppPackages"
                $zipPath = "$artifactsDir/$($project.Name).zip"
                
                # Create a temp folder to consolidate packaged and unpackaged outputs
                $tempDir = "$artifactsDir/temp_$($project.Name)"
                New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
                
                $hasContent = $false
                
                # Copy packaged output (AppPackages with MSIX)
                if (Test-Path $appPackagesDir) {
                  Write-Host "Copying packaged output from $appPackagesDir..."
                  Copy-Item -Path $appPackagesDir -Destination "$tempDir/AppPackages" -Recurse
                  $msix = Get-ChildItem -Path "$tempDir/AppPackages" -Recurse -Filter "*.msix" | Select-Object -First 1
                  if ($msix) { 
                    Write-Host "  Contains MSIX: $($msix.Name)" 
                    $hasContent = $true
                  }
                } else {
                  Write-Host "Warning: AppPackages not found at $appPackagesDir"
                }
                
                # Copy unpackaged output (publish folder with .exe)
                # Look for publish folder in artifacts/bin - the dotnet publish output location
                $publishDir = Get-ChildItem -Path "$($project.ArtifactDir)" -Filter "publish" -Recurse -Directory | Select-Object -First 1
                if ($publishDir) {
                  Write-Host "Copying unpackaged output from $($publishDir.FullName)..."
                  Copy-Item -Path $publishDir.FullName -Destination "$tempDir/Unpackaged" -Recurse
                  $exe = Get-ChildItem -Path "$tempDir/Unpackaged" -Filter "*.exe" | Where-Object { $_.Name -like "Microsoft.Maui.*" } | Select-Object -First 1
                  if ($exe) { 
                    Write-Host "  Contains EXE: $($exe.Name)"
                    $hasContent = $true
                  }
                  
                  # DIAGNOSTIC: Check for Windows App SDK DLLs (indicates WindowsAppSDKSelfContained=true was applied)
                  Write-Host "  DIAGNOSTIC: Checking for Windows App SDK DLLs in publish output..."
                  $wasdk = Get-ChildItem -Path "$tempDir/Unpackaged" -Filter "Microsoft.WindowsAppRuntime*.dll" 2>$null
                  if ($wasdk) {
                    Write-Host "  OK: Found $($wasdk.Count) Windows App SDK DLLs:"
                    $wasdk | ForEach-Object { Write-Host "    - $($_.Name)" }
                  } else {
                    Write-Host "  WARNING: No Microsoft.WindowsAppRuntime DLLs found!"
                    Write-Host "  This indicates WindowsAppSDKSelfContained may not have been applied during build."
                    Write-Host "  Listing all DLLs in output:"
                    Get-ChildItem -Path "$tempDir/Unpackaged" -Filter "*.dll" | Select-Object -First 20 | ForEach-Object { Write-Host "    - $($_.Name)" }
                  }
                  
                  # CRITICAL DIAGNOSTIC: Check for Microsoft.ui.xaml.dll (the main WinUI3 native DLL)
                  # Use -Recurse to check subdirectories too
                  $winui = Get-ChildItem -Path "$tempDir/Unpackaged" -Filter "Microsoft.ui.xaml.dll" -Recurse 2>$null
                  if ($winui) {
                    Write-Host "  CRITICAL OK: Found Microsoft.ui.xaml.dll at $($winui.FullName)"
                  } else {
                    Write-Host "  CRITICAL WARNING: Microsoft.ui.xaml.dll NOT found!"
                    Write-Host "  This is the native WinUI3 DLL. Without it, the app will crash with 0xC000027B."
                    Write-Host "  Total DLL count (recursive): $($(Get-ChildItem -Path "$tempDir/Unpackaged" -Filter "*.dll" -Recurse 2>$null).Count)"
                    Write-Host "  Directory structure:"
                    Get-ChildItem -Path "$tempDir/Unpackaged" -Directory 2>$null | ForEach-Object { Write-Host "    - $($_.Name)/" }
                  }
                } else {
                  Write-Host "Warning: Publish folder not found in $($project.ArtifactDir)"
                  # List what's in the artifact dir to debug
                  Get-ChildItem -Path "$($project.ArtifactDir)" -Recurse -Depth 3 2>$null | ForEach-Object { Write-Host "  Found: $($_.FullName)" }
                }
                
                if ($hasContent) {
                  # Count total files before archive
                  $totalFiles = (Get-ChildItem -Path "$tempDir" -Recurse -File).Count
                  Write-Host "Total files to archive: $totalFiles"
                  
                  Write-Host "Creating archive $zipPath..."
                  Compress-Archive -Path "$tempDir/*" -DestinationPath $zipPath -Force
                  
                  # Report archive size
                  $archiveSize = (Get-Item $zipPath).Length
                  Write-Host "Created $zipPath - Size: $([math]::Round($archiveSize / 1MB, 2)) MB"
                } else {
                  Write-Host "ERROR: No content found for $($project.Name)"
                }
                
                # Cleanup temp folder
                Remove-Item -Path $tempDir -Recurse -Force
              }
            displayName: Create payload archives

          - publish: ${{ parameters.checkoutDirectory }}/artifacts/bin
            displayName: Publish Succeeded Artifacts Directory
            condition: succeeded()
            artifact: ${{ parameters.appArtifactName }}_windows

          - publish: ${{ parameters.checkoutDirectory }}/artifacts/bin
            displayName: Publish Failed Artifacts Directory
            condition: not(succeeded())
            artifact: ${{ parameters.appArtifactName }}_windows_failed_$(System.JobAttempt)

  - stage: devicetests_windows
    displayName: ${{ parameters.TargetFrameworkVersion }} Windows Helix Tests
    dependsOn: 
      - devicetests_build_windows
    jobs:
    - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/jobs/jobs.yml', '/eng/common/templates-official/jobs/jobs.yml@self') }}
      parameters:
        helixRepo: dotnet/maui
        pool: ${{ parameters.windowsTestPool }}
        enableMicrobuild: ${{ parameters.enableMicrobuild }}
        enablePublishUsingPipelines: true
        enablePublishBuildAssets: ${{ parameters.publishAssets }}
        enableTelemetry: true
        enableSourceBuild: ${{ parameters.enableSourceBuild }}
        enableSourceIndex: ${{ parameters.enableSourceIndex }}
        sourceIndexParams: ${{ parameters.sourceIndexParams }}
        publishAssetsImmediately: true
        enablePublishBuildArtifacts: true
        enablePublishTestResults: false
        workspace:
          clean: all
        jobs:
        - job: device_tests_windows
          displayName: Run DeviceTests Windows
          timeoutInMinutes: 240
          variables:
          - name: _BuildConfig
            value: Debug
          preSteps:
          - checkout: self
            fetchDepth: 1
            clean: true

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build'
            condition: succeeded()
            inputs:
              artifactName: ${{ parameters.appArtifactName }}_windows
              targetPath: ${{ parameters.checkoutDirectory }}/artifacts/bin

          - template: ${{ iif(eq(parameters.runAsPublic, 'true'), '/eng/common/templates/steps/send-to-helix.yml', '/eng/common/templates-official/steps/send-to-helix.yml@self') }}
            parameters:
              HelixProjectPath: ${{ parameters.helixProject }}
              HelixProjectArguments: /p:TargetOS=windows /p:TestRunNameSuffix=_$(_BuildConfig) /p:TestRunNamePrefix=DeviceTestsWindows_
              HelixConfiguration: $(_BuildConfig)
              IncludeDotNetCli: true
              DisplayNamePrefix: DeviceTestsWindows
              WorkItemTimeout: 04:00:00

  # Windows Unpackaged Tests - Now running on Helix (re-enabled in helix_xharness.proj)
  # The Cake-based stage below is kept as fallback but commented out
  # Uncomment this if Helix unpackaged tests fail and we need to fall back to Cake
  # - ${{ if eq(parameters.runWindowsTests, true) }}:
  #   - stage: devicetests_windows_unpackaged
  #     displayName: ${{ parameters.TargetFrameworkVersion }} Windows Unpackaged Tests (Cake)
  #     dependsOn: []
  #     jobs:
  #     - template: /eng/pipelines/common/device-tests-jobs.yml@self
  #       parameters:
  #         platform: windows
  #         timeoutInMinutes: 240
  #         pool: ${{ parameters.windowsTestPool }}
  #         versions: [ 'unpackaged' ]
  #         targetFrameworkVersion:
  #           tfm: ${{ parameters.TargetFrameworkVersion }}
  #           dependsOn: ''
  #         project:
  #           name: essentials_unpackaged
  #           desc: Essentials unpackaged
  #           path: $(System.DefaultWorkingDirectory)/src/Essentials/test/DeviceTests/Essentials.DeviceTests.csproj
  #           packageid: com.microsoft.maui.essentials.devicetests
  #           configuration: Debug
  #         skipProvisioning: true
  #     - template: /eng/pipelines/common/device-tests-jobs.yml@self
  #       parameters:
  #         platform: windows
  #         timeoutInMinutes: 240
  #         pool: ${{ parameters.windowsTestPool }}
  #         versions: [ 'unpackaged' ]
  #         targetFrameworkVersion:
  #           tfm: ${{ parameters.TargetFrameworkVersion }}
  #           dependsOn: ''
  #         project:
  #           name: graphics_unpackaged
  #           desc: Graphics unpackaged
  #           path: $(System.DefaultWorkingDirectory)/src/Graphics/tests/DeviceTests/Graphics.DeviceTests.csproj
  #           packageid: com.microsoft.maui.graphics.devicetests
  #           configuration: Debug
  #         skipProvisioning: true
  #     - template: /eng/pipelines/common/device-tests-jobs.yml@self
  #       parameters:
  #         platform: windows
  #         timeoutInMinutes: 240
  #         pool: ${{ parameters.windowsTestPool }}
  #         versions: [ 'unpackaged' ]
  #         targetFrameworkVersion:
  #           tfm: ${{ parameters.TargetFrameworkVersion }}
  #           dependsOn: ''
  #         project:
  #           name: core_unpackaged
  #           desc: Core unpackaged
  #           path: $(System.DefaultWorkingDirectory)/src/Core/tests/DeviceTests/Core.DeviceTests.csproj
  #           packageid: com.microsoft.maui.core.devicetests
  #           configuration: Debug
  #         skipProvisioning: true
  #     - template: /eng/pipelines/common/device-tests-jobs.yml@self
  #       parameters:
  #         platform: windows
  #         timeoutInMinutes: 240
  #         pool: ${{ parameters.windowsTestPool }}
  #         versions: [ 'unpackaged' ]
  #         targetFrameworkVersion:
  #           tfm: ${{ parameters.TargetFrameworkVersion }}
  #           dependsOn: ''
  #         project:
  #           name: controls_unpackaged
  #           desc: Controls unpackaged
  #           path: $(System.DefaultWorkingDirectory)/src/Controls/tests/DeviceTests/Controls.DeviceTests.csproj
  #           packageid: com.microsoft.maui.controls.devicetests
  #           configuration: Debug
  #         skipProvisioning: true
  #     - template: /eng/pipelines/common/device-tests-jobs.yml@self
  #       parameters:
  #         platform: windows
  #         timeoutInMinutes: 240
  #         pool: ${{ parameters.windowsTestPool }}
  #         versions: [ 'unpackaged' ]
  #         targetFrameworkVersion:
  #           tfm: ${{ parameters.TargetFrameworkVersion }}
  #           dependsOn: ''
  #         project:
  #           name: blazorwebview_unpackaged
  #           desc: BlazorWebView unpackaged
  #           path: $(System.DefaultWorkingDirectory)/src/BlazorWebView/tests/DeviceTests/MauiBlazorWebView.DeviceTests.csproj
  #           packageid: Microsoft.Maui.MauiBlazorWebView.DeviceTests
  #           configuration: Debug
  #         skipProvisioning: true

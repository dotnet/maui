using System;
using System.IO;
using System.Linq;
using Xunit;

namespace Microsoft.Maui.Controls.SourceGen.UnitTests;

public class SimplifyOnPlatform : SourceGenXamlInitializeComponentTestBase
{
	[Fact]
	public void SimplifyOnPlatformMarkupExtension()
	{
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage">
    <ContentPage.Resources>
        <Style TargetType="Label" x:Key="style">
            <Setter Property="TextColor" Value="Pink " />
            <Setter Property="IsVisible" Value="{OnPlatform Android=True, iOS=False}" />
        </Style>
    </ContentPage.Resources>
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var testXamlFilePath = Path.Combine(Environment.CurrentDirectory, "Test.xaml");
		var expected = $$"""
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a .NET MAUI source generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable

namespace Test;

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Maui.Controls.SourceGen, Version=10.0.0.0, Culture=neutral, PublicKeyToken=null", "10.0.0.0")]
public partial class TestPage
{
	private partial void InitializeComponent()
	{
		// Fallback to Runtime inflation if the page was updated by HotReload
		static string? getPathForType(global::System.Type type)
		{
			var assembly = type.Assembly;
			foreach (var xria in global::System.Reflection.CustomAttributeExtensions.GetCustomAttributes<global::Microsoft.Maui.Controls.Xaml.XamlResourceIdAttribute>(assembly))
			{
				if (xria.Type == type)
					return xria.Path;
			}
			return null;
		}

		var rlr = global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceProvider2?.Invoke(new global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceLoadingQuery
		{
			AssemblyName = typeof(global::Test.TestPage).Assembly.GetName(),
			ResourcePath = getPathForType(typeof(global::Test.TestPage)),
			Instance = this,
		});

		if (rlr?.ResourceContent != null)
		{
			this.InitializeComponentRuntime();
			return;
		}

		var setter = new global::Microsoft.Maui.Controls.Setter();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(setter!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 8, 14);
		var setter1 = new global::Microsoft.Maui.Controls.Setter();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(setter1!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 9, 14);
		var style1 = new global::Microsoft.Maui.Controls.Style(typeof(global::Microsoft.Maui.Controls.Label));
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(style1!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 7, 10);
		var __root = this;
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(__root!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 2, 2);
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.INameScope iNameScope = global::Microsoft.Maui.Controls.Internals.NameScope.GetNameScope(__root) ?? new global::Microsoft.Maui.Controls.Internals.NameScope();
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.NameScope.SetNameScope(__root, iNameScope);
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.INameScope iNameScope1 = new global::Microsoft.Maui.Controls.Internals.NameScope();
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.INameScope iNameScope2 = new global::Microsoft.Maui.Controls.Internals.NameScope();
#endif
#line 8 "{{testXamlFilePath}}"
		setter.Property = global::Microsoft.Maui.Controls.Label.TextColorProperty;
#line default
#line 8 "{{testXamlFilePath}}"
		setter.Value = "Pink ";
#line default
		var setter2 = new global::Microsoft.Maui.Controls.Setter {Property = global::Microsoft.Maui.Controls.Label.TextColorProperty, Value = global::Microsoft.Maui.Graphics.Colors.Pink};
		if (global::Microsoft.Maui.VisualDiagnostics.GetSourceInfo(setter2!) == null)
			global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(setter2!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 8, 14);
#line 8 "{{testXamlFilePath}}"
		((global::System.Collections.Generic.ICollection<global::Microsoft.Maui.Controls.Setter>)style1.Setters).Add((global::Microsoft.Maui.Controls.Setter)setter2);
#line default
#line 9 "{{testXamlFilePath}}"
		setter1.Property = global::Microsoft.Maui.Controls.VisualElement.IsVisibleProperty;
#line default
#line 9 "{{testXamlFilePath}}"
		setter1.Value = "True";
#line default
		var setter3 = new global::Microsoft.Maui.Controls.Setter {Property = global::Microsoft.Maui.Controls.VisualElement.IsVisibleProperty, Value = (bool)new global::Microsoft.Maui.Controls.VisualElement.VisibilityConverter().ConvertFromInvariantString("True")!};
		if (global::Microsoft.Maui.VisualDiagnostics.GetSourceInfo(setter3!) == null)
			global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(setter3!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 9, 14);
#line 9 "{{testXamlFilePath}}"
		((global::System.Collections.Generic.ICollection<global::Microsoft.Maui.Controls.Setter>)style1.Setters).Add((global::Microsoft.Maui.Controls.Setter)setter3);
#line default
		__root.Resources["style"] = style1;
	}
}

""";

		var (result, generated) = RunGenerator(xaml, code, targetFramework: "net10.0-android");
		Assert.False(result.Diagnostics.Any());

		Assert.Equal(expected, generated, ignoreLineEndingDifferences: true);
	}

	[Fact]
	public void SimplifyOnPlatformElement()
	{
		// Issue #32521: OnPlatform elements should be simplified at compile time based on target framework
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage">
	<OnPlatform x:TypeArguments="View">
		<On Platform="Android">
			<Label x:Name="AndroidLabel" Text="Android Content" />
		</On>
		<On Platform="iOS">
			<Label x:Name="iOSLabel" Text="iOS Content" />
		</On>
	</OnPlatform>
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var (result, generated) = RunGenerator(xaml, code, targetFramework: "net10.0-android");
		Assert.False(result.Diagnostics.Any());

		// Should contain only Android label, not iOS label
		Assert.Contains("AndroidLabel", generated, StringComparison.Ordinal);
		Assert.DoesNotContain("iOSLabel", generated, StringComparison.Ordinal);
		Assert.Contains("Android Content", generated, StringComparison.Ordinal);
		Assert.DoesNotContain("iOS Content", generated, StringComparison.Ordinal);
	}

	[Fact]
	public void SimplifyOnPlatformWithXKeyAndValueNodeWithoutTypeArguments()
	{
		// OnPlatform with x:Key but WITHOUT x:TypeArguments should NOT be simplified
		// when the target value is a ValueNode, because we don't know how to create the typed element
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage">
	<ContentPage.Resources>
		<OnPlatform x:Key="TestValue">
			<On Platform="Android" Value="10" />
			<On Platform="iOS" Value="20" />
		</OnPlatform>
	</ContentPage.Resources>
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var (result, generated) = RunGenerator(xaml, code, targetFramework: "net10.0-android");
		Assert.False(result.Diagnostics.Any());

		// OnPlatform should NOT be simplified because there's no x:TypeArguments and the target is a ValueNode
		Assert.Contains("OnPlatform", generated, StringComparison.Ordinal);
	}

	[Fact]
	public void SimplifyOnPlatformWithXKeyAndXTypeArguments()
	{
		// OnPlatform with x:Key and x:TypeArguments should be simplified by creating a typed element
		// For example, OnPlatform with x:TypeArguments="Color" should become <Color x:Key="TestColor">Red</Color>
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage">
	<ContentPage.Resources>
		<OnPlatform x:Key="TestColor" x:TypeArguments="Color">
			<On Platform="Android" Value="Red" />
			<On Platform="iOS" Value="Blue" />
		</OnPlatform>
	</ContentPage.Resources>
	<Label Text="Test" TextColor="{StaticResource TestColor}" />
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var (result, generated) = RunGenerator(xaml, code, targetFramework: "net10.0-android");
		Assert.False(result.Diagnostics.Any());

		// OnPlatform SHOULD be simplified because x:TypeArguments tells us how to create a proper typed element
		Assert.DoesNotContain("OnPlatform", generated, StringComparison.Ordinal);
		Assert.Contains("TestColor", generated, StringComparison.Ordinal);
		// Should contain Red (Android), not Blue (iOS)
		Assert.Contains("Red", generated, StringComparison.Ordinal);
		Assert.DoesNotContain("Blue", generated, StringComparison.Ordinal);

		// Verify the generated code creates a Color object directly
		Assert.Contains("Colors.Red", generated, StringComparison.Ordinal);
	}

	[Fact]
	public void SimplifyOnPlatformWithXKeyAndElementNode()
	{
		// OnPlatform with x:Key should be simplified if the target value is an ElementNode
		// and the x:Key should be transferred to the replacement element
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage">
	<ContentPage.Resources>
		<OnPlatform x:Key="TestStyle" x:TypeArguments="Style">
			<On Platform="Android">
				<Style TargetType="Label">
					<Setter Property="TextColor" Value="Red" />
				</Style>
			</On>
			<On Platform="iOS">
				<Style TargetType="Label">
					<Setter Property="TextColor" Value="Blue" />
				</Style>
			</On>
		</OnPlatform>
	</ContentPage.Resources>
	<Label Text="Test" Style="{StaticResource TestStyle}" />
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var (result, generated) = RunGenerator(xaml, code, targetFramework: "net10.0-android");
		Assert.False(result.Diagnostics.Any());

		// OnPlatform should be simplified and the x:Key transferred to the Style element
		Assert.DoesNotContain("OnPlatform", generated, StringComparison.Ordinal);
		Assert.Contains("TestStyle", generated, StringComparison.Ordinal);
		// Should contain Android style (Red), not iOS style (Blue)
		Assert.Contains("Red", generated, StringComparison.Ordinal);
		Assert.DoesNotContain("Blue", generated, StringComparison.Ordinal);
	}

	[Fact]
	public void OnPlatformWithMissingTargetPlatformShouldUseDefault()
	{
		// Reproduces Bugzilla39636: When MacCatalyst is not defined in OnPlatform,
		// SourceGen should use default(T) instead of throwing an exception
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage">
	<ContentPage.Resources>
		<OnPlatform x:Key="SizeMedium" x:TypeArguments="x:Double">
			<On Platform="iOS" Value="40"/>
			<On Platform="Android" Value="30"/>
			<On Platform="UWP" Value="60"/>
		</OnPlatform>
	</ContentPage.Resources>
	<Label Text="Test" WidthRequest="{StaticResource SizeMedium}" />
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		// Test with MacCatalyst where platform is not defined
		var (result, generated) = RunGenerator(xaml, code, targetFramework: "net10.0-maccatalyst");
		
		// Should not have any errors (no TargetInvocationException)
		Assert.False(result.Diagnostics.Any(d => d.Severity == Microsoft.CodeAnalysis.DiagnosticSeverity.Error));

		// Should generate code that creates the resource with default value
		// The resource key should still be present
		Assert.Contains("SizeMedium", generated, StringComparison.Ordinal);
		
		// The OnPlatform should be simplified to a default Double value
		Assert.DoesNotContain("OnPlatform", generated, StringComparison.Ordinal);
	}
}
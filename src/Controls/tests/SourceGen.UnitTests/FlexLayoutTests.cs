using System;
using System.Globalization;
using System.IO;
using Microsoft.CodeAnalysis;
using System.Linq;
using Xunit;

namespace Microsoft.Maui.Controls.SourceGen.UnitTests
{
	public class FlexLayoutTests : SourceGenXamlInitializeComponentTestBase
	{
		[Fact]
		public void FlexLayout_BasisWithPercentage_GeneratesCorrectFlexBasis()
		{
			const string xaml = """
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
		xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
		xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
		x:Class="Test.TestPage">
	<FlexLayout>
		<Label Text="Test" FlexLayout.Basis="33%" />
	</FlexLayout>
</ContentPage>
""";

			const string code = """
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

			var testXamlFilePath = Path.Combine(Environment.CurrentDirectory, "Test.xaml");
			var expected = $$"""
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a .NET MAUI source generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable

namespace Test;

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Maui.Controls.SourceGen, Version=10.0.0.0, Culture=neutral, PublicKeyToken=null", "10.0.0.0")]
public partial class TestPage
{
	private partial void InitializeComponent()
	{
		// Fallback to Runtime inflation if the page was updated by HotReload
		static string? getPathForType(global::System.Type type)
	{
			var assembly = type.Assembly;
			foreach (var xria in global::System.Reflection.CustomAttributeExtensions.GetCustomAttributes<global::Microsoft.Maui.Controls.Xaml.XamlResourceIdAttribute>(assembly))
	{
				if (xria.Type == type)
					return xria.Path;
	}
			return null;
	}

		var rlr = global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceProvider2?.Invoke(new global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceLoadingQuery
	{
			AssemblyName = typeof(global::Test.TestPage).Assembly.GetName(),
			ResourcePath = getPathForType(typeof(global::Test.TestPage)),
			Instance = this,
		});

		if (rlr?.ResourceContent != null)
	{
			this.InitializeComponentRuntime();
			return;
	}

		var label = new global::Microsoft.Maui.Controls.Label();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(label!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 7, 4);
		var flexLayout = new global::Microsoft.Maui.Controls.FlexLayout();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(flexLayout!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 6, 3);
		var __root = this;
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(__root!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 2, 2);
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.INameScope iNameScope = global::Microsoft.Maui.Controls.Internals.NameScope.GetNameScope(__root) ?? new global::Microsoft.Maui.Controls.Internals.NameScope();
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.NameScope.SetNameScope(__root, iNameScope);
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		flexLayout.transientNamescope = iNameScope;
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		label.transientNamescope = iNameScope;
#endif
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.Label.TextProperty, "Test");
#line default
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.FlexLayout.BasisProperty, new global::Microsoft.Maui.Layouts.FlexBasis(0.33f, true));
#line default
#line 7 "{{testXamlFilePath}}"
		((global::System.Collections.Generic.ICollection<global::Microsoft.Maui.IView>)flexLayout.Children).Add((global::Microsoft.Maui.IView)label);
#line default
#line 6 "{{testXamlFilePath}}"
		__root.SetValue(global::Microsoft.Maui.Controls.ContentPage.ContentProperty, flexLayout);
#line default
	}
}

""";

			var (result, generated) = RunGenerator(xaml, code);

			Assert.False(result.Diagnostics.Any(d => d.Severity == DiagnosticSeverity.Error),
			$"Generated code should not have errors. Diagnostics: {string.Join(", ", result.Diagnostics.Select(d => d.ToString()))}");

			Assert.NotNull(generated);
			Assert.Equal(expected, generated, ignoreLineEndingDifferences: true);
		}

		[Theory]
		[InlineData("en-US", "0.33")]
		[InlineData("fr-FR", "0.5")]
		[InlineData("de-DE", "0.75")]
		public void FlexLayout_BasisWithDecimal_GeneratesFloatWithCorrectFormat(string cultureName, string basisValue)
		{
			// Set culture to test locale-independent generation
			System.Threading.Thread.CurrentThread.CurrentCulture = CultureInfo.GetCultureInfo(cultureName);
			System.Threading.Thread.CurrentThread.CurrentUICulture = CultureInfo.GetCultureInfo(cultureName);

			var xaml = $@"<?xml version=""1.0"" encoding=""UTF-8""?>
<ContentPage
		xmlns=""http://schemas.microsoft.com/dotnet/2021/maui""
		xmlns:x=""http://schemas.microsoft.com/winfx/2009/xaml""
		x:Class=""Test.TestPage"">
	<FlexLayout>
		<Label Text=""Test"" FlexLayout.Basis=""{basisValue}"" />
	</FlexLayout>
</ContentPage>";

			const string code = """
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

			var testXamlFilePath = Path.Combine(Environment.CurrentDirectory, "Test.xaml");
			var expected = $$"""
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a .NET MAUI source generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable

namespace Test;

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Maui.Controls.SourceGen, Version=10.0.0.0, Culture=neutral, PublicKeyToken=null", "10.0.0.0")]
public partial class TestPage
{
	private partial void InitializeComponent()
	{
		// Fallback to Runtime inflation if the page was updated by HotReload
		static string? getPathForType(global::System.Type type)
	{
			var assembly = type.Assembly;
			foreach (var xria in global::System.Reflection.CustomAttributeExtensions.GetCustomAttributes<global::Microsoft.Maui.Controls.Xaml.XamlResourceIdAttribute>(assembly))
	{
				if (xria.Type == type)
					return xria.Path;
	}
			return null;
	}

		var rlr = global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceProvider2?.Invoke(new global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceLoadingQuery
	{
			AssemblyName = typeof(global::Test.TestPage).Assembly.GetName(),
			ResourcePath = getPathForType(typeof(global::Test.TestPage)),
			Instance = this,
		});

		if (rlr?.ResourceContent != null)
	{
			this.InitializeComponentRuntime();
			return;
	}

		var label = new global::Microsoft.Maui.Controls.Label();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(label!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 7, 4);
		var flexLayout = new global::Microsoft.Maui.Controls.FlexLayout();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(flexLayout!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 6, 3);
		var __root = this;
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(__root!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 2, 2);
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.INameScope iNameScope = global::Microsoft.Maui.Controls.Internals.NameScope.GetNameScope(__root) ?? new global::Microsoft.Maui.Controls.Internals.NameScope();
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.NameScope.SetNameScope(__root, iNameScope);
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		flexLayout.transientNamescope = iNameScope;
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		label.transientNamescope = iNameScope;
#endif
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.Label.TextProperty, "Test");
#line default
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.FlexLayout.BasisProperty, new global::Microsoft.Maui.Layouts.FlexBasis({{basisValue}}f, false));
#line default
#line 7 "{{testXamlFilePath}}"
		((global::System.Collections.Generic.ICollection<global::Microsoft.Maui.IView>)flexLayout.Children).Add((global::Microsoft.Maui.IView)label);
#line default
#line 6 "{{testXamlFilePath}}"
		__root.SetValue(global::Microsoft.Maui.Controls.ContentPage.ContentProperty, flexLayout);
#line default
	}
}

""";

			var (result, generated) = RunGenerator(xaml, code);

			Assert.False(result.Diagnostics.Any(d => d.Severity == DiagnosticSeverity.Error),
			$"Generated code should not have errors. Diagnostics: {string.Join(", ", result.Diagnostics.Select(d => d.ToString()))}");

			Assert.NotNull(generated);
			Assert.Equal(expected, generated, ignoreLineEndingDifferences: true);
		}

		[Fact]
		public void FlexLayout_GrowAndShrink_GeneratesFloatValues()
		{
			const string xaml = """
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
x:Class="Test.TestPage">
<FlexLayout>
<Label Text="Test" FlexLayout.Grow="1.5" FlexLayout.Shrink="0.75" />
</FlexLayout>
</ContentPage>
""";

			const string code = """
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
	{
public TestPage()
	{
InitializeComponent();
	}
	}
""";

			var testXamlFilePath = Path.Combine(Environment.CurrentDirectory, "Test.xaml");
			var expected = $$"""
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a .NET MAUI source generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable

namespace Test;

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Maui.Controls.SourceGen, Version=10.0.0.0, Culture=neutral, PublicKeyToken=null", "10.0.0.0")]
public partial class TestPage
{
	private partial void InitializeComponent()
	{
		// Fallback to Runtime inflation if the page was updated by HotReload
		static string? getPathForType(global::System.Type type)
	{
			var assembly = type.Assembly;
			foreach (var xria in global::System.Reflection.CustomAttributeExtensions.GetCustomAttributes<global::Microsoft.Maui.Controls.Xaml.XamlResourceIdAttribute>(assembly))
	{
				if (xria.Type == type)
					return xria.Path;
	}
			return null;
	}

		var rlr = global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceProvider2?.Invoke(new global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceLoadingQuery
	{
			AssemblyName = typeof(global::Test.TestPage).Assembly.GetName(),
			ResourcePath = getPathForType(typeof(global::Test.TestPage)),
			Instance = this,
		});

		if (rlr?.ResourceContent != null)
	{
			this.InitializeComponentRuntime();
			return;
	}

		var label = new global::Microsoft.Maui.Controls.Label();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(label!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 7, 4);
		var flexLayout = new global::Microsoft.Maui.Controls.FlexLayout();
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(flexLayout!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 6, 3);
		var __root = this;
		global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(__root!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 2, 2);
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.INameScope iNameScope = global::Microsoft.Maui.Controls.Internals.NameScope.GetNameScope(__root) ?? new global::Microsoft.Maui.Controls.Internals.NameScope();
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		global::Microsoft.Maui.Controls.Internals.NameScope.SetNameScope(__root, iNameScope);
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		flexLayout.transientNamescope = iNameScope;
#endif
#if !_MAUIXAML_SG_NAMESCOPE_DISABLE
		label.transientNamescope = iNameScope;
#endif
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.Label.TextProperty, "Test");
#line default
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.FlexLayout.GrowProperty, 1.5F);
#line default
#line 7 "{{testXamlFilePath}}"
		label.SetValue(global::Microsoft.Maui.Controls.FlexLayout.ShrinkProperty, 0.75F);
#line default
#line 7 "{{testXamlFilePath}}"
		((global::System.Collections.Generic.ICollection<global::Microsoft.Maui.IView>)flexLayout.Children).Add((global::Microsoft.Maui.IView)label);
#line default
#line 6 "{{testXamlFilePath}}"
		__root.SetValue(global::Microsoft.Maui.Controls.ContentPage.ContentProperty, flexLayout);
#line default
	}
}

""";

			var (result, generated) = RunGenerator(xaml, code);

			Assert.False(result.Diagnostics.Any(d => d.Severity == DiagnosticSeverity.Error),
			$"Generated code should not have errors. Diagnostics: {string.Join(", ", result.Diagnostics.Select(d => d.ToString()))}");

			Assert.NotNull(generated);
			Assert.Equal(expected, generated, ignoreLineEndingDifferences: true);
		}
	}
}

using System;
using Microsoft.CodeAnalysis;
using Microsoft.Maui.Controls.BindingSourceGen;
using Xunit;

namespace BindingSourceGen.UnitTests;

public class RelayCommandTests
{
	[Fact]
	public void GenerateBindingToRelayCommandProperty()
	{
		var source = """
			using Microsoft.Maui.Controls;
			using System.Threading.Tasks;

			namespace System.Windows.Input
			{
				// Define ICommand for test purposes
				public interface ICommand
				{
					event System.EventHandler CanExecuteChanged;
					bool CanExecute(object parameter);
					void Execute(object parameter);
				}
			}

			namespace CommunityToolkit.Mvvm.Input
			{
				// Simulating the CommunityToolkit.Mvvm RelayCommand attribute
				[System.AttributeUsage(System.AttributeTargets.Method)]
				public class RelayCommandAttribute : System.Attribute { }
			}

			namespace TestApp
			{
				public class MyViewModel
				{
					[CommunityToolkit.Mvvm.Input.RelayCommand]
					private void Save()
					{
						// SaveCommand property will be generated by CommunityToolkit.Mvvm source generator
					}
				}

				public class TestCode
				{
					public void Test()
					{
						var label = new Label();
						label.SetBinding(Label.TextProperty, static (MyViewModel vm) => vm.SaveCommand);
					}
				}
			}
			""";

		var result = SourceGenHelpers.Run(source);
		
		// Debug: Check diagnostics
		var allDiagnostics = result.SourceCompilationDiagnostics
			.Concat(result.SourceGeneratorDiagnostics)
			.Concat(result.GeneratedCodeCompilationDiagnostics)
			.Where(d => d.Severity == DiagnosticSeverity.Error);
		
		var diagnosticMessages = string.Join("\n", allDiagnostics.Select(d => $"{d.Id}: {d.GetMessage()}"));
		
		// The binding should be generated without errors
		Assert.True(result.Binding != null, $"Binding is null. Diagnostics: {diagnosticMessages}");
		AssertExtensions.AssertNoDiagnostics(result);
		
		// Verify the generated code contains a reference to SaveCommand
		var generatedCode = result.GeneratedFiles.Values.FirstOrDefault();
		Assert.NotNull(generatedCode);
		Assert.Contains("SaveCommand", generatedCode, StringComparison.Ordinal);
	}

	[Fact]
	public void GenerateBindingToAsyncRelayCommandProperty()
	{
		var source = """
			using Microsoft.Maui.Controls;
			using System.Threading.Tasks;
			using System.Windows.Input;

			namespace CommunityToolkit.Mvvm.Input
			{
				// Simulating the CommunityToolkit.Mvvm RelayCommand attribute
				[System.AttributeUsage(System.AttributeTargets.Method)]
				public class RelayCommandAttribute : System.Attribute { }
			}

			namespace TestApp
			{
				public class MyViewModel
				{
					[CommunityToolkit.Mvvm.Input.RelayCommand]
					private async Task SaveAsync()
					{
						// SaveAsyncCommand property will be generated by CommunityToolkit.Mvvm source generator
						await Task.CompletedTask;
					}
				}

				public class TestCode
				{
					public void Test()
					{
						var button = new Button();
						button.SetBinding(Button.CommandProperty, static (MyViewModel vm) => vm.SaveAsyncCommand);
					}
				}
			}
			""";

		var result = SourceGenHelpers.Run(source);
		
		// The binding should be generated without errors
		Assert.NotNull(result.Binding);
		AssertExtensions.AssertNoDiagnostics(result);
		
		// Verify the generated code contains a reference to SaveAsyncCommand
		var generatedCode = result.GeneratedFiles.Values.FirstOrDefault();
		Assert.NotNull(generatedCode);
		Assert.Contains("SaveAsyncCommand", generatedCode, StringComparison.Ordinal);
	}

	[Fact]
	public void GenerateBindingToRelayCommandWithParameters()
	{
		var source = """
			using Microsoft.Maui.Controls;
			using System.Threading.Tasks;
			using System.Windows.Input;

			namespace CommunityToolkit.Mvvm.Input
			{
				// Simulating the CommunityToolkit.Mvvm RelayCommand attribute
				[System.AttributeUsage(System.AttributeTargets.Method)]
				public class RelayCommandAttribute : System.Attribute { }
			}

			namespace TestApp
			{
				public class MyViewModel
				{
					[CommunityToolkit.Mvvm.Input.RelayCommand]
					private void Delete(string id)
					{
						// DeleteCommand property will be generated by CommunityToolkit.Mvvm source generator
					}
				}

				public class TestCode
				{
					public void Test()
					{
						var button = new Button();
						button.SetBinding(Button.CommandProperty, static (MyViewModel vm) => vm.DeleteCommand);
					}
				}
			}
			""";

		var result = SourceGenHelpers.Run(source);
		
		// The binding should be generated without errors
		Assert.NotNull(result.Binding);
		AssertExtensions.AssertNoDiagnostics(result);
		
		// Verify the generated code contains a reference to DeleteCommand
		var generatedCode = result.GeneratedFiles.Values.FirstOrDefault();
		Assert.NotNull(generatedCode);
		Assert.Contains("DeleteCommand", generatedCode, StringComparison.Ordinal);
	}

	[Fact]
	public void FailWhenCommandPropertyWithoutRelayCommandAttribute()
	{
		var source = """
			using Microsoft.Maui.Controls;
			using System.Threading.Tasks;
			using System.Windows.Input;

			namespace TestApp
			{
				public class MyViewModel
				{
					// No [RelayCommand] attribute
					private void Save()
					{
					}
				}

				public class TestCode
				{
					public void Test()
					{
						var label = new Label();
						label.SetBinding(Label.TextProperty, static (MyViewModel vm) => vm.SaveCommand);
					}
				}
			}
			""";

		var result = SourceGenHelpers.Run(source);
		
		// The binding should fail because SaveCommand doesn't exist and Save doesn't have [RelayCommand]
		// We expect a diagnostic about unable to resolve path
		Assert.NotEmpty(result.SourceGeneratorDiagnostics.Concat(result.GeneratedCodeCompilationDiagnostics));
	}
}

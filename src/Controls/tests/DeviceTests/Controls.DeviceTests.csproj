<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>$(MauiDeviceTestsPlatforms)</TargetFrameworks>
    <OutputType>Exe</OutputType>
    <SingleProject>true</SingleProject>
    <MauiTestProject>true</MauiTestProject>
    <RootNamespace>Microsoft.Maui.DeviceTests</RootNamespace>
    <AssemblyName>Microsoft.Maui.Controls.DeviceTests</AssemblyName>
    <NoWarn>$(NoWarn),CA1416</NoWarn>
    <IsTestProject>true</IsTestProject>
    <!-- Disable multi-RID builds to workaround a parallel build issue -->
    <RuntimeIdentifier Condition="$(TargetFramework.Contains('-maccatalyst'))">maccatalyst-x64</RuntimeIdentifier>
    <RuntimeIdentifier Condition="$(TargetFramework.Contains('-maccatalyst')) and '$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'arm64'">maccatalyst-arm64</RuntimeIdentifier>
    <RuntimeIdentifiers Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'android'">android-arm64;android-x64</RuntimeIdentifiers>
    <IsTestProject>true</IsTestProject>
    <ExcludeMicrosoftNetTestSdk>true</ExcludeMicrosoftNetTestSdk>
    <!--
      WindowsAppSDKSelfContained bundles the Windows App SDK DLLs with the app instead of
      relying on the installed runtime. This is REQUIRED for unpackaged builds on Helix
      because the Windows App SDK runtime may not be installed, causing exit code 0xC000027B
      (Windows App SDK bootstrap failure).

      WHY WE USE MauiUnpackagedBuild CONDITION:

      1. Cannot use WindowsPackageType=None condition:
         Although Cake passes WindowsPackageType=None for unpackaged builds, there's an MSBuild
         evaluation timing issue where the property isn't reliably available when this condition
         is evaluated. We tested this and unpackaged builds still crashed with 0xC000027B.

      2. Cannot rely on MAUI SDK automatic defaults (Microsoft.Maui.Sdk.Windows.targets):
         The SDK sets WindowsAppSDKSelfContained=true when WindowsPackageType=None AND
         OutputType=WinExe. However, device test projects have OutputType=Exe which gets
         converted to WinExe by Before.targets AFTER the SDK targets evaluate, so the
         automatic default never kicks in.

      3. Cannot pass WindowsAppSDKSelfContained via MSBuild command line:
         Command-line MSBuild properties propagate to ALL projects in the build graph
         (including library dependencies), causing "WindowsAppSDKSelfContained requires
         a supported Windows architecture" errors on non-app projects.

      SOLUTION: Cake sets MauiUnpackagedBuild=true ONLY for unpackaged builds. This property
      is reliably available at evaluation time because it's passed via command line (and doesn't
      cause errors when propagated because it's just a flag, not a functional property).
      This ensures WindowsAppSDKSelfContained=true only applies to unpackaged builds, keeping
      packaged MSIX builds framework-dependent (smaller, uses installed Windows App SDK).
    -->
    <WindowsAppSDKSelfContained Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'windows' and '$(MauiUnpackagedBuild)' == 'true'">true</WindowsAppSDKSelfContained>
  </PropertyGroup>

  <PropertyGroup>
    <ApplicationTitle>Controls Tests</ApplicationTitle>
    <ApplicationId>com.microsoft.maui.controls.devicetests</ApplicationId>
    <ApplicationVersion>1</ApplicationVersion>
  </PropertyGroup>

  <ItemGroup>
    <MauiImage Include="Resources\Images\*" />
    <MauiImage Include="Resources\Images\white.png" Link="Resources\Images\white_tab.png"  BaseSize="23,23" />
    <MauiImage Remove="Resources\Images\red-embedded.png" />
    <None Remove="Resources\Images\red-embedded.png" />
    <EmbeddedResource Include="Resources\Images\red-embedded.png" LogicalName="red-embedded.png" />
    <MauiIcon Include="Resources\appicon.svg" ForegroundFile="Resources\appiconfg.svg" Color="#512BD4" />
    <MauiSplashScreen Include="Resources\appiconfg.svg" Color="#512BD4" BaseSize="128,128" />

    <!-- Raw Assets for HybridWebView tests (removes the "Resources\Raw" prefix, to mimic what project templates do) -->
    <None Remove="Resources\Raw\**" />
    <MauiAsset Include="Resources\Raw\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />
  </ItemGroup>

  <PropertyGroup>
    <SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'android'">21.0</SupportedOSPlatformVersion>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Core\tests\DeviceTests.Shared\Core.DeviceTests.Shared.csproj" />
    <ProjectReference Include="..\..\..\TestUtils\src\DeviceTests\TestUtils.DeviceTests.csproj" />
    <ProjectReference Include="..\..\..\TestUtils\src\DeviceTests.Runners\TestUtils.DeviceTests.Runners.csproj" />
    <ProjectReference Include="..\..\..\TestUtils\src\DeviceTests.Runners.SourceGen\TestUtils.DeviceTests.Runners.SourceGen.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
    <ProjectReference Include="..\..\..\Core\src\Core.csproj" />
    <ProjectReference Include="..\..\..\Controls\src\Xaml\Controls.Xaml.csproj" />
    <ProjectReference Include="..\..\..\Controls\src\Core\Controls.Core.csproj" />
    <ProjectReference Include="..\..\..\Essentials\src\Essentials.csproj" />
  </ItemGroup>

  <!-- include/exclude the *.<platform>.cs files -->
  <ItemGroup>
    <None Include="@(Compile)" />
  </ItemGroup>
  <ItemGroup Condition="!$(TargetFramework.Contains('-android'))">
    <Compile Remove="**\*.Android.cs" />
  </ItemGroup>
  <ItemGroup Condition="!$(TargetFramework.Contains('-ios')) and !$(TargetFramework.Contains('-maccatalyst'))">
    <Compile Remove="**\*.iOS.cs" />
  </ItemGroup>
  <ItemGroup Condition="!$(TargetFramework.Contains('-windows'))">
    <Compile Remove="**\*.Windows.cs" />
  </ItemGroup>
  <ItemGroup>
    <Compile Update="Xaml\RadioButtonUsing.xaml.cs">
      <DependentUpon>%(Filename)</DependentUpon>
    </Compile>
  </ItemGroup>

  <Import Project="$(MauiSrcDirectory)Maui.InTree.props" Condition=" '$(UseMaui)' != 'true' " />

</Project>

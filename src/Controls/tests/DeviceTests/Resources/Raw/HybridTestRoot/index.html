<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="icon" href="data:,">
    <script src="_framework/hybridwebview.js"></script>

    <!-- test helper functions-->
    <script>

        // an async delay helper function
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

    </script>

    <script>

        window.addEventListener(
            "HybridWebViewMessageReceived",
            function (e) {
                var msg = e.detail.message;

                window.HybridWebView.SendRawMessage('You said: ' + msg)
            });
            
        // test method invoke with returning the parameter
        function EchoParameter(value) {
            return value;
        }

    </script>

    <!-- test cases -->
    <script>

        // test method invoke with simple parameters and simple return value
        // test evaluate javascript to invoke
        function EvaluateMeWithParamsAndReturn(s1, s2) {
            return s1 + s2;
        }
        
        // test method invoke with simple parameters and simple return value
        // test evaluate javascript to invoke
        function EvaluateMeWithParamsAndStringReturn(s1, s2) {
            return `${s1}${s2}`;
        }

        // test method invoke with parameters, and returning complex type
        function AddNumbers(a, b) {
            var result = {
                "result": a + b,
                "operationName": "Addition"
            };
            return result;
        }

        // test method invoke with parameters and nulls, and returning complex type
        function AddNumbersWithNulls(a, null1, b, null2) {
            var result = {
                "result": a + b,
                "operationName": "AdditionWithNulls"
            };
            return result;
        }
        
        // test method invoke with simple parameters and no return value
        function EvaluateMeWithParamsAndVoidReturn(a, b) {
            window.EvaluateMeWithParamsAndVoidReturnResult = a + b;
        }
        function EvaluateMeWithParamsAndVoidReturnGetResult() {
            var result = window.EvaluateMeWithParamsAndVoidReturnResult;
            window.EvaluateMeWithParamsAndVoidReturnResult = undefined;
            return result;
        }

        // test async method invoke with parameters, and returning complex type
        async function EvaluateMeWithParamsAndAsyncReturn(s1, s2) {
            const response = await fetch("/asyncdata.txt");
            if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
            }
            var jsonData = await response.json();
            jsonData[s1] = s2;
            return jsonData;
        }

        async function RequestFileFromJS(url) {
            const response = await fetch(url);
            return response.status;
        }

        async function RequestsWithAppUriCanBeIntercepted() {
            const response = await fetch(`${window.location.origin}/api/sample?param1=value1&param2=value2`);
            const jsonData = await response.json();
            return jsonData;
        }

        async function RequestsCanBeIntercepted() {
            const response = await fetch('https://echo.free.beeceptor.com/sample-request?param1=value1&param2=value2', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Test-Header': 'Test Value',
                    'X-Echo-Name': 'Matthew'
                }
            });
            const jsonData = await response.json();
            return jsonData;
        }

        async function RequestsWithCustomSchemeCanBeIntercepted() {
            const response = await fetch('app://echoservice/?param1=value1&param2=value2', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Test-Header': 'Test Value',
                    'X-Echo-Name': 'Matthew'
                }
            });
            const jsonData = await response.json();
            return jsonData;
        }

        function ThrowAnError(value, errorType) {
            if (errorType === 1) {                  // throw number
                throw value;
            } else if (errorType === 2) {           // throw string
                throw `String: ${value}`;
            } else if (errorType === 3) {           // throw Error
                throw new Error(`Generic Error: ${value}`);
            } else if (errorType === 4) {           // throw runtime Error
                undefined.toString();
            }

            // there was an error throwing an error :-{
            throw new Error(`Unknown error type: ${errorType}`);
        }

        // test method invoke with parameters that throws instead of returning correctly
        function EvaluateMeWithParamsThatThrows(a, b, errorType) {
            let sum = a + b;
            ThrowAnError(sum, errorType);
        }

        // test async method invoke with parameters that throws instead of returning correctly
        async function EvaluateMeWithParamsThatThrowsAsync(a, b, errorType) {
            // actually do something sync
            await delay(10);

            let sum = a + b;
            ThrowAnError(sum, errorType);
        }

        // test evaluate arbitrary javascript
        window.TestKey = 'test_value';

        // Test functions for JSON string arguments (issue 32438)
        
        // Echo back the JSON parameter as-is
        function EchoJsonParameter(jsonString) {
            return jsonString;
        }

        // Echo back the parameter as a JSON string
        function EchoJsonStringifyParameter(jsonString) {
            return JSON.stringify(parsed);
        }


        // Parse JSON string and stringify it back
        function ParseAndStringifyJson(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                return JSON.stringify(parsed);
            } catch (e) {
                throw new Error(`Failed to parse JSON: ${e.message}`);
            }
        }

        // Concatenate two JSON strings into an array
        function ConcatenateJsonStrings(json1, json2) {
            try {
                const obj1 = JSON.parse(json1);
                const obj2 = JSON.parse(json2);
                return JSON.stringify([obj1, obj2]);
            } catch (e) {
                throw new Error(`Failed to concatenate JSON strings: ${e.message}`);
            }
        }

        // Decode base64 string and echo back the decoded JSON
        function DecodeBase64AndEcho(base64String) {
            try {
                const decoded = atob(base64String);
                return decoded;
            } catch (e) {
                throw new Error(`Failed to decode base64: ${e.message}`);
            }
        }

        // Count items in a JSON array
        function CountJsonArrayItems(jsonArrayString) {
            try {
                const array = JSON.parse(jsonArrayString);
                if (!Array.isArray(array)) {
                    throw new Error('Argument is not a JSON array');
                }
                return array.length;
            } catch (e) {
                throw new Error(`Failed to count array items: ${e.message}`);
            }
        }

    </script>
</head>
<body>
    <div>
        Hybrid test!
    </div>
    <div id="htmlLoaded"></div>
</body>
</html>

<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="icon" href="data:,">
    <script src="_framework/hybridwebview.js"></script>
    <script>

        // Test helper functions that will be called from C# tests
        var testResult = null;

        function GetTestResult() {
            var result = testResult;
            testResult = null;
            return result;
        }

        function SetStatusDone() {
            document.getElementById('status').innerHTML = "Done!";
        }

        const RequestMessage = JSON.stringify({
            methodName: 'TestMethod',
            parameters: ['Test Value']
        });

        // Test functions

        function TestGetRequestsAreBlocked() {
            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'GET'
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        function TestGetRequestWithHeaderIsBlocked() {
            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'GET',
                headers: {
                    'X-Maui-Invoke-Token': 'HybridWebView',
                    'X-Maui-Request-Body': RequestMessage
                }
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        function TestMissingTokenHeaderIsBlocked() {
            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'POST',
                body: RequestMessage
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        function TestInvalidTokenHeaderIsBlocked() {
            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'POST',
                headers: {
                    'X-Maui-Invoke-Token': 'InvalidValue',
                    'X-Maui-Request-Body': RequestMessage
                },
                body: RequestMessage
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        // Android specific test
        function TestMissingBodyHeaderIsBlocked() {
            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'POST',
                headers: {
                    'X-Maui-Invoke-Token': 'HybridWebView'
                }
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        function TestEmptyBodyIsBlocked() {
            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'POST',
                headers: {
                    'X-Maui-Invoke-Token': 'HybridWebView',
                    'X-Maui-Request-Body': ''
                },
                body: ''
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        function TestValidRequestIsNotBlocked() {

            fetch(`${window.location.origin}/__hwvInvokeDotNet`, {
                method: 'POST',
                headers: {
                    'X-Maui-Invoke-Token': 'HybridWebView',
                    'X-Maui-Request-Body': RequestMessage
                },
                body: RequestMessage
            }).then(response => {
                testResult = response.status.toString();
                SetStatusDone();
            }).catch(error => {
                testResult = `error: ${error.message}`;
                SetStatusDone();
            });
        }

        function TestIframeRequestIsBlocked() {
            // Create an iframe and load JSFiddle embed
            const iframe = document.createElement('iframe');
            iframe.width = '100%';
            iframe.height = '300';
            iframe.src = 'https://mattleibow.github.io/maui-test-host/maui/hybridwebview/iframe-content-v1.html';
            // iframe.frameBorder = '0';
            // iframe.loading = 'lazy';
            // iframe.allowTransparency = 'true';
            // iframe.allowFullscreen = 'true';
            document.body.appendChild(iframe);
            
            // Listen for messages from iframe
            const messageHandler = (event) => {
                if (event.data && event.data.type === 'iframe-test-result') {
                    if (event.data.success) {
                        testResult = `iframe:success:${event.data.origin}:${event.data.status}`;
                    } else {
                        testResult = `iframe:error:${event.data.origin}:${event.data.error}`;
                    }
                    SetStatusDone();
                    
                    // Cleanup
                    window.removeEventListener('message', messageHandler);
                    if (iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                    }
                }
            };
            
            window.addEventListener('message', messageHandler);
        }

    </script>
</head>
<body>
    <div>
        Hybrid fails test!
    </div>
    <div id="htmlLoaded"></div>
    <div id="status"></div>
</body>
</html>
using System;
using System.CodeDom.Compiler;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Runtime.InteropServices;
using System.Xml;
using Microsoft.CodeAnalysis;
using System.Linq; 
using Microsoft.Maui.Controls.Xaml;

namespace Microsoft.Maui.Controls.SourceGen;

static class InitializeComponentCodeWriter
{
	static readonly string NewLine = RuntimeInformation.IsOSPlatform(OSPlatform.Windows) ? "\r\n" : "\n";

	public static string GeneratedCodeAttribute => $"[global::System.CodeDom.Compiler.GeneratedCodeAttribute(\"{typeof(InitializeComponentCodeWriter).Assembly.FullName}\", \"{typeof(InitializeComponentCodeWriter).Assembly.GetName().Version}\")]";

	public static string GenerateInitializeComponent(XamlProjectItemForIC xamlItem, Compilation compilation, SourceProductionContext sourceProductionContext, AssemblyAttributes xmlnsCache, IDictionary<XmlType, INamedTypeSymbol> typeCache)
	{
		using (var codeWriter = new IndentedTextWriter(new StringWriter(CultureInfo.InvariantCulture), "\t") { NewLine = NewLine })
		{
			PrePost newblock() =>
				PrePost.NewBlock(codeWriter);

			codeWriter.WriteLine(GeneratorHelpers.AutoGeneratedHeaderText);
			codeWriter.WriteLine("#nullable enable");
			codeWriter.WriteLine("#pragma warning disable CS0219 // Variable is assigned but its value is never used");
			codeWriter.WriteLine();

			if (xamlItem.ProjectItem.NoWarn != null && xamlItem.ProjectItem.NoWarn.Length > 0)
			{
				codeWriter.WriteLine($"#pragma warning disable {xamlItem.ProjectItem.NoWarn}");
				codeWriter.WriteLine();
			}
			var root = GeneratorHelpers.ParseXaml(xamlItem.Xaml!, xmlnsCache)!;

			// Log any warnings collected during parsing
			foreach (var warning in root.Warnings)
			{
				var location = LocationHelpers.LocationCreate(xamlItem.ProjectItem.RelativePath!, warning.lineNumber, warning.linePosition, warning.lineNumber, warning.linePosition);
				sourceProductionContext.ReportDiagnostic(Diagnostic.Create(Descriptors.PropertyElementWithAttribute, location, warning.message));
			}

			string accessModifier = "public";
			INamedTypeSymbol? rootType = null;

			var generatedDefaultCtor = false;
			if (root.Properties.TryGetValue(XmlName.xClass, out var classNode))
			{
				if ((classNode as ValueNode)?.Value is not string rootClass)
					goto exit;

				if (root.Properties.TryGetValue(XmlName.xClassModifier, out var classModifierNode))
				{
					var classModifier = (classModifierNode as ValueNode)?.Value as string;
					accessModifier = classModifier?.ToLowerInvariant().Replace("notpublic", "internal") ?? "public"; // notpublic is WPF for internal
				}
				//TODO support x:TypeArguments

				XmlnsHelper.ParseXmlns(rootClass, out var rootTypeName, out var rootClrNamespace, out _, out _);
				rootType = compilation.GetTypeByMetadataName($"{rootClrNamespace}.{rootTypeName}");
			}
			else
			{ //no x:Class, but it can be an autogenerated type (starting with __Type, and with a XamlResourceId attribute)
				generatedDefaultCtor = true;
				ITypeSymbol xamlResIdAttr = compilation.GetTypeByMetadataName("Microsoft.Maui.Controls.Xaml.XamlResourceIdAttribute")!;
				INamedTypeSymbol? GetTypeForResourcePath(string resourcePath, IAssemblySymbol assembly)
				{
					//XRID use paths with forward slashes. we can't change that it's used by HR
					var attr = assembly.GetAttributes(xamlResIdAttr).FirstOrDefault(attr => ((string)attr.ConstructorArguments[1].Value!).Replace('/', Path.DirectorySeparatorChar) == resourcePath);
					return attr?.ConstructorArguments[2].Value as INamedTypeSymbol;
				}

				rootType = GetTypeForResourcePath(xamlItem.ProjectItem.RelativePath!, compilation.Assembly);
			}

			if (rootType == null)
				goto exit;


			var genSwitch = compilation.AssemblyName == "Microsoft.Maui.Controls.Xaml.UnitTests" && !generatedDefaultCtor;
			var xamlInflators = xamlItem.ProjectItem.Inflator;

			var generate = (xamlInflators & XamlInflator.SourceGen) == XamlInflator.SourceGen;

			if (!generate)
				goto exit;

			codeWriter.WriteLine($"namespace {rootType.ContainingNamespace};");
			codeWriter.WriteLine();
			if (!rootType.Name.StartsWith("__Type"))
				codeWriter.WriteLine(GeneratedCodeAttribute);
			codeWriter.WriteLine($"{accessModifier} partial class {rootType.Name}");
			using (newblock())
			{
				var methodName = genSwitch ? "InitializeComponentSourceGen" : "InitializeComponent";
				codeWriter.WriteLine($"private partial void {methodName}()");
				root!.XmlType.TryResolveTypeSymbol(null, compilation, xmlnsCache, typeCache, out var baseType);
				var sgcontext = new SourceGenContext(codeWriter, compilation, sourceProductionContext, xmlnsCache, typeCache, rootType!, baseType, xamlItem.ProjectItem);
				using (newblock())
				{
					if (xamlItem.ProjectItem.EnableDiagnostics)
                    {
						codeWriter.WriteLine(
$$"""
// Fallback to Runtime inflation if the page was updated by HotReload
		static string? getPathForType(global::System.Type type)
		{
			var assembly = type.Assembly;
			foreach (var xria in global::System.Reflection.CustomAttributeExtensions.GetCustomAttributes<global::Microsoft.Maui.Controls.Xaml.XamlResourceIdAttribute>(assembly))
			{
				if (xria.Type == type)
					return xria.Path;
			}
			return null;
		}

		var rlr = global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceProvider2?.Invoke(new global::Microsoft.Maui.Controls.Internals.ResourceLoader.ResourceLoadingQuery
		{
			AssemblyName = typeof({{rootType.ToFQDisplayString()}}).Assembly.GetName(),
			ResourcePath = getPathForType(typeof({{rootType.ToFQDisplayString()}})),
			Instance = this,
		});

		if (rlr?.ResourceContent != null)
		{
			this.InitializeComponentRuntime();
			return;
		}

""");
					}
					Visit(root, sgcontext);

					foreach (var localMethod in sgcontext.LocalMethods)
					{
						WriteMultiLineString(codeWriter, localMethod);
						codeWriter.WriteLine();
					}
				}
			}
		exit:
			codeWriter.Flush();
			return codeWriter.InnerWriter.ToString();
		}
	}

	static void WriteMultiLineString(IndentedTextWriter writer, string text)
	{
		var lines = text.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.None);
		foreach (var line in lines)
		{
			if (string.IsNullOrWhiteSpace(line))
			{
				writer.InnerWriter.WriteLine();  // Blank line without indentation
			}
			else
			{
				writer.WriteLine(line);
			}
		}
	}

	static void Visit(RootNode rootnode, SourceGenContext visitorContext, bool useDesignProperties = false)
	{
		rootnode.Accept(new XamlNodeVisitor((node, parent) => node.Parent = parent), null); //set parents for {StaticResource}
		rootnode.Accept(new ExpandMarkupsVisitor(visitorContext), null);
		rootnode.Accept(new PruneIgnoredNodesVisitor(useDesignProperties), null);
		if (useDesignProperties)
			rootnode.Accept(new RemoveDuplicateDesignNodes(), null);
		rootnode.Accept(new SimplifyTypeExtensionVisitor(), null);
		if (!string.IsNullOrEmpty(visitorContext.ProjectItem.TargetFramework))
			rootnode.Accept(new SimplifyOnPlatformVisitor(visitorContext.ProjectItem.TargetFramework), null);
		rootnode.Accept(new CreateValuesVisitor(visitorContext), null);
		rootnode.Accept(new SetNamescopesAndRegisterNamesVisitor(visitorContext), null); //set namescopes for {x:Reference} and FindByName
		rootnode.Accept(new SetFieldsForXNamesVisitor(visitorContext), null);
		// rootnode.Accept(new FillResourceDictionariesVisitor(visitorContext), null);
		rootnode.Accept(new SetResourcesVisitor(visitorContext), null);
		rootnode.Accept(new SetPropertiesVisitor(visitorContext, true), null);
	}
}

warning: refname 'stash' is ambiguous.
# PR Review: #28713 - [IOS] Inconsistent Resize Behavior for Header/Footer - fix

**Date:** 2026-01-14 | **Issue:** [#26397](https://github.com/dotnet/maui/issues/26397) | **PR:** [#28713](https://github.com/dotnet/maui/pull/28713)

## ‚úÖ Final Recommendation: APPROVE

PR #28713 correctly fixes issue #26397 by implementing the iOS platform's measure invalidation pattern.

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ COMPLETE |
| üö¶ Gate | ‚úÖ PASSED |
| üîß Fix | ‚úÖ COMPLETE |
| üìã Report | ‚úÖ COMPLETE |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

**Description:**
When the "Resize Header/Footer" menu is tapped in a Shell flyout, the header and footer sizes change but do not remain consistent across multiple taps. The resizing behavior is inconsistent - sizes may vary each time the resize action is triggered.

**Steps to Reproduce:**
1. Run the test app (HeaderFooterShellFlyout sample)
2. Open the Flyout and tap the "Resize Header/Footer" menu
3. Observe that the header and footer resize
4. Tap the "Resize Header/Footer" menu again
5. Tap the "Resize Header/Footer" menu again and observe the size
6. The size differs from the initial size (inconsistent behavior)

**Expected Behavior:**
Header and footer should toggle between small (60) and large (200) consistently on each tap.

**Actual Behavior:**
Header and footer sizes vary and don't maintain consistent toggle behavior.

**Platforms Affected:**
- [x] iOS
- [x] macOS (Mac Catalyst)
- [ ] Android
- [ ] Windows

**Regression:**
Not confirmed - user was not sure about previous versions

**Version with Bug:** 9.0.12 SR1.2

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Compatibility/Handlers/Shell/iOS/ShellFlyoutHeaderContainer.cs` | Fix | +11 -1 |
| `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/XFIssue/HeaderFooterShellFlyout.cs` | Test | +1 -2 |

**Fix Summary:**
- **ShellFlyoutHeaderContainer.cs**: Implements `IPlatformMeasureInvalidationController` interface
  - Adds `InvalidateMeasure()` method that recalculates size using `SizeThatFits` and updates frame
  - Returns `false` to stop propagation after handling resize directly
  - Adds empty `InvalidateAncestorsMeasuresWhenMovedToWindow()` implementation
  
**Test Summary:**
- **HeaderFooterShellFlyout.cs**: Enables iOS tests (changes `#if ANDROID` to `#if ANDROID || IOS`)
- Removes comment about iOS being ignored due to issue #26397 (this PR fixes it)

</details>

<details>
<summary><strong>üí¨ PR Discussion Summary</strong></summary>

**Key Comments:**

1. **PureWeen (Changes Requested)** - Line 102 of ShellFlyoutHeaderContainer.cs:
   - "I think we're moving away from subscribing to measure invalidated subscriptions and using the propagation method that @albyrock87 created"
   - **Author response:** "No problem"
   - **Status:** ‚ö†Ô∏è INVESTIGATE - Review comment refers to OLD approach (subscribing to MeasureInvalidated event)
   - **Note:** Current PR implementation uses the NEW approach (IPlatformMeasureInvalidationController interface) which IS the propagation method

2. **Copilot PR Reviewer (Low Confidence Comments):**
   - Suggested clarifying why iOS is now included in tests (comment update)
   - Flagged potential memory leak in old version with event subscription (no longer relevant - PR doesn't use event subscription)

**Reviewer Feedback:**
- PureWeen requested changes on 2025-03-30: Comment referenced `ShellFlyoutContentRenderer.cs:102` about using "propagation method" instead of MeasureInvalidated subscriptions
- **Author responded on 2025-04-02:** "No problem" (agreed to change approach)
- **IMPORTANT:** The PR diff shows changes to `ShellFlyoutHeaderContainer.cs`, NOT `ShellFlyoutContentRenderer.cs`
- **Conclusion:** Author changed implementation approach AFTER initial review - now using IPlatformMeasureInvalidationController (the propagation method)

**Disagreements to Investigate:**
| File:Line | Reviewer Says | Current PR | Status |
|-----------|---------------|------------|--------|
| ShellFlyoutContentRenderer.cs:102 | Use propagation method instead of MeasureInvalidated | Changed to ShellFlyoutHeaderContainer implementing IPlatformMeasureInvalidationController | ‚úÖ RESOLVED - Author implemented requested change |

**Author Uncertainty:**
- None explicitly stated

**Edge Cases from Discussion:**
- [x] Memory leak concern with event subscriptions - NOT applicable (author removed event subscription approach)
- [x] IPlatformMeasureInvalidationController IS the correct "propagation method" - confirmed by interface definition in Core

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ COMPLETE

- [x] PR includes UI tests (existing tests modified to enable iOS)
- [x] Tests compile successfully
- [x] Tests follow naming convention (uses XFIssue pattern)

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/XFIssue/HeaderFooterShellFlyout.cs` (existing - not modified by PR)
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/XFIssue/HeaderFooterShellFlyout.cs` (modified to enable iOS)

**Test Scenario:**
The existing test creates a Shell flyout with header/footer, then taps "Resize Header/Footer" three times:
1. First tap: Resize from initial to small (60)
2. Second tap: Resize from small to large (200)
3. Third tap: Resize from large back to small (60)

Tests verify that:
- `headerSizeLarge.Height > headerSizeSmall.Height`
- `footerSizeLarge.Height > footerSizeSmall.Height`
- `headerSizeSmall2.Height == headerSizeSmall.Height` (consistent toggle)
- `footerSizeSmall2.Height == footerSizeSmall.Height` (consistent toggle)

**PR Change:** Enables these tests for iOS by changing `#if ANDROID` to `#if ANDROID || IOS`
**Note:** Tests were previously disabled for iOS with comment: "These tests are ignored on iOS and Catalyst because the header height doesn't update correctly. Refer to issue: https://github.com/dotnet/maui/issues/26397"

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚úÖ PASSED

- [x] Tests FAIL without fix (bug reproduced)
- [x] Tests PASS with fix (bug resolved)

**Result:** PASSED ‚úÖ

**Verification Details:**
- **WITHOUT fix**: Tests FAIL (exit code 1) - bug reproduced ‚úÖ
- **WITH fix**: All tests PASS - bug resolved ‚úÖ

**Platform Tested:** iOS (iPhone Xs simulator)
**Test:** HeaderFooterShellFlyout - Resize header/footer test
**Behavior:** Tests verify that header and footer sizes toggle consistently between 60 (small) and 200 (large) on repeated taps

**Logs:** `/Users/kubaflo/Desktop/maui/CustomAgentLogsTmp/UITests/`

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚úÖ COMPLETE

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| PR | PR #28713 | Implement IPlatformMeasureInvalidationController interface - respond to measure invalidation by recalculating size with SizeThatFits and updating frame | ‚úÖ PASS (Gate) | ShellFlyoutHeaderContainer.cs (+12 -1) | Original PR - implements propagation pattern, validated by Gate |

**PR's Approach:**
- Implements `IPlatformMeasureInvalidationController` interface on `ShellFlyoutHeaderContainer`
- `InvalidateMeasure()` recalculates size using `SizeThatFits(new CGSize(Superview.Frame.Width, double.PositiveInfinity))`
- Updates frame with new calculated size: `Frame = new CGRect(Frame.X, Frame.Y, size.Width, size.Height)`
- Returns `false` to stop propagation (resize handled directly)
- Empty implementation for `InvalidateAncestorsMeasuresWhenMovedToWindow()`

**try-fix Analysis:**
- **No try-fix attempts made** - PR's approach is the correct iOS platform pattern
- **Reasoning:** The reviewer (PureWeen) explicitly requested using "the propagation method that @albyrock87 created", which is `IPlatformMeasureInvalidationController`
- **Platform Pattern:** This interface is the standard iOS mechanism for handling measure invalidation (see `src/Core/src/Platform/iOS/IPlatformMeasureInvalidationController.cs`)
- **Alternative approaches would:**
  1. Use event subscriptions (`MeasureInvalidated`) - explicitly rejected by reviewer as deprecated pattern
  2. Manual layout override - would bypass the platform's propagation system
  3. Both violate iOS platform conventions and maintainability guidelines

**Exhausted:** N/A (iOS platform pattern - no alternatives to explore)
**Selected Fix:** PR's fix - Implements the correct iOS platform pattern as requested by reviewer

</details>

---

**Next Step:** Review complete - APPROVE PR #28713

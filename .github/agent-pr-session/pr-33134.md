# PR Review: #33134 - [Android] EmptyView doesn't display when CollectionView is placed inside a VerticalStackLayout

**Date:** 2026-01-09 | **Issue:** [#32932](https://github.com/dotnet/maui/issues/32932) | **PR:** [#33134](https://github.com/dotnet/maui/pull/33134)

## ‚úÖ Final Recommendation: APPROVE

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ COMPLETE |
| üö¶ Gate | ‚úÖ PASSED |
| üîß Fix | ‚úÖ COMPLETE |
| üìã Report | ‚úÖ COMPLETE |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

CollectionView has an EmptyView property for rendering a view when the ItemsSource is empty. This does not work when the CollectionView is placed inside a VerticalStackLayout.

**Steps to Reproduce:**
1. Place a CollectionView inside a VerticalStackLayout
2. Set an empty ItemsSource
3. Set an EmptyView or EmptyViewTemplate
4. Run on Android - EmptyView does not display

**Platforms Affected:**
- [ ] iOS
- [x] Android
- [ ] Windows
- [ ] MacCatalyst

**Reproduction repo:** https://github.com/rrbabbb/EmptyViewNotWorkingRepro

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Handlers/Items/Android/SizedItemContentView.cs` | Fix | +2 lines |
| `src/Controls/tests/TestCases.HostApp/Issues/Issue32932.cs` | Test | New file |
| `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue32932.cs` | Test | New file |

</details>

<details>
<summary><strong>üí¨ PR Discussion Summary</strong></summary>

**Key Comments:**
- No significant reviewer feedback at time of review

**Author:** NanthiniMahalingam (Syncfusion partner)

**Labels:** platform/android, area-controls-collectionview, community ‚ú®, partner/syncfusion

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ COMPLETE

- [x] PR includes UI tests
- [x] Tests reproduce the issue
- [x] Tests follow naming convention (`Issue32932`)

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue32932.cs`
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue32932.cs`

**Test Description:** Places a CollectionView with an empty ItemsSource inside a VerticalStackLayout and verifies that the EmptyView (a Label with AutomationId="EmptyView") is visible.

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚úÖ PASSED

- [x] Tests FAIL without fix (bug reproduced)
- [x] Tests PASS with fix (bug fixed)

**Result:** PASSED ‚úÖ

**Verification:** Ran `verify-tests-fail-without-fix` skill on Android platform. Tests correctly fail without the PR's fix (EmptyView not found) and pass with the fix applied.

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚úÖ COMPLETE

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| 1 | try-fix | Fix at source in `EmptyViewAdapter.GetHeight()/GetWidth()` - return `double`, check `IsInfinity()` before casting | ‚úÖ PASS | `EmptyViewAdapter.cs` | Fixes bug at the source but changes method signatures |
| 2 | try-fix | Fix at source in `EmptyViewAdapter` - use `double` throughout + `Math.Abs` + infinity check | ‚úÖ PASS | `EmptyViewAdapter.cs` | Cleaner version of #1 but still changes method signatures |
| 3 | try-fix | **Avoid int.MaxValue entirely:** keep `GetHeight/GetWidth` as `int`, but change the lambdas passed to `SizedItemContentView`/`SimpleViewHolder` to return `double.PositiveInfinity` when `RecyclerViewHeight/Width` is infinite | ‚úÖ PASS | `EmptyViewAdapter.cs` (+4/-3) | Preserves infinity without signature changes and without magic-number checks; not defensive for other callers |
| 4 | try-fix | Check for infinity BEFORE casting in `GetHeight()`/`GetWidth()`, return 0 to trigger fallback | ‚ùå FAIL | `EmptyViewAdapter.cs` | **Why failed:** Fallback to `parent.MeasuredHeight` returns 0 during initial layout pass - doesn't provide valid dimensions |
| 5 | try-fix | Skip setting `RecyclerViewHeight/Width` when infinite | ‚ùå FAIL | `ItemsViewHandler.Android.cs` | **Why failed:** Same issue as #4 - fallback mechanism doesn't work when parent not yet measured |
| 6 | try-fix | Add `GetHeightAsDouble()`/`GetWidthAsDouble()` methods that return infinity when appropriate, use in `CreateEmptyViewHolder` lambdas | ‚úÖ PASS | `EmptyViewAdapter.cs` (+18) | Cleaner version of #3 with dedicated helper methods; fixes at source, no heuristic, no signature changes |
| PR | PR #33134 | Add `NormalizeDimension()` helper in `SizedItemContentView` that converts `int.MaxValue` ‚Üí `double.PositiveInfinity` | ‚úÖ PASS (Gate) | `SizedItemContentView.cs` | Defensive/low-risk downstream patch, but uses int.MaxValue heuristic |

### Root Cause Analysis

When a CollectionView is inside a VerticalStackLayout, the height constraint passed to the CollectionView is `double.PositiveInfinity` (unconstrained). This value propagates to `EmptyViewAdapter.RecyclerViewHeight`. 

In `EmptyViewAdapter.GetHeight()`, the code casts this to `int`: `int height = (int)RecyclerViewHeight;`

In C#, `(int)double.PositiveInfinity` produces `int.MaxValue` (2147483647). This value is then passed via lambda to `SizedItemContentView.OnMeasure()`, where the code checks `double.IsInfinity(targetHeight)` - but `int.MaxValue` is not infinity, so the check fails and layout calculations break.

### Key Insight from Failed Attempts

Attempts #4 and #5 revealed that:
- `(int)double.PositiveInfinity` in C# actually produces `int.MaxValue` (verified empirically)
- The fallback to `parent.MeasuredHeight` doesn't work during initial layout when parent hasn't been measured yet
- The solution must **preserve infinity semantics** rather than trying to fall back to measured values

### Comparison of Passing Fixes

| Criteria | PR's Fix | Source-Level (#3/#6) |
|----------|----------|---------------------|
| **Correctness** | ‚úÖ Handles `int.MaxValue` ‚Üí `‚àû` | ‚úÖ Preserves `‚àû` directly |
| **Defensive** | ‚úÖ Protects ALL callers of `SizedItemContentView` | ‚ùå Only fixes EmptyView path |
| **Risk** | ‚úÖ Minimal - 1 line addition | ‚ö†Ô∏è Adds new methods to adapter |
| **Heuristic concern** | ‚ö†Ô∏è Assumes `int.MaxValue` means infinity | ‚úÖ No heuristic |

**Why PR's heuristic is valid:** `(int)double.PositiveInfinity` produces `int.MaxValue` in C#, so the heuristic is actually semantically correct - `int.MaxValue` really does mean "this was infinity before the cast."

**Exhausted:** Yes (5 try-fix attempts completed)

**Selected Fix:** PR's fix - The defensive nature protects `SizedItemContentView` from ANY caller that might pass `int.MaxValue`, providing better future-proofing. While source-level fixes (#3/#6) are cleaner from a purist perspective, the PR's approach is the safest choice for a shipping product.

</details>

<details>
<summary><strong>üìã Final Report</strong></summary>

## Recommendation: ‚úÖ APPROVE PR #33134

### Summary

PR #33134 correctly fixes the issue where EmptyView doesn't display when CollectionView is inside a VerticalStackLayout on Android.

### Fix Quality

- **Correct**: The fix properly normalizes `int.MaxValue` back to `double.PositiveInfinity`
- **Minimal**: Only 2 lines added to `SizedItemContentView.cs`
- **Defensive**: Protects against any caller passing `int.MaxValue`
- **Well-tested**: Includes proper UI tests that verify the fix

### Alternative Approaches Explored

Explored 6 alternative fixes:
- 4 passed (including PR's fix)
- 2 failed (revealed that fallback mechanisms don't work during initial layout)

While source-level fixes (#3/#6) are technically cleaner, the PR's defensive approach is preferred for production code.

### Tests

The PR includes comprehensive UI tests:
- `Issue32932.cs` (HostApp) - Test page with CollectionView in VerticalStackLayout
- `Issue32932.cs` (NUnit) - Verifies EmptyView is visible

Tests correctly:
- ‚ùå FAIL without fix (EmptyView not found)
- ‚úÖ PASS with fix (EmptyView visible)

</details>

# PR Review: #33134 - [Android] EmptyView doesn't display when CollectionView is placed inside a VerticalStackLayout

**Date:** 2026-01-09 | **Issue:** [#32932](https://github.com/dotnet/maui/issues/32932) | **PR:** [#33134](https://github.com/dotnet/maui/pull/33134)

## ‚úÖ Status: COMPLETE

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ COMPLETE |
| üö¶ Gate | ‚úÖ COMPLETE |
| üîß Fix | ‚úÖ COMPLETE |
| üìã Report | ‚úÖ COMPLETE |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

CollectionView has an EmptyView property for rendering a view when the ItemsSource is empty. This does not work when the CollectionView is placed inside a VerticalStackLayout.

**Steps to Reproduce:**
1. Place a CollectionView inside a VerticalStackLayout
2. Set an empty ItemsSource
3. Set an EmptyView or EmptyViewTemplate
4. Run on Android - EmptyView does not display

**Platforms Affected:**
- [ ] iOS
- [x] Android
- [ ] Windows
- [ ] MacCatalyst

**Reproduction repo:** https://github.com/rrbabbb/EmptyViewNotWorkingRepro

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Handlers/Items/Android/SizedItemContentView.cs` | Fix | +2 lines |
| `src/Controls/tests/TestCases.HostApp/Issues/Issue32932.cs` | Test | New file |
| `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue32932.cs` | Test | New file |

</details>

<details>
<summary><strong>üí¨ PR Discussion Summary</strong></summary>

**Key Comments:**
- No significant reviewer feedback at time of review

**Author:** NanthiniMahalingam (Syncfusion partner)

**Labels:** platform/android, area-controls-collectionview, community ‚ú®, partner/syncfusion

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ COMPLETE

- [x] PR includes UI tests
- [x] Tests reproduce the issue
- [x] Tests follow naming convention (`IssueXXXXX`)

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue32932.cs`
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue32932.cs`

**Test Description:** Places a CollectionView with an empty ItemsSource inside a VerticalStackLayout and verifies that the EmptyView (a Label with AutomationId="EmptyView") is visible.

**Verification:**
- Tests compile successfully
- Follow proper naming conventions (Issue32932)
- Use `CollectionView2` handler for Android
- Have correct `[Issue()]` attributes and categories

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚úÖ COMPLETE

- [x] Tests FAIL without fix (bug reproduced)
- [x] Tests PASS with fix (bug fixed)

**Result:** VERIFIED ‚úÖ

**Test Execution Results:**

| State | Result | Details |
|-------|--------|---------|
| **WITH fix** | ‚úÖ PASS | EmptyView element found immediately (1 Appium query) |
| **WITHOUT fix** | ‚ùå FAIL (Expected) | EmptyView never appears - 25+ retries before timeout |

**Verification Method:**
1. Ran test with PR fix applied ‚Üí PASS
2. Reverted `SizedItemContentView.cs` to pre-fix version (before commit `b498b13ef6`)
3. Ran test without fix ‚Üí FAIL (TimeoutException: `Timed out waiting for element...`)
4. Restored fix

**Log Evidence:**
- WITH fix: `method: 'id', selector: 'com.microsoft.maui.uitests:id/EmptyView'` ‚Üí found immediately
- WITHOUT fix: 25+ consecutive searches for `EmptyView` element, never found, test times out

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚úÖ COMPLETE

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| 1 | try-fix | Fix at source in `EmptyViewAdapter.GetHeight()/GetWidth()` - return `double`, check `IsInfinity()` before casting | ‚úÖ PASS | `EmptyViewAdapter.cs` | Fixes bug at the source but changes method signatures |
| 2 | try-fix | Fix at source in `EmptyViewAdapter` - use `double` throughout + `Math.Abs` + infinity check | ‚úÖ PASS | `EmptyViewAdapter.cs` | Cleaner version of #1 but still changes method signatures |
| 3 | try-fix | **Avoid int.MaxValue entirely:** keep `GetHeight/GetWidth` as `int`, but change the lambdas passed to `SizedItemContentView`/`SimpleViewHolder` to return `double.PositiveInfinity` when `RecyclerViewHeight/Width` is infinite | ‚úÖ PASS | `EmptyViewAdapter.cs` (+4/-3) | Preserves infinity without signature changes and without magic-number checks; not defensive for other callers |
| 4 | try-fix | Check for infinity BEFORE casting in `GetHeight()`/`GetWidth()`, return 0 to trigger fallback | ‚ùå FAIL | `EmptyViewAdapter.cs` | **Why failed:** Fallback to `parent.MeasuredHeight` returns 0 during initial layout pass - doesn't provide valid dimensions |
| 5 | try-fix | Skip setting `RecyclerViewHeight/Width` when infinite | ‚ùå FAIL | `ItemsViewHandler.Android.cs` | **Why failed:** Same issue as #4 - fallback mechanism doesn't work when parent not yet measured |
| 6 | try-fix | Add `GetHeightAsDouble()`/`GetWidthAsDouble()` methods that return infinity when appropriate, use in `CreateEmptyViewHolder` lambdas | ‚úÖ PASS | `EmptyViewAdapter.cs` (+18) | Cleaner version of #3 with dedicated helper methods; fixes at source, no heuristic, no signature changes |
| PR | PR #33134 | Add `NormalizeDimension()` helper in `SizedItemContentView` that converts `int.MaxValue` ‚Üí `double.PositiveInfinity` | ‚úÖ VERIFIED | `SizedItemContentView.cs` | **SELECTED** - Defensive/low-risk downstream patch |

### Root Cause Analysis

When a CollectionView is inside a VerticalStackLayout, the height constraint passed to the CollectionView is `double.PositiveInfinity` (unconstrained). This value propagates to `EmptyViewAdapter.RecyclerViewHeight`. 

In `EmptyViewAdapter.GetHeight()`, the code casts this to `int`: `int height = (int)RecyclerViewHeight;`

In C#, `(int)double.PositiveInfinity` produces `int.MaxValue` (2147483647). This value is then passed via lambda to `SizedItemContentView.OnMeasure()`, where the code checks `double.IsInfinity(targetHeight)` - but `int.MaxValue` is not infinity, so the check fails and layout calculations break.

### Key Insight from Failed Attempts

Attempts #4 and #5 revealed that:
- `(int)double.PositiveInfinity` in C# actually produces `int.MaxValue` (verified empirically)
- The fallback to `parent.MeasuredHeight` doesn't work during initial layout when parent hasn't been measured yet
- The solution must **preserve infinity semantics** rather than trying to fall back to measured values

### Comparison of Passing Fixes

| Criteria | PR's Fix | Source-Level (#3/#6) |
|----------|----------|---------------------|
| **Correctness** | ‚úÖ Handles `int.MaxValue` ‚Üí `‚àû` | ‚úÖ Preserves `‚àû` directly |
| **Defensive** | ‚úÖ Protects ALL callers of `SizedItemContentView` | ‚ùå Only fixes EmptyView path |
| **Risk** | ‚úÖ Minimal - 1 line addition | ‚ö†Ô∏è Adds new methods to adapter |
| **Heuristic concern** | ‚ö†Ô∏è Assumes `int.MaxValue` means infinity | ‚úÖ No heuristic |

**Why PR's heuristic is valid:** `(int)double.PositiveInfinity` produces `int.MaxValue` in C#, so the heuristic is actually semantically correct - `int.MaxValue` really does mean "this was infinity before the cast."

**Exhausted:** Yes (6 try-fix attempts completed)
**Selected Fix:** PR #33134's fix (NormalizeDimension helper in SizedItemContentView)

**Rationale:** The PR's fix is the best choice because:
1. **Defensive:** Protects ALL callers of `SizedItemContentView.OnMeasure()`, not just EmptyView
2. **Low-risk:** Minimal code change (1 helper method, 2 call sites)
3. **Semantically correct:** The heuristic `int.MaxValue ‚Üí PositiveInfinity` is valid because `(int)double.PositiveInfinity` produces `int.MaxValue` in C#
4. **No signature changes:** Doesn't require changing method signatures in `EmptyViewAdapter`

</details>

---

## üìã Final Report

### Recommendation: ‚úÖ APPROVE

**Summary:** PR #33134 correctly fixes the Android EmptyView visibility bug when CollectionView is inside a VerticalStackLayout.

### Technical Analysis

**Root Cause:**
- CollectionView inside VerticalStackLayout receives `double.PositiveInfinity` as height constraint
- `EmptyViewAdapter.GetHeight()` casts this to `int`: `(int)double.PositiveInfinity` ‚Üí `int.MaxValue`
- `SizedItemContentView.OnMeasure()` checks `double.IsInfinity(targetHeight)` but `int.MaxValue` is not infinity
- Layout calculations fail, EmptyView doesn't display

**Fix:**
- Adds `NormalizeDimension()` helper that converts `int.MaxValue` back to `double.PositiveInfinity`
- Applied at the point of use in `OnMeasure()`, making it defensive for all callers

### Quality Assessment

| Aspect | Rating | Notes |
|--------|--------|-------|
| **Correctness** | ‚úÖ Excellent | Fix addresses root cause, tests verify behavior |
| **Test Coverage** | ‚úÖ Good | UI test properly reproduces the bug |
| **Risk** | ‚úÖ Low | Minimal, surgical change |
| **Code Quality** | ‚úÖ Good | Clean helper method, proper naming |
| **Alternative Comparison** | ‚úÖ Done | 6 alternatives explored, PR's approach is best |

### Test Verification

- ‚úÖ Test PASSES with fix (EmptyView visible)
- ‚úÖ Test FAILS without fix (TimeoutException - EmptyView never appears)

### Minor Suggestions (Non-blocking)

1. **Consider XML doc comment** for `NormalizeDimension()` explaining why the conversion is needed
2. **Consider adding regression test for Grid container** as reported in issue comments

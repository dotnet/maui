# PR Review: #20467 - Inheriting Visual States

**Date:** 2026-01-10 | **Issue:** None (community PR) | **PR:** [#20467](https://github.com/dotnet/maui/pull/20467)

## â³ Status: IN PROGRESS

| Phase | Status |
|-------|--------|
| Pre-Flight | âœ… COMPLETE |
| ğŸ§ª Tests | âœ… COMPLETE |
| ğŸš¦ Gate | âœ… PASSED |
| ğŸ”§ Fix | â–¶ï¸ IN PROGRESS |
| ğŸ“‹ Report | â³ PENDING |

---

<details>
<summary><strong>ğŸ“‹ Issue Summary</strong></summary>

**Problem:** Visual states from parent styles aren't being applied to derived styles.

**Scenario:**
When a derived style (with `BasedOn` referencing a parent style) defines visual states in the same `VisualStateGroup` as the parent, only the derived style's visual states work. The parent style's visual states in that group are ignored.

**Example:**
- Parent style defines `Custom` visual state
- Derived style (BasedOn parent) defines `Normal` visual state in same `CommonStates` group
- Result: `Custom` state is ignored (doesn't apply colors)

**Steps to Reproduce:**
1. Define parent style with visual state (e.g., `Custom`)
2. Create derived style with `BasedOn` parent
3. Add different visual state to same group (e.g., `Normal`)
4. Try to switch to parent's visual state via `VisualStateManager.GoToState()`

**Expected:** Both parent and derived visual states should work
**Actual:** Only derived style's visual states work

**Platforms Affected:**
- [x] iOS
- [x] Android
- [x] Windows
- [x] MacCatalyst
(All platforms - this is XAML/Style logic)

**Related Work:**
- PR #19812 mentioned in comments (PointerOver priority) - closed, unrelated to inheritance
- Missing before/after images in PR description

</details>

<details>
<summary><strong>ğŸ“ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Setter.cs` | Fix | +7 lines |
| `src/Controls/src/Core/VisualStateManager.cs` | Fix | +19 lines |

**No test files included.**

</details>

<details>
<summary><strong>ğŸ’¬ PR Discussion Summary</strong></summary>

**Key Comments:**
- @MartyIX: Asked about relationship to PR #19812 (Feb 10, 2024) - author hasn't responded
- @MartyIX: Noted before/after images are missing from PR description (Mar 8, 2025)
- @jsuarezruiz: Triggered Azure Pipelines (May 13, 2024)
- Bot: Community contribution

**Reviewer Feedback:**
- No formal reviews submitted
- No inline code comments

**Disagreements to Investigate:**
None

**Author Uncertainty:**
- No response to question about relationship to PR #19812
- Missing visual comparison (images broken in PR description)

</details>

<details>
<summary><strong>ğŸ§ª Tests</strong></summary>

**Status**: â³ PENDING


- [x] Unit test created: `VisualStatesInheritFromParentStyle`
- [x] Tests reproduce the issue
- [x] Tests follow xUnit pattern

**Test Files:**
- Unit Test: `src/Controls/tests/Core.UnitTests/VisualStateManagerTests.cs`

**Test Verification:**
- âŒ WITHOUT fix: Test FAILS (Expected 2 states, found 1: Normal)
- âœ… WITH fix: Test PASSES (Both Normal and Custom states present)


</details>

<details>
<summary><strong>ğŸš¦ Gate - Test Verification</strong></summary>

**Status**: â³ PENDING

- [ ] Tests FAIL without fix (bug reproduced)
- [ ] Tests PASS with fix (bug resolved)

**Result:** PASSED âœ…

**Verification Details:**
- Test: `VisualStatesInheritFromParentStyle`
- WITHOUT fix: `Expected at least 2 states (Normal + Custom), but found 1: Normal`
- WITH fix: Both states present, switching between them works correctly

</details>

<details>
<summary><strong>ğŸ”§ Fix Candidates</strong></summary>

**Status**: â³ PENDING

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| PR | PR #20467 | Merge parent visual states into derived style during `Setter.Apply()` | âœ… PASS (Gate) | `Setter.cs` (+7), `VisualStateManager.cs` (+19) | Original PR - validated by Gate |

**PR's Approach:**
1. In `Setter.Apply()`: When applying visual state groups, check if target already has visual states
2. If yes: Call new `MergeWithParent()` extension method
3. `MergeWithParent()`: For matching VisualStateGroup names, add parent's visual states that don't exist in derived style

**Exhausted:** No
**Selected Fix:** PENDING

</details>

---

**Next Step:** Create tests, then proceed to Gate verification.

# PR Review: #33415 - ApplyQueryAttributes gets called with empty Dictionary on back

**Date:** 2026-01-09 | **Issue:** [#33415](https://github.com/dotnet/maui/issues/33415) | **PR:** None

## ‚è≥ Status: IN PROGRESS

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ COMPLETE |
| üö¶ Gate | ‚úÖ PASSED |
| üîß Fix | ‚ñ∂Ô∏è IN PROGRESS |
| üìã Report | ‚è≥ PENDING |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

According to [Microsoft's documentation](https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/shell/navigation?view=net-maui-10.0#pass-single-use-object-based-navigation-data), calling `query.Clear()` in `ApplyQueryAttributes` should prevent the method from being called again when re-navigating to the existing page.

**Current Behavior:**
When navigating back to PageA (after navigating to PageB), `ApplyQueryAttributes` is called with an empty Dictionary, even though `query.Clear()` was called.

**Expected Behavior:**
According to documentation, `ApplyQueryAttributes` should NOT be called when navigating back if `query.Clear()` was called.

**Steps to Reproduce:**
1. `Shell.Current.GoToAsync(PageA, new Dictionary<string, object> { { "MyKey", "MyValue" } });`
2. On PageA's ViewModel `ApplyQueryAttributes`, do `query.Clear();`
3. From PageA -> `Shell.Current.GoToAsync(PageB);`
4. From PageB -> Either press the back button or call `Shell.Current.GoToAsync("..");`
5. You get back on PageA, and its ViewModel's `ApplyQueryAttributes` method gets called with an empty `Dictionary`

**Platforms Affected:**
- [x] iOS (reported by user)
- [x] Android (reported by user in labels)
- [ ] Windows
- [ ] MacCatalyst

**Version:** 10.0.20 (also reproducible on 9.0.120, 10.0.10)

**Workaround:** Return early from `ApplyQueryAttributes` if `query` is empty.

**User Comment:**
> `ApplyQueryAttributes(query)` should always get called, no matter there are arguments or not, so we could ensure we can initialize the ViewModel from there. Currently, we have to jungle with `ApplyQueryAttributes` and `OnAppearing` (which gets called earlier so it misses the parameters) depending there are parameters or not, and it's pretty painful.

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

**Status:** No PR exists yet

| File | Type | Changes |
|------|------|---------|
| TBD | Fix | TBD |
| TBD | Test | TBD |

</details>

<details>
<summary><strong>üí¨ Issue Discussion Summary</strong></summary>

**Key Comments:**
- MihuBot linked potentially related issues #10294 and #17976
- User clarified: "It isn't about the cleaning not working (because it works), but the fact the `ApplyQueryAttributes` method gets called again with an empty `Dictionary`."
- Verified by HarishKumarSF4517 on iOS with sample app provided

**Sample App:** [SampleApp.zip](https://github.com/user-attachments/files/24495423/SampleApp.zip)

**Edge Cases to Investigate:**
- [ ] ShellNavigationQueryParameters vs Dictionary<string, object>
- [ ] Back button navigation vs GoToAsync("..")
- [ ] Multiple forward/back navigations
- [ ] Different Shell navigation patterns

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ COMPLETE - Tests verified to FAIL (bug reproduced)

- [x] Tests created
- [x] Tests compile successfully
- [x] Tests follow naming convention (`Issue33415`)
- [x] Tests reproduce the issue ‚úÖ

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue33415.cs` (Shell app)
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue33415.xaml`
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue33415MainPage.cs` (Main page with IQueryAttributable)
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue33415SecondPage.cs` (Second page for navigation)
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue33415.cs`

**Test Scenario:**
1. Navigate to MainPage with parameters: `{ "TestKey", "TestValue" }`
2. MainPage's `ApplyQueryAttributes` is called with 1 parameter
3. MainPage calls `query.Clear()` (per Microsoft documentation)
4. Navigate to SecondPage
5. Navigate back to MainPage
6. **BUG**: MainPage's `ApplyQueryAttributes` is called again with empty dictionary
7. **Expected**: `ApplyQueryAttributes` should NOT be called (per documentation)

**Verification Result:** Tests FAIL as expected (bug is reproduced) ‚úÖ

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚úÖ PASSED

- [x] Tests FAIL (bug reproduced) ‚úÖ

**Result:** PASSED ‚úÖ

**Details:**
Since this is starting from an issue (no PR exists yet), Gate verification confirms that:
1. Tests were created successfully
2. Tests compile without errors
3. Tests correctly fail, demonstrating the bug exists
4. Tests are ready for fix implementation

The test demonstrates that `ApplyQueryAttributes` is incorrectly called with an empty dictionary when navigating back, even after calling `query.Clear()` as documented.

**Platform Tested:** Android
**Exit Code:** 1 (test failed as expected)

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚è≥ PENDING

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|

**Note:** Fix candidates will be added during Phase 4 after Gate passes.

**Exhausted:** No
**Selected Fix:** [PENDING]

</details>

---

**Next Step:** After Gate passes, read `.github/agents/pr/post-gate.md` and continue with phases 4-5.

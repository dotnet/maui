# PR Review: #33429 - System.InvalidCastException when using QueryPropertyAttribute with nullable types

**Date:** 2026-01-08 | **Issue:** [#33420](https://github.com/dotnet/maui/issues/33420) | **PR:** [#33429](https://github.com/dotnet/maui/pull/33429)

## ‚úÖ Final Recommendation: APPROVE

All phases complete. This PR correctly fixes issue #33420.

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ COMPLETE |
| üö¶ Gate | ‚úÖ PASSED |
| üîß Fix | ‚úÖ COMPLETE |
| üìã Report | ‚úÖ COMPLETE |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

**Description:**
Unable to pass nullable values via QueryPropertyAttribute during Shell navigation. When navigating with a nullable parameter, the app crashes with `System.InvalidCastException`.

**Root Exception:**
```
System.Private.CoreLib.dll!System.Convert.DefaultToType(System.IConvertible value, System.Type targetType, System.IFormatProvider provider)
Microsoft.Maui.Controls.dll!Microsoft.Maui.Controls.ShellContent.ApplyQueryAttributes(object content, Microsoft.Maui.Controls.ShellRouteParameters query, Microsoft.Maui.Controls.ShellRouteParameters oldQuery)
```

**Reproduction Code:**
```csharp
// MainPage.xaml.cs - Navigation code
private async void OnCounterClicked(object? sender, EventArgs e)
{
    Dictionary<string, object?> param = new(1) {
        { nameof(DetailsPage.ID), (long?)1 }
    };
    await Shell.Current.GoToAsync(nameof(DetailsPage), param);
}

// DetailsPage.xaml.cs - Destination with nullable property
[QueryProperty(nameof(ID), nameof(ID))]
public partial class DetailsPage : ContentPage
{
    public long? ID { get; set; }
    public DetailsPage()
    {
        InitializeComponent();
    }
}
```

**Steps to Reproduce:**
1. Clone https://github.com/meyerdominik/MauiTest
2. Launch the app
3. Click the "Click me" button
4. App crashes with System.InvalidCastException

**Platforms Affected:**
- [x] iOS (verified by reporter)
- [x] Android (verified by reporter + Microsoft)
- [x] Windows (verified by reporter + Microsoft)
- [x] MacCatalyst (verified by reporter)

**Versions Affected:**
- 9.0.0, 9.0.120, 10.0.0, 10.0.10, 10.0.20

**Regression:** No, this is something new (not a regression)

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Shell/ShellContent.cs` | Fix | +12/-2 lines |
| `src/Controls/tests/TestCases.HostApp/Issues/Issue33420.xaml` | Test | +10 lines |
| `src/Controls/tests/TestCases.HostApp/Issues/Issue33420.xaml.cs` | Test | +95 lines |
| `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue33420.cs` | Test | +31 lines |

</details>

<details>
<summary><strong>üí¨ PR Discussion Summary</strong></summary>

**Key Comments:**
- LogishaSelvarajSF4525 (Microsoft): Validated issue in VS Code 1.107.1 and VS 18.1.1, reproducible on all platforms (Android, Windows, iOS, MacCatalyst)
- Affects MAUI versions 9.0.0 through 10.0.20

**Reviewer Feedback:**
- PR just created - awaiting team review

**Disagreements to Investigate:**
| File:Line | Reviewer Says | Author Says | Status |
|-----------|---------------|-------------|--------|
| None yet | - | - | - |

**Author Uncertainty:**
- None noted

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ COMPLETE

- [x] Tests created
- [x] Tests reproduce the issue (crash with nullable QueryProperty - timeout waiting for ResultLabel)
- [x] Tests follow naming convention (`Issue33420`)

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue33420.xaml[.cs]`
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue33420.cs`

**Verification Result:** Tests FAIL as expected (bug reproduced) - times out waiting for navigation to complete because app crashes with InvalidCastException when passing nullable long? parameter.

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚ñ∂Ô∏è IN PROGRESS

- [x] Tests FAIL (bug reproduced)

**Result:** ‚úÖ PASSED - Tests correctly reproduce the issue (no fix exists yet, so full verification will happen after fix is implemented)

Since we're starting from an issue (no PR/fix exists yet), Gate confirms that tests were verified to fail in Phase 2. We'll proceed to Phase 4 to implement a fix.

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚úÖ COMPLETE

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| 1 | Direct analysis | Handle nullable types with Nullable.GetUnderlyingType | ‚úÖ PASS | `ShellContent.cs` (+11/-2) | Extracts underlying type for nullable properties, converts to that type, then assigns |

**Details of Fix #1:**
- **Root Cause**: `Convert.ChangeType(value, prop.PropertyType)` fails when `prop.PropertyType` is nullable (e.g., `long?`)
- **Solution**: Use `Nullable.GetUnderlyingType()` to extract the underlying type (e.g., `long` from `long?`), convert to that, then assign
- **Code Change**: Added null check and type unwrapping before conversion
- **Test Result**: Tests pass - navigation with nullable QueryProperty now works correctly

**Exhausted:** N/A (direct fix without try-fix loop - no PR existed to compare against)
**Selected Fix:** #1 - Only candidate, passes all tests

</details>

---

**Next Step:** Create UI tests to reproduce the issue, verify they fail, then proceed to Gate phase.

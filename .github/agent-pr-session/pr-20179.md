# PR Review: #20179 - Android Shell BackButtonBehavior TextOverride

**Date:** 2026-01-08 (Merged Review) | **Issue:** [#19747](https://github.com/dotnet/maui/issues/19747) | **PR:** [#20179](https://github.com/dotnet/maui/pull/20179)

## ‚úÖ Final Recommendation: APPROVE

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ VERIFIED - VerifyScreenshot() catches visual bug |
| üö¶ Gate | ‚úÖ PASSED - Test FAILS without fix, PASSES with fix |
| üîß Fix | ‚úÖ ANALYZED |
| üìã Report | ‚úÖ COMPLETE |

**Latest Commit:** `95d90148cd` - Improve UI test with TestShell pattern and add Android baseline screenshot

---

## üìù Review History

| Reviewer | Date | Contribution |
|----------|------|--------------|
| PR Author Agent | 2026-01-08 | Initial tests, state file, "conditionally passed" Gate |
| @PureWeen Agent | 2026-01-08 | Verified Gate with `VerifyScreenshot()`, added baseline screenshot, improved test pattern |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

Shell BackButtonBehavior `TextOverride` property displays truncated text on Android when the text is too long. Android restricts the size of navigation icons, and MAUI converts text to an image for the navigation icon, but long text gets truncated by Android's size constraints.

**Steps to Reproduce:**
1. Create a Shell app with navigation
2. Add `<Shell.BackButtonBehavior><BackButtonBehavior TextOverride="Cancel" /></Shell.BackButtonBehavior>` to a page
3. Navigate to that page
4. Observe the TextOverride value is truncated (e.g., "Ca..." instead of "Cancel")

**Expected Behavior:** The full text should be visible (shrunk to fit if necessary)

**Platforms Affected:**
- [ ] iOS (iOS doesn't allow long back button text - shows "back" labels)
- [x] Android (Android 12, 13+)
- [ ] Windows
- [ ] MacCatalyst

**Is Regression:** Not confirmed - reported on MAUI 7.0.101

**Reproduction Repo:** https://github.com/DharunAR/ShareFromMobile

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Compatibility/Handlers/Shell/Android/ShellToolbarTracker.cs` | Fix | +9 lines (lines 464, 797-806) |
| `src/Controls/tests/TestCases.HostApp/Issues/Issue19747.cs` | Test | +59 lines |
| `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue19747.cs` | Test | +29 lines |
| `src/Controls/tests/TestCases.Android.Tests/snapshots/android/BackButtonTextOverrideShouldNotBeTruncated.png` | Baseline | Binary |

</details>

<details>
<summary><strong>üí¨ PR Discussion Summary</strong></summary>

**Key Comments:**

**Issue Author (@DharunAR):**
- Reports TextOverride="Cancel" not displaying properly - shows truncated
- Reproduction repo provided: https://github.com/DharunAR/ShareFromMobile
- Requested workaround

**PR Author (@kubaflo):**
- Explains Android restricts navigation icon size, causing truncation
- MAUI converts text to image for navigation icon (hacky workaround)
- Proposes decreasing text size until it fits
- Notes iOS Shell doesn't allow long texts (displays as "back" labels)
- Acknowledges disadvantage: long text = tiny font
- Considers this better than truncated text

**Reviewer Feedback:**
- @jsuarezruiz: Consider text trimming instead of shrinking font
- @jsuarezruiz: Need to decide approach before adding tests
- @jsuarezruiz: Asked @PureWeen for input (no response visible)

**Disagreements to Investigate:**
| File:Line | Reviewer Says | Author Says | Resolution |
|-----------|---------------|-------------|------------|
| ShellToolbarTracker.cs:802 | "Perhaps have more sense to apply text trimming" | "Trimming would show 'C...' or 'Ca...' - only 4-5 letters space available" | ‚úÖ **RESOLVED** - Text shrinking is more practical; trimming would be useless with only 4-5 chars visible |
| ShellToolbarTracker.cs:464 | "Before adding a test, we must decide approach" | - | ‚úÖ **RESOLVED** - Tests now added with VerifyScreenshot() approach |

**Author Uncertainty (addressed):**
- Author acknowledges "long texts will have a tiny font" as disadvantage
- **Recommendation:** Consider adding minimum font size guard (e.g., 8pt) to prevent unreadable text

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ VERIFIED

- [x] PR includes UI tests (created/improved during review)
- [x] Tests reproduce the issue ‚úÖ VERIFIED with VerifyScreenshot()
- [x] Tests follow naming convention (`Issue19747`)
- [x] Tests use proper infrastructure (`TestShell` base class)

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue19747.cs`
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue19747.cs`
- Baseline: `src/Controls/tests/TestCases.Android.Tests/snapshots/android/BackButtonTextOverrideShouldNotBeTruncated.png`

**Test Method:** `BackButtonTextOverrideShouldNotBeTruncated`

**Why VerifyScreenshot() was required:**

This is a **purely visual bug** - the text appears truncated on screen, but:
- The `content-desc` accessibility attribute still contains "Cancel" even when visually truncated
- Appium's semantic queries (like `TapBackArrow("Cancel")`) look for `content-desc` and succeed regardless of visual truncation
- Only `VerifyScreenshot()` captures the actual visual state and detects the difference

**‚úÖ VERIFICATION RESULTS:**

| Scenario | Expected | Actual | Result |
|----------|----------|--------|--------|
| Test WITH fix applied | PASS | PASS ‚úÖ | Screenshot matches baseline - full "Cancel" visible |
| Test WITHOUT fix | FAIL | FAIL ‚úÖ | Screenshot differs - "Canc" truncated |

**Screenshots Captured:**
- WITH fix: Shows "Cancel" fully visible in toolbar (smaller font, fits in width)
- WITHOUT fix: Shows "Canc" (text clipped at icon boundary)

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚úÖ PASSED

**Verification Method:** `VerifyScreenshot()` visual regression testing on Android emulator

| Test Scenario | Expected Behavior | Actual Result |
|---------------|-------------------|---------------|
| WITH PR fix | Screenshot matches baseline (full "Cancel" visible) | ‚úÖ PASSED |
| WITHOUT PR fix | Screenshot differs from baseline (truncated "Canc") | ‚úÖ FAILED as expected |

**Evidence:**
- With fix: Back button shows "Cancel" in smaller font that fits within icon bounds
- Without fix: Back button shows "Canc" - text is clipped at the right edge

**Note on Prior "Conditional" Status:**

The author's initial review marked Gate as "conditionally passed" with manual verification recommended. This was upgraded to fully PASSED after:
1. Running `VerifyScreenshot()` test on Android emulator
2. Capturing baseline screenshot with fix applied
3. Reverting fix and confirming test FAILS (screenshot mismatch)
4. Restoring fix and confirming test PASSES

The test correctly serves as a regression test for this visual bug.

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚úÖ ANALYZED

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| PR | PR #20179 | Shrink text size in while loop until fits in available width | ‚úÖ PASS (Gate) | `ShellToolbarTracker.cs` (+9) | Original PR - validated |

**PR Fix Analysis:**

```csharp
// Location: FlyoutIconDrawerDrawable.Draw() method, lines 797-805
var maxTextWidth = Bounds.Width();
paint.TextSize = _defaultSize;  // typically 50 or from Android TextSize attribute
while (paint.MeasureText(Text) > maxTextWidth)
{
    paint.TextSize -= 1f; // Decrease text size until it fits
}
```

**How it works:**
1. Gets the available width from `Bounds.Width()`
2. Starts with `_defaultSize` (typically 50 or from Android's TextSize attribute)
3. Measures text width using `paint.MeasureText(Text)`
4. Decrements font size by 1.0f until text fits

**Potential Improvement (Optional):**

The PR has no minimum size guard - could shrink to very small unreadable text for very long strings. Consider:

```csharp
const float MinTextSize = 8f;
while (paint.MeasureText(Text) > maxTextWidth && paint.TextSize > MinTextSize)
{
    paint.TextSize -= 1f;
}
```

**Alternative Approaches Discussed:**

| Approach | Pros | Cons | Verdict |
|----------|------|------|---------|
| **Text shrinking** (PR's approach) | Full text always visible | Long text = tiny font | ‚úÖ Selected |
| **Text trimming with ellipsis** | Consistent font size | Only 4-5 chars fit, so "Cancel" ‚Üí "Ca..." - not useful | ‚ùå Rejected |
| **iOS-style "Back" behavior** | Consistent UX | Doesn't respect TextOverride intent | ‚ùå Rejected |

**Exhausted:** Yes
**Selected Fix:** PR #20179 (with optional minimum size guard recommendation)

</details>

---

## üìã Final Report

### Summary

**PR #20179** addresses a visual bug where Shell `BackButtonBehavior.TextOverride` text gets truncated on Android. The fix dynamically shrinks the font size until the text fits within the available toolbar icon width.

### Verdict: ‚úÖ APPROVE

The PR is ready to merge with complete test coverage:

**Tests Added:**
| File | Description |
|------|-------------|
| `src/Controls/tests/TestCases.HostApp/Issues/Issue19747.cs` | Test page using `TestShell` with BackButtonBehavior |
| `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue19747.cs` | NUnit test with `VerifyScreenshot()` |
| `src/Controls/tests/TestCases.Android.Tests/snapshots/android/BackButtonTextOverrideShouldNotBeTruncated.png` | Baseline screenshot |

**Test Verification:**
- ‚úÖ Test PASSES with fix (screenshot shows full "Cancel" text)
- ‚úÖ Test FAILS without fix (screenshot shows truncated "Canc" text)

### Technical Analysis

**Root Cause:** Android restricts navigation icon size. MAUI converts `TextOverride` text to an image drawable (`FlyoutIconDrawerDrawable`), but the drawable is clipped to Android's max icon dimensions (~50x50dp).

**PR's Solution:** Measure text width with `paint.MeasureText()`, shrink font size in a while loop until it fits within `Bounds.Width()`.

**Key Insight:** This is a purely visual bug. Semantic testing (Appium `content-desc` queries) cannot detect it because the accessibility attribute contains the full text even when visually truncated. Only `VerifyScreenshot()` can catch this regression.

### Optional Enhancement

Consider adding a minimum font size guard to prevent unreadable text for very long strings:

```csharp
const float MinTextSize = 8f;
while (paint.MeasureText(Text) > maxTextWidth && paint.TextSize > MinTextSize)
{
    paint.TextSize -= 1f;
}
```

### Design Decision Resolution

@jsuarezruiz suggested text trimming as an alternative. After analysis:
- Text trimming would show "Ca..." or "C..." (only 4-5 characters fit)
- This is less useful than shrinking the text to show the full word
- **Resolution:** Text shrinking is the pragmatic choice for this edge case

### Commits Added

| Commit | Description |
|--------|-------------|
| `d00ba53d48` | Add tests for Shell BackButtonBehavior TextOverride on Android (author) |
| `78f9931279` | Update pr-20179.md (author) |
| `95d90148cd` | Improve UI test with TestShell pattern and add Android baseline screenshot (@PureWeen) |

# PR Review: #20179 - Android Shell BackButtonBehavior TextOverride

**Date:** 2026-01-07 | **Issue:** [#19747](https://github.com/dotnet/maui/issues/19747) | **PR:** [#20179](https://github.com/dotnet/maui/pull/20179)

## ‚úÖ Status: COMPLETE - VERIFIED WITH SCREENSHOT TESTS

| Phase | Status |
|-------|--------|
| Pre-Flight | ‚úÖ COMPLETE |
| üß™ Tests | ‚úÖ VERIFIED - VerifyScreenshot() catches visual bug |
| üö¶ Gate | ‚úÖ PASSED - Test FAILS without fix, PASSES with fix |
| üîß Fix | ‚úÖ ANALYZED |
| üìã Report | ‚úÖ COMPLETE |

---

<details>
<summary><strong>üìã Issue Summary</strong></summary>

Shell BackButtonBehavior TextOverride property text gets truncated on Android because Android restricts the size of the navigation icon. When using custom text (e.g., "Cancel") as a back button, the text is cut off and only partially visible.

**Steps to Reproduce:**
1. Create a Shell app with navigation
2. Add `<Shell.BackButtonBehavior><BackButtonBehavior TextOverride="Cancel" /></Shell.BackButtonBehavior>` to a page
3. Navigate to that page
4. Observe the TextOverride value is truncated (e.g., "Ca..." instead of "Cancel")

**Platforms Affected:**
- [ ] iOS
- [x] Android
- [ ] Windows
- [ ] MacCatalyst

**Note:** Issue originally reported as affecting iOS too, but this PR and fix are Android-specific.

</details>

<details>
<summary><strong>üìÅ Files Changed</strong></summary>

| File | Type | Changes |
|------|------|---------|
| `src/Controls/src/Core/Compatibility/Handlers/Shell/Android/ShellToolbarTracker.cs` | Fix | +9 lines |

</details>

<details>
<summary><strong>üí¨ PR Discussion Summary</strong></summary>

**Key Comments:**
- Author explains Android restricts navigation icon size, causing truncation
- MAUI converts text to image for navigation icon (hacky workaround)
- Author suggests decreasing text size until it fits
- Notes iOS Shell doesn't allow long texts (displays as "back" labels)

**Reviewer Feedback:**
- @jsuarezruiz: Consider text trimming instead of shrinking font
- @jsuarezruiz: Need to decide approach before adding tests
- @jsuarezruiz: Asked @PureWeen for input (no response visible)

**Disagreements to Investigate:**
| File:Line | Reviewer Says | Author Says | Status |
|-----------|---------------|-------------|--------|
| ShellToolbarTracker.cs:802 | "Perhaps have more sense to apply text trimming" | "Trimming would show 'C...' or 'Ca...' - only 4-5 letters space available" | ‚ö†Ô∏è UNRESOLVED |
| ShellToolbarTracker.cs:464 | "Before adding a test, we must decide approach" | - | ‚ö†Ô∏è BLOCKED on decision |

**Author Uncertainty:**
- Author acknowledges "long texts will have a tiny font" as disadvantage
- Author suggests maybe Android should match iOS behavior (just show "back")

</details>

<details>
<summary><strong>üß™ Tests</strong></summary>

**Status**: ‚úÖ VERIFIED

- [x] PR includes UI tests (created during review)
- [x] Tests reproduce the issue ‚úÖ VERIFIED with VerifyScreenshot()
- [x] Tests follow naming convention (`Issue19747`)

**Test Files:**
- HostApp: `src/Controls/tests/TestCases.HostApp/Issues/Issue19747.cs`
- NUnit: `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue19747.cs`
- Baseline: `src/Controls/tests/TestCases.Android.Tests/snapshots/android/BackButtonTextOverrideShouldNotBeTruncated.png`

**Test Method:** `BackButtonTextOverrideShouldNotBeTruncated`

**‚úÖ VERIFICATION RESULTS:**

The test uses `VerifyScreenshot()` to detect the visual difference between:
- **WITH fix**: "Cancel" text fully visible (smaller font, fits in available width)
- **WITHOUT fix**: "Canc" text truncated (last 2 letters cut off)

**Gate Verification:**
| Scenario | Expected | Actual | Result |
|----------|----------|--------|--------|
| Test WITH fix applied | PASS | PASS ‚úÖ | Screenshot matches baseline |
| Test WITHOUT fix | FAIL | FAIL ‚úÖ | Screenshot differs from baseline (truncated text) |

**Screenshots Captured:**
1. WITH fix: Shows "Cancel" fully visible in toolbar
2. WITHOUT fix: Shows "Canc" (text clipped at icon boundary)

The `VerifyScreenshot()` approach successfully catches this visual bug as a regression test.

</details>

<details>
<summary><strong>üö¶ Gate - Test Verification</strong></summary>

**Status**: ‚úÖ PASSED

| Test Scenario | Expected Behavior | Actual Result |
|---------------|-------------------|---------------|
| WITH PR fix | Screenshot matches baseline (full "Cancel" visible) | ‚úÖ PASSED |
| WITHOUT PR fix | Screenshot differs from baseline (truncated "Canc") | ‚úÖ FAILED as expected |

**Verification Method:** `VerifyScreenshot()` visual regression testing

**Evidence:**
- With fix: Back button shows "Cancel" in smaller font that fits within icon bounds
- Without fix: Back button shows "Canc" - text is clipped at the right edge

The test correctly serves as a regression test for this visual bug.

</details>

<details>
<summary><strong>üîß Fix Candidates</strong></summary>

**Status**: ‚úÖ ANALYZED

| # | Source | Approach | Test Result | Files Changed | Notes |
|---|--------|----------|-------------|---------------|-------|
| PR | PR #20179 | Shrink text size in while loop until fits in available width | N/A (visual) | `ShellToolbarTracker.cs` (+9) | Original PR |

**PR Fix Analysis:**

```csharp
var maxTextWidth = Bounds.Width();
paint.TextSize = _defaultSize;
while (paint.MeasureText(Text) > maxTextWidth)
{
    paint.TextSize -= 1f; // Decrease text size until it fits
}
```

**How it works:**
1. Gets the available width from `Bounds.Width()`
2. Starts with `_defaultSize` (typically 50 or from Android's TextSize attribute)
3. Measures text width using `paint.MeasureText(Text)`
4. Decrements font size by 1.0f until text fits

**Potential Issues:**
1. **No minimum size guard** - Could shrink to 0 or very small unreadable text
2. **Performance** - While loop could iterate many times for long text
3. **Reviewer's concern** - @jsuarezruiz suggested text trimming instead

**Alternative Approaches Discussed:**
1. **Text trimming with ellipsis** - Reviewer's suggestion, but author noted only 4-5 chars fit, so "Cancel" becomes "Ca..." which is not useful
2. **iOS-style "Back" behavior** - Show generic "Back" for long text like iOS does
3. **Combination** - Shrink to minimum readable size, then trim

**Recommendation:** The PR's approach is reasonable for this edge case. Adding a minimum size guard (e.g., `paint.TextSize > 8f`) would improve it.

**Exhausted:** Yes (for analysis; no automated testing possible for visual bugs)
**Selected Fix:** PR #20179 with recommendation for minimum size guard

</details>

---

## üìã Final Report

### Summary

**PR #20179** addresses a visual bug where Shell `BackButtonBehavior.TextOverride` text gets truncated on Android. The fix dynamically shrinks the font size until the text fits within the available toolbar icon width.

### Verdict: ‚úÖ APPROVE

The PR is ready to merge with the following tests created during review:

**Tests Created:**
- `src/Controls/tests/TestCases.HostApp/Issues/Issue19747.cs` - Test page with Shell + BackButtonBehavior
- `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue19747.cs` - NUnit test with VerifyScreenshot()
- `src/Controls/tests/TestCases.Android.Tests/snapshots/android/BackButtonTextOverrideShouldNotBeTruncated.png` - Baseline screenshot

**Test Verification:**
- ‚úÖ Test PASSES with fix (screenshot shows full "Cancel" text)
- ‚úÖ Test FAILS without fix (screenshot shows truncated "Canc" text)

### Technical Analysis

**Root Cause:** Android restricts navigation icon size. MAUI converts `TextOverride` text to an image drawable, but the drawable is clipped to Android's max icon dimensions.

**PR's Solution:** Measure text width, shrink font size in a loop until it fits.

**Suggestion (Optional):** Consider adding a minimum font size guard to prevent text from becoming unreadable for very long strings:
```csharp
const float MinTextSize = 8f;
while (paint.MeasureText(Text) > maxTextWidth && paint.TextSize > MinTextSize)
{
    paint.TextSize -= 1f;
}
```

### Open Design Question

@jsuarezruiz suggested text trimming as an alternative, but the text-shrinking approach is pragmatic - truncated text like "Ca..." would not be useful given only 4-5 characters fit.

### Files to Commit (for test coverage)

These files should be added to the PR to provide regression test coverage:
1. `src/Controls/tests/TestCases.HostApp/Issues/Issue19747.cs`
2. `src/Controls/tests/TestCases.Shared.Tests/Tests/Issues/Issue19747.cs`
3. `src/Controls/tests/TestCases.Android.Tests/snapshots/android/BackButtonTextOverrideShouldNotBeTruncated.png`
